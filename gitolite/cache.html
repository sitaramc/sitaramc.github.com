<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>gitolite and the (redis) cache</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style>
      body        { background: #fff; text-color: #000; margin-left:  40px;   font-size:  0.9em;  font-family: arial; }
  
      code        { font-size:    1.1em;  background:  #ddf; text-color: #000; }
      pre         { margin-left:  2em;    background:  #ddf; text-color: #000; }
      pre code    { font-size:    1.1em;  background:  #ddf; text-color: #000; }
  
      td          { vertical-align: top }
  
      .red        { color: red }
      .blue       { color: blue }
      .green      { color: green }
      .gray       { color: gray }
  
      .box        { background-color:#e0e0e0 }
      .bg-red     { background-color:#ffe0e0 }
      .bg-green   { background-color:#e0ffe0 }
      .bg-blue    { background-color:#e0e0ff }
  
      /* couldn't resist the name! */
      .wd40       { width: 40% !important }
  
      .box-l      { float: left;  padding: 0px 0.5em; background-color: #e0e0e0; width:25% }
      .box-r      { float: right; padding: 0px 0.5em; background-color: #e0e0e0; width:25% }
  </style>
  <style>
      h1          { background: #ffb; text-color: #000; margin-left: -30px;   border-top:    5px  solid #ccc; }
      h2          { background: #ffb; text-color: #000; margin-left: -20px;   border-top:    3px  solid #ddd; }
      h3          { background: #ffb; text-color: #000; margin-left: -10px; }
      h4          { background: #ffb; text-color: #000; }
  </style>
</head>
<body>
<p style="text-align:center">
    <a href="master-toc.html">master TOC</a>
|
    <a href="index.html">main page</a>
|
    <a href="gitolite.html">single-page</a>
|
    <a href="index.html#license">license</a>
|
<font color="green"><b>New: <a style="color: green" href="http://www.packtpub.com/gitolite-essentials/book">Gitolite Essentials</a> book</b></font>
</p>
<p style="text-align:center">
<font color="gray">This is for gitolite &quot;g3&quot;; for older (v2.x) documentation click <a href="http://sitaramc.github.com/gitolite/g2/master-toc.html">here</a></font>
</p>
<div id="header">
<h1 class="title">gitolite and the (redis) cache</h1>
</div>
<p>(requires v3.6.1)</p>
<p>Gitolite can optionally use the Redis in-memory key-value database for a little speed boost for really large sites.</p>
<p>If you look in the <a href="perf.html">gitolite performance</a> page, you will see, right at the bottom, that pretty much the only thing in gitolite that <em>may</em> be slow is the <a href="user.html#info">info</a> command. The cache feature fixes that problem :-)</p>
<p>Using Redis as the backend database is actually a bit of overkill; technically this could just as well have been done using a DBM file or SQlite or something like that, but since this is only a <em>cache</em>, an in-memory database works out better. However, Redis does have one real advantage: cache <a href="cache.html#timeout">timeout</a>s!</p>
<p>Support for this feature is limited to verifiable gitolite bugs, if you find any; I can't help you with redis itself.</p>
<h1 id="how"><span class="header-section-number">1</span> how</h1>
<p>To use this feature, just install Redis, then the perl driver &quot;Redis.pm&quot;. Install or upgrade Gitolite to the latest master, then uncomment (or add, if it doesn't exist) the following line in the rc file:</p>
<pre><code>CACHE       =&gt;  'Redis',</code></pre>
<p>If you're <em>adding</em> it, please add it within the %RC hash, but outside the ENABLE list. (If in doubt, add it just after the UMASK entry).</p>
<p>Then perform some gitolite operation (anything that requires any form of access checking). Redis should start automatically and the right things should happen; see below if it does not.</p>
<h1 id="troubleshooting"><span class="header-section-number">2</span> troubleshooting</h1>
<p>If you ever kill the redis-server be sure to also remove the socket file <code>~/.redis-gitolite.sock</code>. Conversely if you ever remove the sock file be sure to kill the process also. Otherwise you get weird behaviour, including possible hangs. (If things don't seem to work, the first thing to do is to kill all 'redis-server's on that userid and remove <code>~/.redis-gitolite.*</code>, then try again.)</p>
<p><strong>Note</strong>: To the best of my knowledge, this cannot result in wrong data being passed to gitolite, causing a security breach. If anyone has time I'd appreciate a review of the code.</p>
<h1 id="details"><span class="header-section-number">3</span> details</h1>
<h2 id="what-is-cached"><span class="header-section-number">3.1</span> what is cached</h2>
<p>At present, gitolite caches only one specific function: the &quot;access()&quot; function. This is available from the shell as the 'gitolite access ...' command, as well as from perl via the &quot;Easy.pm&quot; interface; see <a href="dev-notes.html">dev-notes</a> for more. It is easily the &quot;workhorse&quot; of gitolite.</p>
<p>The cache is flushed completely when the gitolite.conf file is &quot;compiled&quot;. You might see some things running a bit slower -- at least until things settle down.</p>
<p>Finally, if you run 'perms', the cache entries <em>for that specific repo</em> are also flushed.</p>
<h2 id="timeout"><span class="header-section-number">3.2</span> how long is it cached</h2>
<p>Redis has a timeout feature that can delete entries after a certain period of time has elapsed since they were created or updated. Gitolite sets a timeout of 90000 seconds (just over a day) normally. However, if you're using the GROUPLIST_PGM feature (see <a href="auth.html#ldap">here</a> for details), then this timeout becomes 900 seconds (only 15 minutes). This is because a user's group membership, and thus her access rights, can change without gitolite being aware of the change.</p>
<p>If you're not using the GROUPLIST_PGM feature, you don't have to do anything. But if you are using it, then a cache timeout of 15 minutes may be too much or too little for you -- I cannot judge that. You can tell gitolite what timeout you want for your setup, by adding (or uncommenting) an RC variable called CACHE_TTL; its value is the number of seconds for the timeout.</p>
</body>
</html>
