<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>gitolite triggers</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style>
      body        { background: #fff; text-color: #000; margin-left:  40px;   font-size:  0.9em;  font-family: arial; }
  
      code        { font-size:    1.1em;  background:  #ddf; text-color: #000; }
      pre         { margin-left:  2em;    background:  #ddf; text-color: #000; }
      pre code    { font-size:    1.1em;  background:  #ddf; text-color: #000; }
  
      td          { vertical-align: top }
  
      .red        { color: red }
      .blue       { color: blue }
      .green      { color: green }
      .gray       { color: gray }
      .pink       { color: pink }
  
      .box        { background-color:#e0e0e0 }
      .bg-red     { background-color:#ffe0e0 }
      .bg-green   { background-color:#e0ffe0 }
      .bg-blue    { background-color:#e0e0ff }
  
      /* couldn't resist the name! */
      .wd40       { width: 40% !important }
  
      .box-l      { float: left;  padding: 0px 0.5em; background-color: #e0e0e0; width:25%; margin-right: 4px; }
      .box-r      { float: right; padding: 0px 0.5em; background-color: #e0e0e0; width:25%; margin-left:  4px; }
  
      .fl-l       { float: left;  padding: 0px 0.5em;                                       margin-right: 4px; }
      .fl-r       { float: right; padding: 0px 0.5em;                                       margin-left:  4px; }
  
      .sidebar {
          margin-left: 4px;
          width: 25%;
          float: right;
          border: 4px solid #fff;
      }
  
  </style>
  <style>
      h1          { background: #ffb; text-color: #000; margin-left: -30px;   border-top:    5px  solid #ccc; }
      h2          { background: #ffb; text-color: #000; margin-left: -20px;   border-top:    3px  solid #ddd; }
      h3          { background: #ffb; text-color: #000; margin-left: -10px; }
      h4          { background: #ffb; text-color: #000; }
  </style>
</head>
<body>
<!--
    generated by gvim then munged a fair bit.  The following command
        vim -E -c "TOhtml" -c "w" -c 'qa!' \-\- conf/gitolite.conf
    may or may not produce the same thing
-->

<style type="text/css">
<!--
.WarningMsg { color: #ff0000; }
.Constant { color: #ffa0a0; }
.Statement { color: #ffff60; font-weight: bold; }
.PreProc { color: #ff80ff; }
.LineNr { color: #ffff00; }
.Comment { color: #80a0ff; }
.Type { color: #60ff60; font-weight: bold; }
.Special { color: #ffa500; }
.Identifier { color: #40ffff; }
.Error { color: #ffffff; background-color: #ff0000; padding-bottom: 1px; }
.Todo { color: #0000ff; background-color: #ffff00; padding-bottom: 1px; }
-->
</style>
<div id="header">
<h1 class="title">gitolite triggers</h1>
</div>
<div id="TOC">
<ul>
<li><a href="#types-of-trigger-programs"><span class="toc-section-number">1</span> types of trigger programs</a></li>
<li><a href="#manually-firing-triggers"><span class="toc-section-number">2</span> manually firing triggers</a></li>
<li><a href="#common-arguments"><span class="toc-section-number">3</span> common arguments</a></li>
<li><a href="#trigger-specific-arguments-and-other-details"><span class="toc-section-number">4</span> trigger-specific arguments and other details</a></li>
<li><a href="#addtrig"><span class="toc-section-number">5</span> adding your own scripts to a trigger</a><ul>
<li><a href="#displaying-the-resulting-trigger-list"><span class="toc-section-number">5.1</span> displaying the resulting trigger list</a></li>
</ul></li>
<li><a href="#tips-and-examples"><span class="toc-section-number">6</span> tips and examples</a></li>
</ul>
</div>
<script type="text/javascript">
<!--
    function hide_show(id) {
        var e = document.getElementById(id);
        if(e == null)
            return;
        if(e.style.display != 'none')
            e.style.display = 'none';
        else
            e.style.display = 'block';
    }

    window.onload = function() {
        var t = document.getElementById('TOC');
        var sbt = document.getElementById('SBTOC');
        var h = '<div id="PTOC">'
        var h2 = '<p><strong><span class="red">Page TOC</span></strong></p>'
        var h3 = '</div>'
        var h4 = '<div id="GTOC">'
        var h5 = '</div>'
        var hst = '<div style="background: white; color: green; border: 2px solid green"><center><font size=-1><strong>Hide/Show Table of Contents</strong><br />'
        var pd = '<a href="#" onclick="hide_show(\'PTOC\');">Page TOC</a> | '
        var gt = '<a href="#" onclick="hide_show(\'GTOC\');">Gitolite TOC</a></font></center></div>'

        if(t == null)
            sbt.innerHTML = hst + gt + h4 + sbt.innerHTML + h5;
        else {
            sbt.innerHTML = hst + pd + gt + h + h2 + t.innerHTML + h3 + h4 + sbt.innerHTML + h5;
            t.style.display = 'none';   // hide the TOC that pandoc placed
        }
    }
-->
</script>

<style>
    #PTOC ul {
        list-style: none;
        margin-left: 0;
        padding-left: 2em;
        text-indent: -2em;
        padding-bottom: 2em;
    }
    #PTOC ul li {
        padding-bottom: 10px;
    }
    #PTOC ul li ul {
        padding-bottom: 0px;
    }
    #PTOC ul li ul li {
        padding-bottom: 0px;
    }

    .sidebar-toc a:hover {
        background-color: white;
    }

    .sidebar-toc {
        margin-left: 4px;
        width: 25%;
        float: right;
        color: gray;
        background: lightgray;
        border: 4px solid #fff;
        font-size: 0.90em;
    }

    .sidebar-toc ul {
        padding-left: 2em;
    }

</style>

<div id="SBTOC" class="sidebar-toc">

<p><strong><span class="red">Gitolite TOC</span></strong></p>
<hr />
<center>
<span class="red"><strong>Background</strong></span>
</center>

<hr />
<p><a href="index.html">Main page</a></p>
<ul>
<li><a href="index.html#dl">download</a></li>
<li><a href="index.html#rtfm">documentation</a>
<ul>
<li><a href="gitolite.html"><strong>all-in-one</strong></a> page</li>
</ul></li>
<li><a href="index.html#trouble"><strong>troubleshooting</strong></a></li>
<li><a href="index.html#contact"><strong>contact and support</strong></a></li>
<li><a href="index.html#license">license</a></li>
</ul>
<p><a href="overview.html">Overview</a></p>
<ul>
<li>what is Gitolite?</li>
<li>why might you need it?</li>
<li>how does it work?</li>
<li>who uses it?</li>
</ul>
<p><a href="concepts.html">Concepts, conventions, and terminology</a></p>
<ul>
<li>authentication and authorisation</li>
<li>ssh mode and http mode</li>
<li>the &quot;hosting user&quot;</li>
<li>the &quot;logical repo name&quot;</li>
<li>the special gitolite-admin repo</li>
</ul>
<p><a href="req.html">Before you start...</a></p>
<ul>
<li>your skills</li>
<li>your server</li>
<li>your and your users' clients</li>
<li><strong>cautions and caveats</strong></li>
<li><a href="req.html#trying">trying</a> out gitolite safely</li>
</ul>
<hr />
<center>
<span class="red"><strong>Basics</strong></span>
</center>

<hr />
<p><a href="install.html">install and setup</a></p>
<ul>
<li><a href="install.html#qi">quick install+setup</a> (for experts)</li>
<li>the long way around</li>
<li><a href="install.html#upgrading">upgrading</a></li>
<li><a href="install.html#moving">moving servers</a></li>
</ul>
<p><a href="basic-admin.html">Basic Administration</a></p>
<ul>
<li>clone the gitolite-admin repo</li>
<li>add/remove users</li>
<li>add/remove/rename repos</li>
<li>bringing existing repos into gitolite</li>
</ul>
<p><a href="conf.html">The conf file (<code>conf/gitolite.conf</code>)</a></p>
<ul>
<li>basic <a href="conf.html#syntax">syntax</a></li>
<li><a href="conf.html#include">include</a> files</li>
<li><a href="conf.html#groups">group definitions</a></li>
<li><a href="conf.html#rules"><strong><span class="red">access rules</span></strong></a></li>
</ul>
<p><a href="rc.html">the rc file (<code>~/.gitolite.rc</code>)</a></p>
<p><a href="user.html">Your users' view</a> of gitolite</p>
<p>Troubleshooting</p>
<ul>
<li>help for <a href="emergencies.html">emergencies</a></li>
<li>the <a href="ips.html">fool-proof install guide</a></li>
<li>the gitolite &quot;<a href="cookbook.html">cookbook</a>&quot;</li>
</ul>
<hr />
<center>
<span class="red"><strong>Advanced</strong></span>
</center>

<hr />
<p>Advanced &quot;conf file&quot; use</p>
<ul>
<li>specifying <a href="git-config.html">git-config</a> keys and values</li>
<li>gitolite <a href="options.html">options</a></li>
<li><a href="wild.html"><strong>wild repos</strong></a> (user created repos)</li>
<li><a href="vref.html">virtual refs</a></li>
<li><a href="deleg.html">delegation</a> of admin duties</li>
<li><a href="gitweb-daemon.html">gitweb and git-daemon</a></li>
</ul>
<p>Special features/setups</p>
<ul>
<li><strong><a href="mirroring.html">mirroring</a></strong></li>
<li><a href="http.html">http</a> mode</li>
<li>using a <a href="cache.html">cache</a></li>
<li>(<a href="namespaces.html">namespaces</a>)</li>
<li><a href="locking.html">locking</a> binary files</li>
<li><a href="package.html">packaging</a> gitolite</li>
</ul>
<p>Customising gitolite</p>
<ul>
<li>core and <a href="non-core.html">non-core</a> gitolite</li>
<li><a href="dev-notes.html">writing your own</a> non-core programs</li>
<li>gitolite <a href="triggers.html">triggers</a></li>
<li><a href="list-non-core.html">list of non-core programs</a> shipped with gitolite</li>
</ul>
<hr />
<center>
<span class="red"><strong>Extras</strong></span>
</center>

<hr />
<p><a href="odds-and-ends.html">Odds and Ends</a></p>
<ul>
<li><a href="odds-and-ends.html#writable">disabling pushes</a> to take backups</li>
<li><a href="odds-and-ends.html#elsewhere">putting 'repositories' and '.gitolite' elsewhere</a></li>
<li><a href="odds-and-ends.html#keysonly">using pubkeys obtained from elsewhere</a></li>
<li><a href="odds-and-ends.html#gh">giving users their own repos</a></li>
<li><a href="odds-and-ends.html#server-side-admin">administering gitolite directly on the server</a></li>
</ul>
<p>Additional information/discussion</p>
<ul>
<li><a href="ssh.html">all about ssh and gitolite</a></li>
<li>Running the <a href="testing.html">test suite</a></li>
<li><a href="files.html">gitolite files and directories</a></li>
<li><a href="perf.html">gitolite performance</a></li>
<li><a href="migr.html">Migration</a></li>
<li><a href="http://sitaramc.github.com/gitolite/g2/master-toc.html">documentation for gitolite v2</a></li>
<li><a href="regex.html">regular expressions</a></li>
<li><a href="no-way.html">no way!</a></li>
</ul>
<hr />
<center>
<span class="red"><strong>Contributed docs</strong></span>
</center>

<hr />
<p>Contributed software, tools, and documentation</p>
<ul>
<li><a href="ssh-and-http.html">combining ssh and http mode</a></li>
<li><a href="putty.html">putty and msysgit</a></li>
<li><a href="sskm.html">changing keys -- self service key management</a></li>
<li><a href="ukm.html">user key management</a></li>
<li><a href="README-emacs.html">emacs</a> &quot;major mode&quot;</li>
</ul>
</div>

<p>Gitolite runs trigger code at several different times. The features you enable in the <a href="rc.html">rc</a> file determine what commands to run (or functions in perl modules to call) at each trigger point. Example of trigger points are &quot;INPUT&quot;, &quot;PRE_GIT&quot;, &quot;POST_COMPILE&quot;, etc.; the full list is examined later in this page.</p>
<p><span class="gray">Quick tip: triggers are to gitolite what hooks are to git; we simply use a different name to avoid constantly having to clarify which hooks we mean! The other difference in gitolite is that each trigger runs multiple pieces of code, not just one program with the same name as the hook, like git does.)</span></p>
<h1 id="types-of-trigger-programs"><span class="header-section-number">1</span> types of trigger programs</h1>
<p>There are two types of trigger programs. Standalone scripts are placed in triggers or its subdirectories. Such scripts are quick and easy to write in any language of your choice.</p>
<p>Triggers written as perl modules are placed in lib/Gitolite/Triggers. Perl modules have to follow some conventions (see some of the shipped modules for ideas) but the advantage is that they can set environment variables and change the argument list of the gitolite-shell program that invokes them.</p>
<p>If you intend to write your own triggers, it's a good idea to examine a default install of gitolite, paying attention to:</p>
<ul>
<li>the path names in various trigger lists in the rc file,</li>
<li>corresponding path names in the src/ directory in gitolite source, and</li>
<li>and for perl modules, the package names and function names within.</li>
</ul>
<h1 id="manually-firing-triggers"><span class="header-section-number">2</span> manually firing triggers</h1>
<p>It's easy to manually fire triggers from the server command line. For example:</p>
<pre><code>gitolite trigger POST_COMPILE</code></pre>
<p>However if the triggered code depends on arguments (see next section) this won't work. (The <code>POST_COMPILE</code> trigger programs all just happen to not require any arguments, so it works).</p>
<h1 id="common-arguments"><span class="header-section-number">3</span> common arguments</h1>
<p>Triggers receive the following arguments:</p>
<ol style="list-style-type: decimal">
<li><p>Any arguments mentioned in the rc file (for an example, see the renice command).</p></li>
<li><p>The name of the trigger as a string (example, <code>&quot;POST_COMPILE&quot;</code>), so you can call the same program from multiple triggers and it can know where it was called from.</p></li>
<li><p>And finally, zero or more arguments specific to the trigger, as given in the next section.</p></li>
</ol>
<h1 id="trigger-specific-arguments-and-other-details"><span class="header-section-number">4</span> trigger-specific arguments and other details</h1>
<p>Here are the <strong>rest of</strong> the arguments for each trigger, plus a brief description of when the trigger runs. (Note that when the repo name is passed in as an argument, it is without the '.git' suffix).</p>
<ul>
<li><p><code>INPUT</code> runs before pretty much anything else. INPUT trigger scripts <em>must</em> be in perl, since they manipulate the arguments and the environment of the 'gitolite-shell' program itself. Most commonly they will read/change <code>@ARGV</code>, and/or <code>$ENV{SSH_ORIGINAL_COMMAND}</code>.</p>
<p>There are certain conventions to adhere to; please see some of the shipped samples or ask me if you need help writing your own.</p></li>
<li><code>ACCESS_1</code> runs after the first access check. Extra arguments:
<ul>
<li>repo</li>
<li>user</li>
<li>'R' or 'W'</li>
<li>'any'</li>
<li>result (see notes below)</li>
</ul>
<p>'result' is the return value of the access() function. If it contains the uppercase word &quot;DENIED&quot;, the access was rejected. Otherwise it is the refex that caused the access to succeed.</p>
<p><em>Please note that if access is rejected, gitolite-shell will die as soon as it returns from the trigger</em>.</p></li>
<li><code>ACCESS_2</code> runs after the second access check, which is invoked by the update hook to check the ref. Extra arguments:
<ul>
<li>repo</li>
<li>user</li>
<li>any of W, +, C, D, WM, +M, CM, DM</li>
<li>the ref being updated (e.g., 'refs/heads/master')</li>
<li>result</li>
<li>old SHA</li>
<li>new SHA</li>
</ul>
<p><code>ACCESS_2</code> also runs on each <a href="vref.html">VREF</a> that gets checked. In this case the &quot;ref&quot; argument will start with &quot;VREF/&quot;, and the last two arguments won't be passed.</p>
<p>'result' is similar to <code>ACCESS_1</code>, except that it is the <em>update hook</em> which dies as soon as access is rejected for the ref or any of the VREFs. Control then returns to git, and then to gitolite-shell, so the <code>POST_GIT</code> trigger <em>will</em> run.</p></li>
<li><code>PRE_GIT</code> and <code>POST_GIT</code> run just before and after the git command. Extra arguments:
<ul>
<li>repo</li>
<li>user</li>
<li>'R' or 'W'</li>
<li>'any'</li>
<li>the git command ('git-receive-pack', 'git-upload-pack', or 'git-upload-archive') being invoked.</li>
</ul>
<p><strong>NOTE</strong> that the <code>POST_GIT</code> trigger has no way of knowing if the push succeeded, because 'git-shell' (or maybe 'git-receive-pack', I don't know) exits cleanly even if the update hook died.</p></li>
<li><p><code>PRE_CREATE</code> and <code>POST_CREATE</code> run just before and after a new repo is created. In addition, any command that creates a repo (like 'fork') or potentially changes permissions (like 'perms') may choose to run <code>POST_CREATE</code>.</p>
Extra arguments for normal repo creation (i.e., by adding a &quot;repo foo&quot; line to the conf file):
<ul>
<li>repo</li>
</ul>
Extra arguments for wild repo creation:
<ul>
<li>repo</li>
<li>user</li>
<li>invoking operation
<ul>
<li>'R' for fetch/clone/ls-remote, 'W' for push</li>
<li>can also be anything set by the command running the trigger (e.g., see the perms and fork commands). This lets the trigger code know how it was invoked.</li>
</ul></li>
</ul></li>
<li><p><code>POST_COMPILE</code> runs after an admin push has successfully &quot;compiled&quot; the config file. By default, the next thing is to update the ssh authkeys file, then all the 'git-config's, gitweb access, and daemon access.</p>
<p>No extra arguments.</p></li>
</ul>
<h1 id="addtrig"><span class="header-section-number">5</span> adding your own scripts to a trigger</h1>
<p><span class="box-r">Note: for gitolite v3.3 or less, adding your own scripts to a trigger list was simply a matter of finding the trigger name in the rc file and adding an entry to it. Even for gitolite v3.4 or higher, if your rc file was created before v3.4, <em>it will continue to work, and you can continue to add triggers to it the same way as before</em>.</span></p>
<p>The rc file (from v3.4 on) does not have trigger lists; it has a simple list of &quot;features&quot; within a list called &quot;ENABLE&quot; in the rc file. Simply comment out or uncomment appropriate entries, and gitolite will <em>internally</em> create the trigger lists correctly.</p>
<p>This is fine for triggers that are shipped with gitolite, but does present a problem when you want to add your own.</p>
<p>Here's how to do that: Let's say you wrote yourself a trigger script called 'foo', to be invoked from the <code>POST_CREATE</code> trigger list. To do that, just add the following to the <a href="rc.html">rc</a> file, just before the ENABLE section:</p>
<pre><code>POST_CREATE                 =&gt;
    [
        'foo'
    ],</code></pre>
<p>Since the ENABLE list pulls in the rest of the trigger entries, this will be <em>effectively</em> as if you had done this in a v3.3 rc file:</p>
<pre><code>POST_CREATE                 =&gt;
    [
        'foo',
        'post-compile/update-git-configs',
        'post-compile/update-gitweb-access-list',
        'post-compile/update-git-daemon-access-list',
    ],</code></pre>
<p>As you can see, the 'foo' gets added to the top of the list.</p>
<h2 id="displaying-the-resulting-trigger-list"><span class="header-section-number">5.1</span> displaying the resulting trigger list</h2>
<p>You can use the 'gitolite query-rc' command to see what the trigger list actually looks like. For example:</p>
<pre><code>gitolite query-rc POST_CREATE</code></pre>
<h1 id="tips-and-examples"><span class="header-section-number">6</span> tips and examples</h1>
<ol style="list-style-type: decimal">
<li><p>If you have code that latches onto more than one trigger, collecting data (such as for logging), then the outputs may be intermixed. You can record the value of the environment variable <code>GL_TID</code> to tie together related entries.</p>
<p>The documentation on the <a href="dev-notes.html#lff">log file format</a> has more on this.</p></li>
<li><p>If you look at CpuTime.pm, you'll see that it's <code>input()</code> function doesn't set or change anything, but does set a package variable to record the start time. Later, when the same module's <code>post_git()</code> function is invoked, it uses this variable to determine elapsed time.</p>
<p><em>(This is a very nice and simple example of how you can implement features by latching onto multiple events and sharing data to do something)</em>.</p></li>
<li><p>You can even change the reponame the user sees, behind his back. Alias.pm handles that.</p></li>
<li><p>Finally, as an exercise for the reader, consider how you would create a brand new env var that contains the <em>comment</em> field of the ssh pubkey that was used to gain access, using the information <a href="sts.html#kfn">here</a>.</p></li>
</ol>
</body>
</html>
