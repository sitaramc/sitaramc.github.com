<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style>
      body        { background: #fff; text-color: #000; margin-left:  40px;   font-size:  0.9em;  font-family: sans-serif; max-width: 800px; }
      h1          { background: #ffb; text-color: #000; margin-left: -30px;   border-top:    5px  solid #ccc; }
      h2          { background: #ffb; text-color: #000; margin-left: -20px;   border-top:    3px  solid #ddd; }
      h3          { background: #ffb; text-color: #000; margin-left: -10px; }
      h4          { background: #ffb; text-color: #000; }
      code        { font-size:    1.1em;  background:  #ddf; text-color: #000; }
      pre         { margin-left:  2em;    background:  #ddf; text-color: #000; }
      pre code    { font-size:    1.1em;  background:  #ddf; text-color: #000; }
  </style>
</head>
<body>
<p style="text-align:center">
    <a href="master-toc.html">master TOC</a>
|
    <a href="index.html">main page</a>
|
    <a href="gitolite.html">single-page</a>
|
    <a href="index.html#license">license</a>
</p>
<p style="text-align:center">
<font color="gray">This is for gitolite &quot;g3&quot;; for older (v2.x) documentation click <a href="http://sitaramc.github.com/gitolite/g2/master-toc.html">here</a></font>
</p>
<!-- master mode -->

<!--
NOTE: ips, locking, progit, sskm, plus any mkds that belong to specific
branches (cache, namespaces) are left out.
-->

<p>This contains <strong>all</strong> of gitolite's documentation in one page. Useful for people who'd rather Ctrl-F around than click around :-)</p>
<p>The page is loosely divided into the following sections:</p>
<ol style="list-style-type: decimal">
<li><a href="#s1">introduction, quick links, basics, and emergency help</a></li>
<li><a href="#s2">detailed install/setup and access rules</a></li>
<li><a href="#s3">git-config, gitolite options, gitweb/daemon, and the rc file</a></li>
<li><a href="#s4">wildcard repos, mirroring, and some other special features</a></li>
<li><a href="#s5">smart http mode</a></li>
<li><a href="#s6">customising gitolite with your own code</a></li>
<li><a href="#s7">all things ssh</a></li>
<li><a href="#s8">various odds and ends like how/why/who, regexes, and performance</a></li>
<li><a href="#s9">everything to do with migration from v2</a></li>
</ol>
<p>Please note that this is only the latest entry point to the documentation. Others are:</p>
<ul>
<li>the main page -- see link at the top</li>
<li>the &quot;master table of contents&quot; -- see link at the top</li>
<li>the graphical overviews: <a href="basic.html">basic</a> and <a href="advanced.html">advanced</a></li>
</ul>
<p>Enjoy!</p>
<hr />
<h1 id="s1"><span class="header-section-number">1</span> basics, quick links, and help</h1>
<h2 id="index"><span class="header-section-number">1.1</span> Hosting git repositories</h2>
<p>Gitolite allows you to setup git hosting on a central server, with fine-grained access control and many more powerful features.</p>
<p>Here's more on <a href="#what">what</a> it is, <a href="#how">how</a> it works, <a href="#why">why</a> you might need it, and <a href="#who">who</a> else is using it.</p>
<p>You may also want to look at these graphical overviews of the documentation: <a href="basic.html">basic</a> and <a href="advanced.html">advanced</a>.</p>
<p><font color="gray"></p>
<h3 id="g2"><span class="header-section-number">1.1.1</span> (for older gitolite (v1.x and v2.x) users)</h3>
<p>For users of gitolite v2.x (call it &quot;g2&quot; for convenience),</p>
<ul>
<li><a href="#g3why">Why</a> I rewrote gitolite.</li>
<li>Development <a href="#dev-status">status</a>.</li>
<li>Information on <a href="#migr">migrating</a> from g2 to g3.</li>
</ul>
<p></font></p>
<h3 id="ql"><span class="header-section-number">1.1.2</span> quick links</h3>
<ul>
<li><a href="#trying">Trying</a> out gitolite.</li>
<li>Minimum <a href="#req">requirements</a>.</li>
<li>Here's how to do a <a href="#qi">quick install, setup, and clone</a>.</li>
<li>Don't know ssh well enough? <a href="#ssh">Learn</a>. It's <strong>IMPORTANT</strong>.</li>
<li>Add <a href="#users">users</a> and <a href="#repos">repos</a>.</li>
<li>Learn about fine-grained access control with the <a href="#conf">conf</a> file.</li>
<li>Explain gitolite to your <a href="#user">users</a>.</li>
</ul>
<p>The rest of the documentation is in the &quot;master index&quot; link at the top of each page on this website. This is the first place you should search when looking for specific information.</p>
<h3 id="what"><span class="header-section-number">1.1.3</span> What is gitolite?</h3>
<p>Gitolite is an access control layer on top of git. Here are the features that most people see:</p>
<ul>
<li>Use a single unix user (&quot;real&quot; user) on the server.</li>
<li>Provide access to many gitolite users:
<ul>
<li>they are not &quot;real&quot; users,</li>
<li>they do not get shell access.</li>
</ul></li>
<li>Control access to many git repositories:
<ul>
<li>read access controlled at the repo level,</li>
<li>write access controlled at the branch/tag/file/directory level, including who can rewind, create, and delete branches/tags.</li>
</ul></li>
<li>Can be installed without root access, assuming git and perl are already installed.</li>
<li>Authentication is most commonly done using sshd, but you can also use <a href="#http">http</a> if you prefer (this may require root access).</li>
</ul>
<h3 id="contact"><span class="header-section-number">1.1.4</span> contact and support</h3>
<ul>
<li>mailing list for support and general discussion:
<ul>
<li>gitolite@googlegroups.com</li>
<li>subscribe address: gitolite+subscribe@googlegroups.com</li>
</ul></li>
<li>mailing list for announcements and notices:
<ul>
<li>subscribe address: gitolite-announce+subscribe@googlegroups.com</li>
</ul></li>
<li><p>IRC: #git and #gitolite on freenode. Note that I live in India (UTC+0530 time zone). <strong>Please do not ask questions on IRC if you cannot stay connected for a few hours at least. Use the mailing list instead.</strong></p></li>
<li><p>author: sitaramc@gmail.com, but please <strong>DO NOT</strong> use this for general support questions. Subscribe to the list and ask there instead.</p></li>
</ul>
<h3 id="license"><span class="header-section-number">1.1.5</span> license</h3>
<p>This documentation, which is maintained separately from the main gitolite source code, is copyright Sitaram Chamarty and is provided under a <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.</p>
<p>However, certain parts are contributed by others who may have chosen other licenses; their names and license will be mentioned in the respective files.</p>
<p>Documentation for a software product will naturally contain code examples. I believe that the principle of fair use should cover use of those snippets; see especially factors 3 and 4 in the list of factors <a href="http://en.wikipedia.org/wiki/Fair_use#Fair_use_under_United_States_law">here</a>.</p>
<p>If you're not convinced that it would be fair use, then you may consider those code snippets, as well as associated &quot;comments&quot; if any, to be under the GPLv2 license. Licensing is about intent, and the intent of these examples is that you use them wherever and however you can use gitolite itself.</p>
<h2 id="testing"><span class="header-section-number">1.2</span> trying out gitolite safely</h2>
<h3 id="trying"><span class="header-section-number">1.2.1</span> trying out gitolite</h3>
<p><font color="red"><strong>WARNING: this will clobber lots of things in your <code>$HOME</code>, so be sure to use a throwaway userid</strong>.</font></p>
<p>It's easy to take gitolite for a trial run, in ssh mode, and play with all of its features (except mirroring).</p>
<p>Create a <strong>throw-away userid</strong>, log in to it, then run these commands:</p>
<pre><code>git clone git://github.com/sitaramc/gitolite
cd gitolite
prove t/ssh*</code></pre>
<p>You will get an error that forces you to read <code>t/README</code> and set an env var before the test can proceed. This is intentional; I've had people who don't pay attention to the &quot;data loss&quot; warning, and then complain that it was not prominent enough. Forcing them to read a much smaller document appears to focus their attention better!</p>
<p>If it doesn't work, read the testing section below to see if your system satisfies the conditions required for doing this.</p>
<p>If it works, you get a gitolite installation with 7 gitolite users (&quot;admin&quot;, and &quot;u1&quot; through &quot;u6&quot;).</p>
<p>Don't forget that the client and the server are all on the same user on the same machine; we're <em>simulating</em> 7 gitolite users using ssh keys! (How? Maybe <code>~/.ssh/config</code> will give you a hint).</p>
<p>URLs look like <code>user:repo</code>, so for example you can clone the admin repo by <code>git clone admin:gitolite-admin</code>. Remote commands look like <code>ssh u1 info</code>.</p>
<p>So start by cloning the admin repo, and try out whatever you want!</p>
<h3 id="testing-gitolite"><span class="header-section-number">1.2.2</span> testing gitolite</h3>
<p><font color="red"><strong>WARNING: this will clobber lots of things in your <code>$HOME</code>, so be sure to use a throwaway userid</strong>.</font></p>
<p>Trying out gitolite safely is really a subset of running the test suite. If you want to run the full test suite, just do as above, except instead of running <code>prove t/ssh*</code> you just run <code>prove</code>.</p>
<p>The test suite should run fine on most recent Linuxes and Unixes. Although gitolite itself should work fine with any git after 1.6.6 or so, the test suite requires git 1.7.8 or later.</p>
<p>Make sure:</p>
<ul>
<li><code>$HOME/bin</code> is in <code>$PATH</code></li>
<li>sshd allows incoming ssh to this userid, at least from localhost</li>
</ul>
<p>Gitolite's test suite is mostly written using <a href="http://github.com/sitaramc/tsh">tsh</a> -- the &quot;testing shell&quot;. Take a look at some of the scripts and you will see what it looks like. It has a few quirks and nuances, but it's fine for what I need here.</p>
<p>The tests also use a somewhat convoluted system of environment variables in order to run <em>entirely</em> as a local user, without going through ssh at all. This lets a complete test suite run in about a fifth or less of the time it would otherwise take.</p>
<p>If you think that defeats the purpose of the testing, you haven't read <a href="#auth">this</a> yet.</p>
<h2 id="qi"><span class="header-section-number">1.3</span> quick install, setup, and clone</h2>
<h3 id="assumptions"><span class="header-section-number">1.3.1</span> ASSUMPTIONS</h3>
<ul>
<li><p>You've read the <a href="#WARNINGS">WARNINGS</a> page ;-)</p></li>
<li><p>This is an ssh-based setup. For smart http setup click <a href="#http">here</a>.</p></li>
<li><p>This is a fresh install, not a migration from the old gitolite (v1.x, v2.x).</p></li>
<li><p>On the server, <code>$HOME/bin</code> exists and is in your <code>$PATH</code>. If you don't like that, there are <a href="#install">other install methods</a>.</p></li>
<li>&quot;your-name.pub&quot; is your public key from your workstation.
<ul>
<li>Also, this key does not already have shell access to this gitolite <a href="#nnc">hosting user</a>.</li>
</ul></li>
<li>The setup command does not generate any warnings.
<ul>
<li>If it does, please see <a href="#ce">common errors</a> and fix things before continuing, or read the more complete <a href="#setup">setup</a> page.</li>
</ul></li>
</ul>
<h3 id="instructions"><span class="header-section-number">1.3.2</span> instructions</h3>
<p>On the server, as the <a href="#nnc">hosting user</a> (e.g., 'git'):</p>
<pre><code># get the software
git clone git://github.com/sitaramc/gitolite

# install it
gitolite/install -ln

# setup the initial repos with your key
gitolite setup -pk your-name.pub</code></pre>
<p>On your workstation:</p>
<pre><code># clone the admin repo so you can start adding stuff
git clone git@host:gitolite-admin.git
# Note 1: clone path must not include &quot;repositories/&quot;
# Note 2: it may include the &quot;.git&quot; at the end but it is optional</code></pre>
<h3 id="next-steps"><span class="header-section-number">1.3.3</span> next steps</h3>
<p>If this step succeeds, you can add <a href="#users">users</a>, <a href="#repos">repos</a>, or anything else described <a href="#adminrepo">here</a>.</p>
<p>If this step fails, be sure to look at the <a href="#ssh">ssh</a> documentation before asking for help. (A very basic first step is to run <code>ssh git@host info</code>; <a href="#info">this</a> page tells you what to expect).</p>
<h2 id="user"><span class="header-section-number">1.4</span> what users (not admins) need to know about gitolite</h2>
<!-- pandoc: toc -->

<p>...written for the one guy in the world no one will think of as &quot;just a normal user&quot; ;-)</p>
<hr />
<h3 id="accessing-gitolite"><span class="header-section-number">1.4.1</span> accessing gitolite</h3>
<p>The most common setup is based on ssh, where your admin asks you to send him your public key, and uses that to setup your access.</p>
<p>Your actual access is either a git command (like <code>git clone git@server:reponame</code>, and we won't be discussing these any more in this document), or an ssh command (like <code>ssh git@server info</code>).</p>
<p>Note that you do <em>not</em> get a shell on the server -- the whole point of gitolite is to prevent that!</p>
<p><strong>Note to people (*) who think gitolite requires or can only handle a specific syntax of URL</strong>: Gitolite is designed in such a way that, unless there is an access violation, the <em>client</em> need not even <em>know</em> that something called gitolite is sitting between it and git on the server. In particular, this means <em>any</em> URL syntax listed in 'man git-clone' for ssh and/or http will work. The only things to note are:</p>
<ul>
<li>in ssh mode, you <em>must</em> use key-based authentication (i.e., passwords won't work; see the <a href="#ssh">ssh</a> documents for why)</li>
<li>the path of the repo is what you put into the conf file (e.g., &quot;testing&quot;, and not &quot;repositories/testing&quot; or &quot;/home/git/repositories/testing&quot; or such). A good rule of thumb is to use the exact name the <code>info</code> command (see below) shows you.</li>
<li>the &quot;.git&quot; at the end is optional for <strong>git</strong> commands (i.e., you can use &quot;testing.git&quot; instead of &quot;testing&quot; for clone, fetch, push, etc., if you like) but <strong>gitolite</strong> commands in general (see below) will not like the additional &quot;.git&quot; at the end.</li>
</ul>
<p><font color="gray">(*): A curious, but decidedly non-scientific, observation: this appears to happen mostly to Mac people; I don't recall many Windows people getting confused, and almost none who use Unix doing so).</font></p>
<h3 id="info"><span class="header-section-number">1.4.2</span> the info command</h3>
<p>The only command that is <em>always</em> available to every user is the <code>info</code> command (run <code>ssh git@host info -h</code> for help), which tells you what version of gitolite and git are on the server, and what repositories you have access to. The list of repos is very useful if you have doubts about the spelling of some new repo that you know was setup.</p>
<h3 id="digression-two-kinds-of-repos"><span class="header-section-number">1.4.3</span> digression: two kinds of repos</h3>
<p>Gitolite has two kinds of repos. Normal repos are specified by their full names in the config file. &quot;Wildcard&quot; repos are specified by a regex in the config file. Try the <a href="#info"><code>info</code> command</a> and see if it shows any lines that look like regex patterns, (with a &quot;C&quot; permission).</p>
<p>If you see any, it means you are allowed to create brand new repos whose names fit that pattern. When you create such a repo, your &quot;ownership&quot; of it (as far as gitolite is concerned) is automatically recorded by gitolite.</p>
<h3 id="other-commands"><span class="header-section-number">1.4.4</span> other commands</h3>
<h4 id="perms"><span class="header-section-number">1.4.4.1</span> set/get additional permissions for repos you created</h4>
<p>The gitolite config may have several permissions lines for your repo, like so:</p>
<pre><code>repo pub/CREATOR/..*
    C       =   ...some list of users allowed to create repos...
    RW+     =   CREATOR
    RW      =   user1 user2
    R       =   user3</code></pre>
<p>If that's all it had, you really can't do much. Any changes to access must be done by the administrator. (Note that &quot;CREATOR&quot; is a reserved word that gets expanded to your userid in some way, so the admin can literally add just the first three lines, and <em>every</em> authenticated user now has his own personal repo namespace, starting with <code>pub/&lt;username&gt;/</code>).</p>
<p>To give some flexibility to users, the admin could add rules like this:</p>
<pre><code>    RW      =   WRITERS
    R       =   READERS</code></pre>
<p>(he could also add other <a href="#roles">roles</a> but then he needs to read the documentation).</p>
<p>Once he does this, you can then use the <code>perms</code> command (run <code>ssh git@host perms -h</code> for help) to set permissions for other users by specifying which users are in the list of &quot;READERS&quot;, and which in &quot;WRITERS&quot;.</p>
<p>If you think of READERS and WRITERS as &quot;roles&quot;, it will help. You can't change what access a role has, but you <em>can</em> say which users have that role.</p>
<p><strong>Note</strong>: there isn't a way for you to see the actual rule set unless you're given read access to the special 'gitolite-admin' repo. Sorry. The idea is that your admin will tell you what &quot;roles&quot; he added into rules for your repos, and what permissions those roles have.</p>
<h4 id="desc"><span class="header-section-number">1.4.4.2</span> adding a description to repos you created</h4>
<p>The <code>desc</code> command is extremely simple. Run <code>ssh git@host desc -h</code> for help.</p>
<h3 id="site-local-commands"><span class="header-section-number">1.4.5</span> &quot;site-local&quot; commands</h3>
<p>The main purpose of gitolite is to prevent you from getting a shell. But there are commands that you often need to run on the server (i.e., cannot be done by pushing something to a repo).</p>
<p>To enable this, gitolite allows the admin to setup scripts in a special directory that users can then run. Gitolite comes with a set of working scripts that your admin may install, or may use as a starting point for his own, if he chooses.</p>
<p>Think of these commands as equivalent to those in <code>COMMAND_DIR</code> in <code>man git-shell</code>.</p>
<p>You can get a list of available commands by running <code>ssh git@host help</code>.</p>
<h2 id="users"><span class="header-section-number">1.5</span> adding and removing users</h2>
<p>Strictly speaking, gitolite doesn't know where users come from. If that surprises you, read <a href="#auth">this</a>. However, gitolite does help with ssh-based authentication, so here's some info on adding and removing users.</p>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p><em>WARNING: Do NOT add new repos or users manually on the server. Gitolite users, repos, and access rules are maintained by making changes to a special repo called 'gitolite-admin' and pushing those changes to the server.</em></p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<p>All operations are in a clone of the gitolite-admin repo.</p>
<p>To <strong>add</strong> a user, say Alice, obtain her public key (typically <code>$HOME/.ssh/id_rsa.pub</code> on her workstation), copy it to <code>keydir</code> with the user name as the basename (e.g., 'alice.pub' for user alice), then <code>git add keydir/alice.pub</code>. (All keys files must have names ending in &quot;.pub&quot;, and must be in openssh's default format).</p>
<p>To <strong>remove</strong> a user, <code>git rm keydir/alice.pub</code>.</p>
<p>In both cases, you must commit and push. On receiving the push, gitolite will carry out the changes specified.</p>
<p>The user name is simply the base name of the public key file name. So 'alice.pub', 'foo/alice.pub' and 'bar/alice.pub', all resolve to user &quot;alice&quot;.</p>
<h3 id="multi-key"><span class="header-section-number">1.5.1</span> multiple keys per user</h3>
<p>The simplest and most understandable is to put their keys in different subdirectories, (alice.pub, home/alice.pub, laptop/alice.pub, etc). This can be any depth -- only the last component (the actual pubkey file name) is all that matters.</p>
<h4 id="old-style-multi-keys"><span class="header-section-number">1.5.1.1</span> old style multi-keys</h4>
<p>There is another way that involves creating key files like <code>alice@home.pub</code> and <code>alice@laptop.pub</code>, but there is a complication because gitolite also allows <em>full email addresses</em> as user names. (I.e., <code>sitaramc@gmail.com.pub</code> denotes the user called <code>sitaramc@gmail.com</code>).</p>
<p>This older method of enabling multi-keys was developed to deal with that. It will continue to work and be supported in <em>code</em>, simply because I prefer it. But I will not accept questions or doc patches for it, because it seems it is too difficult to understand for a lot of people. This table of sample pubkey filenames and the corresponding derived usernames is all you get:</p>
<ul>
<li><p>plain username, no multikey</p>
<pre><code>sitaramc.pub                            sitaramc</code></pre></li>
<li><p>plain username, with multikeys</p>
<pre><code>sitaramc@laptop.pub                     sitaramc
sitaramc@desktop.pub                    sitaramc</code></pre></li>
<li><p>email address as username, no multikey</p>
<pre><code>sitaramc@gmail.com.pub                  sitaramc@gmail.com</code></pre></li>
<li><p>email address as username, with multikeys</p>
<pre><code>sitaramc@gmail.com@laptop.pub           sitaramc@gmail.com
sitaramc@gmail.com@desktop.pub          sitaramc@gmail.com</code></pre></li>
</ul>
<h2 id="repos"><span class="header-section-number">1.6</span> adding and removing repos</h2>
<p><strong>NOTE</strong>: this page describes how to add new repos. To bring already existing repos into gitolite control, click <a href="#existing">here</a>.</p>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p><em>WARNING: Do NOT add new repos or users manually on the server. Gitolite users, repos, and access rules are maintained by making changes to a special repo called 'gitolite-admin' and pushing those changes to the server.</em></p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<p>Just as for <a href="#users">users</a>, all operations are in a clone of the gitolite-admin repo.</p>
<p>To <strong>add</strong> a new repo, edit <code>conf/gitolite.conf</code> and add it, along with at least one user with some permissions. Or add it to an existing repo line:</p>
<pre><code>repo gitolite tsh gitpod
    RW+     =   sitaram
    RW  dev =   alice bob
    R       =   @all</code></pre>
<p>The &quot;repo&quot; line can have any number of repo names or repo group names in it. However, it can only be one line; this will not work</p>
<pre><code>repo foo
repo bar    # WRONG; 'foo' is now forgotten
    RW      =   alice</code></pre>
<p>If you have too many, use a group name:</p>
<pre><code>@myrepos    =   foo
@myrepos    =   bar

repo @myrepos
    RW      =   alice</code></pre>
<p>Finally, you add, commit, and push this change. Gitolite will create a bare, empty, repo on the server that is ready to be cloned.</p>
<p><strong>Removing</strong> a repo is not so straightforward. You certainly must remove the appropriate lines from the <code>conf/gitolite.conf</code> file, but gitolite will not automatically delete the repo from the server. You have to log on to the server and do the dirty deed yourself :-)</p>
<p>It is best to make the change in the conf file, push it, and <em>then</em> go to the server and do what you need to.</p>
<p><strong>Renaming</strong> a repo is also not automatic. Here's what you do (and the order is important):</p>
<ul>
<li>Go to the server and rename the repo at the Unix command line.</li>
<li>Change the name in the conf/gitolite.conf file and add/commit/push.</li>
</ul>
<h2 id="groups"><span class="header-section-number">1.7</span> group definitions</h2>
<p>You can group repos or users for convenience. The syntax is the same for both and does not distinguish; until you <em>use</em> the group name it could really be either.</p>
<p>Here's an example:</p>
<pre><code>@developers     =   dilbert alice wally</code></pre>
<p>Group definitions accumulate; this is the same as the above:</p>
<pre><code>@developers     =   dilbert
@developers     =   alice
@developers     =   wally</code></pre>
<p>You can use one group in another group definition; the values will be expanded right there (meaning later additions will not appear in the second group).</p>
<pre><code>@developers     =   dilbert alice
@interns        =   ashok
@staff          =   @interns @developers
@developers     =   wally

# wally is NOT part of @staff</code></pre>
<h3 id="special-group-all"><span class="header-section-number">1.7.1</span> special group <code>@all</code></h3>
<p><code>@all</code> is a special group name that is often convenient to use if you really mean &quot;all repos&quot; or &quot;all users&quot;.</p>
<h3 id="warnings-on-undefined-groups"><span class="header-section-number">1.7.2</span> warnings on undefined groups</h3>
<p>Gitolite cannot truly catch undefined groups because the conf parser is 1-pass, and you're allowed to define a group <em>after</em> it is used, like so:</p>
<pre><code>repo foo
    RW  =   @foo
@foo = u1 u2</code></pre>
<p>From v3.5.3 on, however, in a simplistic attempt to help people tearing their hair out because of a typo, gitolite will warn if a group is not defined when it is used. (So if you defined it later, either ignore the warning or move the definition up).</p>
<p>Note that these warnings do NOT appear if you're <a href="#ldap">getting user group info from LDAP</a>.</p>
<h2 id="emergencies"><span class="header-section-number">1.8</span> help for emergencies</h2>
<!-- pandoc: toc -->

<blockquote>
<hr />
</blockquote>
<blockquote>
<p><font color="red"><strong>&quot;Don't Panic!&quot;</strong></font></p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<h3 id="installsetup-issues"><span class="header-section-number">1.8.1</span> install/setup issues</h3>
<p>Most install/setup issues are caused by lack of ssh knowledge. Ssh is a complex beast, and -- unless you are using the <a href="#http">http</a> mode -- can cause problems for people who are not familiar with its quirks.</p>
<p><strong>Be prepared to spend some time reading the <a href="#ssh">ssh</a> documentation that comes with gitolite</strong>.</p>
<h3 id="lost-key"><span class="header-section-number">1.8.2</span> lost admin key/access</h3>
<p>If you lost your gitolite <strong>admin</strong> key or access, here's what you do. We'll assume your username is 'alice'.</p>
<ul>
<li><p>Make yourself a new keypair and copy the public key to the server as 'alice.pub'.</p></li>
<li><p>Log on to the server, and run <code>gitolite setup -pk alice.pub</code>.</p></li>
</ul>
<p>That's it; the new alice.pub file replaces whatever existed in the repo before.</p>
<h3 id="bypass"><span class="header-section-number">1.8.3</span> bypassing gitolite</h3>
<p>You may have lost access because of a conf file error, in which case the above trick won't help. What you want is to make changes to the repo (or perhaps just rewind) and push that. Here's how to do that:</p>
<ul>
<li><p>Log on to the server.</p></li>
<li><p>Clone the admin repo using the full path: <code>git clone     $HOME/repositories/gitolite-admin.git temp</code>.</p></li>
<li><p>Make whatever changes you want -- add/replace a key, 'git revert' or 'git reset --hard' to an older commit, etc. Anything you need to fix the problem, really.</p></li>
<li><p>Run <code>gitolite push</code> (or possibly <code>gitolite push -f</code>). Note that's 'gitolite push', not 'git push'.</p></li>
</ul>
<p><font color="red"> <strong>NOTE</strong>: gitolite does <strong>no access checking</strong> when you do this! </font></p>
<h3 id="botch"><span class="header-section-number">1.8.4</span> botched something?</h3>
<h4 id="fixing-botched-repos"><span class="header-section-number">1.8.4.1</span> fixing botched repos</h4>
<p>If you copied some repos from somewhere else, or mucked with the hooks for some reason, or deleted any gitolite-specific files, or tried any other &quot;behind the scenes&quot; stunts, the quickest, sanest, way to fix everything up is:</p>
<ul>
<li>make sure any new repos you copied in are mentioned in the gitolite.conf in some 'repo' line and the change pushed</li>
<li>then run <code>gitolite setup</code> on the server</li>
</ul>
<p>If the repo you botched is a wild repo, please ask on the mailing list or on IRC (see <a href="#contact">contact</a>).</p>
<h4 id="clean"><span class="header-section-number">1.8.4.2</span> cleaning out a botched install</h4>
<p>If you've read the <a href="#files">files involved in gitolite</a> page, you probably know the answer, but here's a list of files and directories to deal with:</p>
<ul>
<li><p><strong>Gitolite sources</strong> -- can be found by running <code>which gitolite</code>. If it's a symlink, go to its target directory.</p></li>
<li><p><strong>Gitolite admin directory</strong> -- <code>$HOME/.gitolite</code>. Save the 'logs' directory if you want to preserve them for any reason.</p></li>
<li><p><strong>The rc file</strong> -- <code>$HOME/.gitolite.rc</code>. If you made any changes to it you can save it as some other name instead of deleting it.</p></li>
<li><p><strong>The gitolite-admin repo</strong> -- <code>$HOME/repositories/gitolite-admin.git</code>. You can clone it somewhere to save it before blowing it away if you wish.</p></li>
<li><p><strong>Git repositories</strong> -- <code>$HOME/repositories</code>. The install process will not touch any existing repos except 'gitolite-admin.git', so you do not have to blow away (or move) your work repos to fix a botched install.</p>
<p>Only when you update the conf to include those repos and push the changes will those repos be touched. And even then all that happens is that the update hook, if any, is replaced with gitolite's own hook.</p></li>
<li><p><strong>Ssh stuff</strong> -- exercise caution when doing this, but in general it should be safe to delete all lines between the &quot;gitolite start&quot; and &quot;gitolite end&quot; markers in <code>$HOME/.ssh/authorized_keys</code>.</p>
<p>Gitolite does not touch any other files in the ssh directory.</p></li>
</ul>
<h3 id="ce"><span class="header-section-number">1.8.5</span> common errors</h3>
<ul>
<li><p><code>WARNING: keydir/&lt;yourname&gt;.pub duplicates a non-gitolite key, sshd will ignore it</code></p>
<p>You used a key that is already set to give you shell access. You cannot use the same key to get shell access as well as access gitolite repos.</p>
<p>Solution: use a different keypair for gitolite. There's a slightly longer discussion in the <a href="#setup">setup</a> page. Also see <a href="#ybpfail">why bypassing causes a problem</a> and both the documents in <a href="#ssh">ssh</a> for background.</p></li>
<li><p><code>Empty compile time value given to use lib at hooks/update line 6</code></p>
<p>(followed by <code>Can't locate Gitolite/Hooks/Update.pm in @INC</code> a couple of lines later).</p>
<p>You're bypassing gitolite. You cloned the repo using the full path (i.e., including the <code>repositories/</code> prefix), either directly on the server, or via ssh but with a key that gives you <strong>shell</strong> access.</p>
<p>Solution: same as for the previous bullet.</p>
<p>NOTE: If you really <em>must</em> do it, and this is a one-time thing, you can try <code>gitolite push</code> instead of <code>git push</code>. <strong>BUT</strong>... this defeats all gitolite access control, so if you're going to do this often, maybe you don't need gitolite!</p></li>
</ul>
<h3 id="ue"><span class="header-section-number">1.8.6</span> uncommon errors</h3>
<p>(This page intentionally left blank)</p>
<h3 id="nonstd"><span class="header-section-number">1.8.7</span> non-standard configs that'll trip you up</h3>
<ul>
<li><p>if your 'git' binary is in a non-PATH location, or you have more than one version and want a specific one to be picked up, you will have to add a line like this at the end of the rc file (outside the <code>%RC</code> hash, but before the<code>1;</code> line):</p>
<pre><code>$ENV{PATH} = &quot;/your/git/path:$ENV{PATH}&quot;;</code></pre></li>
<li><p>having sshd setup to put the authorized_keys file somewhere other than the default (which is in .ssh in the <a href="#nnc">hosting user</a>'s home directory).</p></li>
<li><p>having sshd setup to not allow incoming ssh for the hosting user. Check things like 'Allowusers' setting in /etc/ssh/sshd_config etc.</p></li>
<li><p>having the home directory in a partition that is mounted noexec.</p></li>
<li><p>having the default shell be something like /bin/false, and/or not having the default shell be part of /etc/shells.</p></li>
</ul>
<h3 id="ngp"><span class="header-section-number">1.8.8</span> things that are not gitolite problems</h3>
<p>There are several things that appear to be gitolite problems but are not. I cannot help with most of these (although the good folks on irc or the mailing list -- see <a href="#contact">contact</a> -- might be able to; they certainly appear to have a lot more patience than I do, bless 'em!)</p>
<ul>
<li><p><strong>Client side software</strong></p>
<ul>
<li>putty/plink</li>
<li>jgit/Eclipse</li>
<li>Mac OS client <strong>or</strong> server</li>
<li>putty/plink</li>
<li>windows as a server</li>
<li>...probably some more I forgot; will update this list as I remember...</li>
<li>did I mention putty/plink?</li>
</ul></li>
<li><p><strong>Ssh</strong></p>
<p>The <em>superstar</em> of the &quot;not a gitolite problem&quot; category is actually ssh.</p>
<p>Surprised? It is so common that it has <a href="#auth">its own document</a> to tell you why it is <em>not</em> a gitolite problem, while <a href="#ssh">another one</a> tries to help you anyway!</p>
<p>Everything I know is in that latter link. Please email me about ssh ONLY if you find something wrong or missing in those documents.</p></li>
<li><p><strong>Git</strong></p>
<p>I wish I had a dollar for each time someone did a <em>first push</em> on a new repo, got an error because there were &quot;no refs in common (etc.)&quot;, and asked me why gitolite was not allowing the push.</p>
<p>Gitolite is designed to look like just another bare repo server to a client (except requiring public keys -- no passwords allowed). It is <em>completely transparent</em> when there is no authorisation failure (i.e., when the access is allowed, the remote client has no way of knowing gitolite was even installed!)</p>
<p>Even &quot;on disk&quot;, apart from reserving the <code>update</code> hook for itself, gitolite does nothing to your bare repos unless you tell it to (for example, adding 'gitweb.owner' and such to the config file).</p>
<p>BEFORE you think gitolite is the problem, try the same thing with a normal bare repo. In most cases you can play with it just by doing something like this:</p>
<pre><code>mkdir /tmp/throwaway
cd    /tmp/throwaway
git clone --mirror &lt;some repo you have a URL for&gt; bare.git
git clone bare.git worktree
cd worktree
&lt;...try stuff&gt;</code></pre></li>
</ul>
<h2 id="WARNINGS"><span class="header-section-number">1.9</span> WARNINGS</h2>
<p><strong>Please take note of the following points</strong>:</p>
<ul>
<li><p>If you're bringing existing repos into gitolite, please see <a href="#existing">this</a> first.</p></li>
<li><p>Gitolite expects all the directories and files it manages/uses to be owned by the <a href="#nnc">hosting user</a> and not have strange permissions and ownerships.</p></li>
<li><p>Gitolite does NOT like it if you fiddle with files and directories it cares about in any way except as directed in the documentation.</p>
<p>Gitolite cares about the following directories</p>
<pre><code>~/.gitolite.rc
~/.gitolite
~/repositories/gitolite-admin.git</code></pre>
<p>Also, in each repo, gitolite cares about</p>
<pre><code>gl-*
hooks/update</code></pre></li>
<li><p>Gitolite depends on several system-installed packages: openssh, git, perl, sh being the main ones. They should all be configured sensibly and with most of the normal defaults. (For example, if your sshd config says the authorized keys file should be placed in some directory other than the default, expect trouble).</p></li>
</ul>
<p>...ok that's the serious stuff done...</p>
<hr />
<p>For the entertainment of the sensible majority, and as a way of thanking all of you, here are some examples of requests (demands in some cases) I have received over the last couple of years.</p>
<ul>
<li><p>deleting environment variables copied from client session</p>
<p>demand: add code to delete certain environment variables at startup because &quot;the openssh servers in the linux distribution that [he] use[s], are configured to copy <code>GIT_*</code> variables to the remote session&quot;.</p>
<p>This is wrong on so many levels it's almost plonk-able!</p></li>
<li><p>using <code>cp</code> instead of <code>ln</code></p>
<p>Guy has an NTFS file system mounted on Linux. So... no symlinks (an NTFS file system on Windows works fine because msysgit/cygwin manage to <em>simulate</em> them. NTFS mounted on Linux won't do that!)</p>
<p>He wanted all the symlink stuff to be replaced by copies.</p>
<p>No. Way.</p></li>
<li><p>non-bare repos on the server</p>
<p>Some guy gave me a complicated spiel about git-svn not liking bare repos or whatever. I tuned off at the first mention of those 3 letters so I don't really know what the actual problem was.</p>
<p>But it doesn't matter. Even if someone (Ralf H) had not chipped in with a workable solution, I still would not do it. A server repo should be bare. Period.</p></li>
<li><p>incomplete ownership of <code>GL_REPO_BASE</code></p>
<p>This guy had a repo-base directory where not all of the files were owned by the git user. As a result, some of the hooks did not get created. He claimed my code should detect OS-permissions issues while it's doing its stuff.</p>
<p>No. I refuse to have the code constantly look over its shoulder making sure fundamental assumptions are being met.</p></li>
<li><p>empty template directory</p>
<p>(See man git-init for what a template directory is).</p>
<p>The same guy with the environment variables had an empty template directory because he &quot;does not like to have sample hooks in every repository&quot;. So naturally, the hooks directory does not get created when you run a <code>git init</code>. He expects gitolite to compensate for it.</p>
<p>Granted, it's only a 1-line change. But again, this falls under &quot;constantly looking over your shoulder to double check fundamental assumptions&quot;. Where does it end?</p></li>
</ul>
<h1 id="s2"><span class="header-section-number">2</span> detailed installation and access rules</h1>
<h2 id="install"><span class="header-section-number">2.1</span> installing gitolite</h2>
<p><font color="red"><strong>NOTE</strong>: if you're migrating from g2, there are some settings that MUST be dealt with <strong>before</strong> running <code>gitolite setup</code>; please start <a href="#migr">here</a>. RTFM is <em>mandatory</em> for migrations.</font></p>
<hr />
<p>This is the first step in using gitolite, and happens on the server. It is followed by <a href="#setup">setup</a>, then <a href="#clone">clone</a>.</p>
<hr />
<h3 id="nnc"><span class="header-section-number">2.1.1</span> notes and naming conventions</h3>
<!-- pandoc: toc -->

<p>Gitolite uses a single &quot;real&quot; (i.e., unix) user to provide secure access to git repos to any number of &quot;virtual&quot; users, without giving them a shell.</p>
<p>The real user used is called the <strong>hosting user</strong>. Typically this user is <em>git</em>, and that is what we will use throughout the documentation. However RPMs and DEBs create a user called <em>gitolite</em> for this, so adjust instructions and examples accordingly.</p>
<p><strong>Unless otherwise stated, everything in this page is to be done by logging in as this &quot;hosting user&quot;</strong>.</p>
<p>Notes:</p>
<ul>
<li>Any unix user can be a hosting user.</li>
<li>Which also means you can have several hosting users on the same machine.</li>
<li>The URLs used will be of the form <code>git@host:reponame</code> (or its longer equivalent starting with <code>ssh://</code>). The <code>.git</code> at the end is optional. I recommend you leave it out, so your reponames are consistent with what the conf file uses.</li>
</ul>
<h3 id="req"><span class="header-section-number">2.1.2</span> requirements</h3>
<h4 id="your-skills"><span class="header-section-number">2.1.2.1</span> your skills</h4>
<ul>
<li><p>If you're installing gitolite, you're a &quot;system admin&quot;, like it or not. Since most people use the ssh mode, <strong><a href="#ssh">ssh</a></strong> is therefore a necessary skill. Please take the time to learn at least enough to get passwordless access working.</p></li>
<li><p>You also need to be somewhat familiar with git itself. You cannot administer a whole bunch of git repositories if you don't know the basics of git.</p></li>
<li><p>Some familiarity with Unix and shells is probably required.</p></li>
<li><p>Regular expressions are a big part of gitolite in many places but familiarity is not necessary to do <em>basic</em> access control.</p></li>
</ul>
<h4 id="server"><span class="header-section-number">2.1.2.2</span> server</h4>
<ul>
<li>Any Unix system with a posix compatible &quot;sh&quot; and a <strong>sane</strong> file system.</li>
<li>Git version 1.6.6 or later. (Git 1.7.8 or later if you want to run the test suite).</li>
<li>Perl 5.8.8 or later.</li>
<li>Openssh (almost any version). Optional if you're using <a href="#http">smart http</a>.</li>
<li>A dedicated Unix userid to be the hosting user, usually &quot;git&quot; but it can be any user, even your own normal one. (If you're using an RPM/DEB the install probably created one called &quot;gitolite&quot;).</li>
</ul>
<p>Also see the <a href="#WARNINGS">WARNINGS</a> page for important information of general use.</p>
<h4 id="client"><span class="header-section-number">2.1.2.3</span> client</h4>
<ul>
<li>Openssh client.</li>
<li>Git 1.6.6 or later. Almost any git client will work, as long as it knows how to use ssh keys and send the right one along.</li>
</ul>
<h3 id="getting-the-software"><span class="header-section-number">2.1.3</span> getting the software</h3>
<pre><code>git clone git://github.com/sitaramc/gitolite</code></pre>
<p>(Do I need to mention that you can optionally check out a specific tag if you wish, as long as it's not too old?)</p>
<h3 id="the-actual-install"><span class="header-section-number">2.1.4</span> the actual install</h3>
<p><strong>Note</strong>: This section describes installing an ssh-based setup. For smart http setup click <a href="#http">here</a>.</p>
<p>Gitolite has only one server side &quot;command&quot; now, much like git itself. This command is <code>gitolite</code>. You don't need to place it anywhere special; worst case you run it with the full path.</p>
<p>&quot;Installation&quot; consists of the following options:</p>
<ol style="list-style-type: decimal">
<li>Keep the sources anywhere and use the full path to run the <code>gitolite</code> command.</li>
<li>Keep the sources anywhere and symlink <em>just</em> the <code>gitolite</code> program to some directory on your <code>$PATH</code>.</li>
<li>Copy the sources somewhere and use that path to run the <code>gitolite</code> command.</li>
</ol>
<p>Option 2 is the best for general use.</p>
<p>There is a program called 'install' that helps you do these easily. Assuming your cloned the repo like this:</p>
<pre><code>git clone git://github.com/sitaramc/gitolite</code></pre>
<p>you can run the 'install' command in 3 different ways:</p>
<pre><code># option 1
gitolite/install

# option 2
gitolite/install -ln
# defaults to $HOME/bin (which is assumed to exist)
#   ** or **
# or use a specific directory (please supply full path):
gitolite/install -ln /usr/local/bin

# option 3
# (again, please supply a full path)
gitolite/install -to /usr/local/gitolite/bin</code></pre>
<p>Creating a symlink doesn't need a separate program but 'install' also runs <code>git describe</code> to create a VERSION file, which, trust me, is important!</p>
<p><strong>Next step</strong>: run <a href="#setup"><strong>setup</strong></a>.</p>
<h3 id="upgrading"><span class="header-section-number">2.1.5</span> upgrading</h3>
<ul>
<li>Update your clone of the gitolite source.</li>
<li>Repeat the install command you used earlier (make sure you use the same arguments as before).</li>
<li>Run <code>gitolite setup</code>.</li>
</ul>
<h3 id="package"><span class="header-section-number">2.1.6</span> packaging gitolite</h3>
<p>Gitolite has broad similarities to git in terms of packaging requirements.</p>
<ul>
<li><p>Git has 150 executables to marshal and put somewhere. Gitolite has the directories <code>commands</code>, <code>lib</code>, <code>syntactic-sugar</code>, <code>triggers</code>, and <code>VREF</code>.</p>
<p>It doesn't matter what this directory is. As an example, Fedora keeps git's 150 executables in /usr/libexec/git-core, so /usr/libexec/gitolite may be a good choice; it's upto you.</p>
<p><em>The rest of this section will assume you chose /usr/libexec/gitolite as the location, and that this location contains the 5 directories named above</em>.</p></li>
<li><p>Git has the <code>GIT_EXEC_PATH</code> env var to point to this directory. Gitolite has <code>GL_BINDIR</code>. However, in git, the &quot;make&quot; process embeds a suitable default into the binary, making the env var optional.</p></li>
</ul>
<p>With that said, here's one way to package gitolite:</p>
<ul>
<li><p>Put the executable <code>gitolite</code> somewhere in PATH. Put the executable <code>gitolite-shell</code> in /usr/libexec/gitolite (along with those 5 directories).</p>
<p>Change the 2 assignments to <code>$ENV{GL_BINDIR}</code>, one in 'gitolite', one in 'gitolite-shell', to &quot;/usr/libexec/gitolite&quot; from <code>$FindBin::RealBin</code>. This is equivalent to &quot;make&quot; embedding the exec-path into the executable.</p>
<p><strong>OR</strong></p>
<p>Put both executables <code>gitolite</code> and <code>gitolite-shell</code> also into /usr/libexec/gitolite (i.e., as siblings to the 5 directories mentioned above). Then <em>symlink</em> <code>/usr/libexec/gitolite/gitolite</code> to some directory in the PATH. Do not <em>copy</em> it; it must be a symlink.</p>
<p>Gitolite will find the exec-path by following the symlink.</p></li>
<li><p>The <code>Gitolite</code> subdirectory in <code>/usr/libexec/gitolite/lib</code> can stay right there, <strong>OR</strong>, if your distro policies don't allow that, can be put in any directory in perl's <code>@INC</code> path (such as <code>/usr/share/perl5/vendor_perl</code>).</p></li>
<li><p>Finally, a file called <code>/usr/libexec/gitolite/VERSION</code> must contain a suitable version string.</p></li>
</ul>
<h2 id="setup"><span class="header-section-number">2.2</span> setting up gitolite</h2>
<p>This is the second step in using gitolite, after <a href="#install">install</a>. This also happens on the server, (The next step is <a href="#clone">clone</a>).</p>
<hr />
<p>Installing the software gets you ready to use it, but the first &quot;use&quot; of it is always the &quot;setup&quot; command.</p>
<p>The first time you run it, you need to have a public key file (usually from the admin's workstation) ready. If the main gitolite admin's username is &quot;alice&quot;, this file should be named &quot;alice.pub&quot;. Then, as the <a href="#nnc">hosting user</a>, run:</p>
<pre><code>gitolite setup -pk alice.pub</code></pre>
<p>If that command completes without any warnings, you should be done. If it had a warning, you probably supplied a key which already has shell access to the server. That won't work.</p>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p>Normally, gitolite is hosted on a user that no one accesses directly -- you log on to the server using some other userid, and then <code>su - git</code>. In this scenario, there <em>is</em> no key being used for shell access, so there is no conflict.</p>
</blockquote>
<blockquote>
<p>An alternative method is to use two different keys, and a <a href="#ssh-ha">host alias</a> to distinguish the two.</p>
</blockquote>
<blockquote>
<p><a href="#ce">common errors</a> has some links to background information on this issue.</p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<p>The 'setup' command has other uses, so you will be running it at other times after the install as well:</p>
<ul>
<li><p>To setup the update hook when you move <a href="#existing">existing</a> repos to gitolite. This also applies if someone has been fiddling with the hooks on some repos and you want to put them all right quickly.</p></li>
<li><p>To replace a <a href="#lost-key">lost admin key</a>.</p></li>
<li><p>To setup gitolite for http mode (run 'gitolite setup -h' for more info).</p></li>
</ul>
<p>When in doubt, run 'gitolite setup' anyway; it doesn't do any harm, though it may take a minute or so if you have more than a few thousand repos!</p>
<h2 id="clone"><span class="header-section-number">2.3</span> cloning the admin repo</h2>
<p>This is the third step in using gitolite, after <a href="#install">install</a> and <a href="#setup">setup</a>.</p>
<p>To clone the admin repo, go to the workstation where the public key used in 'setup' came from, and run this:</p>
<pre><code>git clone git@host:gitolite-admin</code></pre>
<p>NOTE that (1) you must not include the <code>repositories/</code> part (gitolite handles that internally), and (2) you may include the &quot;.git&quot; at the end but it is optional.</p>
<p>If this step succeeds, you can add <a href="#users">users</a>, <a href="#repos">repos</a>, or anything else described <a href="#adminrepo">here</a>.</p>
<p>If this step fails, be sure to look at the <a href="#ssh">ssh</a> documentation before asking for help. (A very basic first step is to run <code>ssh git@host info</code>; <a href="#info">this</a> page tells you what to expect).</p>
<h3 id="appendix-administer-gitolite-directly-on-the-server"><span class="header-section-number">2.3.1</span> appendix: administer gitolite directly on the server</h3>
<p>The main use of managing gitolite via the admin repo is that you get to version control the access rules. But for large sites, there's another use: you can share the admin load with more people, <strong>without</strong> having to give all of them shell access on the server.</p>
<p>However, people who use puppet and similar systems already have a conf versioning and management system. And they'd like to continue to use that to manage gitolite repos and users, rather than be forced to do it through the gitolite-admin repo.</p>
<p>Such sites don't really need the admin repo at all, so here's how to get rid of it and run things directly on the server (which you can script into your puppet or similar software quite easily).</p>
<p>First the one-time stuff:</p>
<ul>
<li><p><a href="#install">install</a> the software as normal</p></li>
<li><p>run <code>gitolite setup -a dummy</code> instead of the normal <a href="#setup">setup</a> command</p></li>
<li><p>delete (or move away) <code>~/repositories/gitolite-admin.git</code></p></li>
<li><p>edit <code>~/.gitolite/conf/gitolite.conf</code> and remove the gitolite-admin repo and its access line.</p></li>
<li><p><code>mkdir ~/.gitolite/keydir</code> (because &quot;setup -a&quot; does not create it, but you will need it later to add keys).</p></li>
<li><p>run <code>gitolite compile; gitolite trigger POST_COMPILE</code></p></li>
</ul>
<p>To manage gitolite, you can directly edit files in <code>~/.gitolite</code> (or cause puppet to place files there), and then run the commands in the last step above. For example:</p>
<ul>
<li>copy someone's pubkey file to <code>~/.gitolite/keydir</code></li>
<li>edit <code>~/.gitolite/conf/gitolite.conf</code> and add a repo or three, giving access to some user(s)</li>
<li>run <code>gitolite compile; gitolite trigger POST_COMPILE</code></li>
</ul>
<p>That's it.</p>
<h2 id="syntax"><span class="header-section-number">2.4</span> basic syntax</h2>
<p>In general, everything is <strong>space separated</strong>; there are no commas, semicolons, etc., in the syntax.</p>
<p><strong>Comments</strong> are in the usual shell-ish style.</p>
<p><strong>User names</strong> and <strong>repo names</strong> are as simple as possible; they must start with an alphanumeric, but after that they can also contain <code>.</code>, <code>_</code>, or <code>-</code>.</p>
<p>Usernames can optionally be followed by an <code>@</code> and a domainname containing at least one <code>.</code> (this allows you to use an email address as someone's username).</p>
<p><strong>Group names</strong> are like simple usernames (i.e., not email addresses) but start with an <code>@</code> sign.</p>
<p>Reponames can contain <code>/</code> characters (this allows you to put your repos in a tree-structure for convenience).</p>
<p>There are no continuation lines by default. You do not need them; the section on <a href="#groups">groups</a> will tell you how you can break up large lists of names in a group definition into multiple lines.</p>
<p><font color="gray">If you <em>must</em> have them, you can optionally enable them; see the syntactic <a href="#sugar">sugar</a> section.</font></p>
<h3 id="include"><span class="header-section-number">2.4.1</span> include files</h3>
<p>Gitolite allows you to break up the configuration into multiple files and include them in the main file for convenience.</p>
<pre><code>include     &quot;foo.conf&quot;</code></pre>
<p>will include the contents of the file &quot;foo.conf&quot;.</p>
<p>Details:</p>
<ul>
<li><p>You can also use a glob (<code>include &quot;*.conf&quot;</code>), or put your include files into subdirectories of &quot;conf&quot; (<code>include &quot;foo/bar.conf&quot;</code>), or both (<code>include &quot;repos/*.conf&quot;</code>).</p></li>
<li><p>Included files are always searched from the gitolite-admin repo's &quot;conf/&quot; directory, unless you supplied an absolute path. (Note: in the interests of cloning the admin-repo sanely you should avoid absolute paths!)</p></li>
<li><p>If you ended up recursing, files that have been already processed once are skipped, with a warning.</p></li>
</ul>
<p><font color="gray">Advanced users: <code>subconf</code>, a command that is very closely related to <code>include</code>, is documented <a href="#subconf">here</a>.</font></p>
<h2 id="admin"><span class="header-section-number">2.5</span> gitolite administration</h2>
<h3 id="server"><span class="header-section-number">2.5.1</span> server-side administration</h3>
<p>The following activities require command line access to the server. They are usually one-time or rarely done activities.</p>
<ul>
<li>Changing anything in the <a href="#rc">rc</a> file.</li>
<li>Installing custom <a href="#hooks">hooks</a>, whether to all repos or just some repos.</li>
<li>Moving <a href="#existing">existing</a> repos into gitolite control.</li>
</ul>
<p>Please read the <a href="#WARNINGS">WARNINGS</a> page first.</p>
<h3 id="adminrepo"><span class="header-section-number">2.5.2</span> access control via the gitolite-admin repo</h3>
<p>Most day-to-day administration of a gitolite site happens like this:</p>
<ul>
<li><a href="#clone">clone</a> the gitolite-admin repo to your workstation</li>
<li>make appropriate changes</li>
<li>add, commit, and push</li>
</ul>
<h4 id="conf"><span class="header-section-number">2.5.2.1</span> the conf/gitolite.conf file</h4>
<p>Most of gitolite's power is in the conf/gitolite.conf file, which specifies detailed access control for repos. Everything except <a href="#users">adding users</a> happens from this file.</p>
<p>Here is an example of a simple conf/gitolite.conf file.</p>
<pre><code>    @staff              =   dilbert alice           # line 1
    @projects           =   foo bar                 # line 2

    repo @projects baz                              # line 3
        RW+             =   @staff                  # line 4
        -       master  =   ashok                   # line 5
        RW              =   ashok                   # line 6
        R               =   wally                   # line 7

        config hooks.emailprefix = '[%GL_REPO] '    # line 8</code></pre>
<p>Use the following links to learn more:</p>
<ul>
<li>The basic <a href="#syntax">syntax</a> -- comments, whitespace, include files, etc.</li>
<li>Defining <a href="#groups">groups</a>, as in lines 1 and 2.</li>
<li>Adding and removing <a href="#users">users</a>.</li>
<li>Adding and removing <a href="#repos">repos</a>, as in line 3.</li>
<li>Defining access <a href="#rules">rules</a>, as in lines 4, 5, 6, and 7.</li>
<li>Gitolite <a href="#options">options</a>.</li>
<li><a href="#git-config">Git config</a> keys and values, as in line 8.</li>
<li><a href="#wild">&quot;Wild&quot;</a> repos -- ad hoc, user-created, repos.</li>
</ul>
<h2 id="rules"><span class="header-section-number">2.6</span> access rules</h2>
<!-- pandoc: toc -->

<p><strong>NOTE</strong>: In the following description, &quot;user&quot; means &quot;user or a <a href="#groups">group</a> that he/she is a member of&quot;, and &quot;repo&quot; means &quot;repo, or a group that it is a member of, or a (<a href="#wild">wild</a> repo) pattern that matches it, or a group that contains a pattern that matches it&quot;.</p>
<h3 id="what-do-rules-look-like"><span class="header-section-number">2.6.1</span> what do rules look like</h3>
<p>Here's an example ruleset.</p>
<pre><code>@staff          =   dilbert alice wally bob

repo foo
    RW+         =   dilbert     # line 1
    RW+ dev     =   alice       # line 2
    -           =   wally       # line 3
    RW  temp/   =   @staff      # line 4
    R           =   ashok       # line 5</code></pre>
<p>A rule line has the structure</p>
<pre><code>&lt;permission&gt; &lt;zero or more refexes&gt; = &lt;one or more users/user groups&gt;</code></pre>
<p>The most commonly used permissions are:</p>
<ul>
<li>R, for read only</li>
<li>RW, for push existing ref or create new ref</li>
<li>RW+, for &quot;push -f&quot; or ref deletion allowed (i.e., destroy information)</li>
<li><code>-</code> (the minus sign), to <strong>deny</strong> access.</li>
</ul>
<p>There are also other, less commonly used, <a href="#write-types">types of permissions</a>.</p>
<p>A <a href="#refex">refex</a> is an expression that matches the ref (i.e., branch or tag) being pushed.</p>
<p><font color="gray">You can also use <a href="#vref">virtual refs</a> to perform extra checks and controls that you can't do with just the normal ref (like refs/heads/master) being pushed. The most common example is restricting pushes by dir/file name, but there are lots of other possibilities.</font></p>
<h3 id="how-are-the-rules-checked"><span class="header-section-number">2.6.2</span> how are the rules checked</h3>
<p>Note that gitolite first <a href="#rule-accum">accumulates the rules</a> before checking access.</p>
<h4 id="read-access----clone-fetch-archive"><span class="header-section-number">2.6.2.1</span> read access -- clone, fetch, archive</h4>
<p>Read access is checked only once, just before passing control to git-upload-pack or git-archive-pack. At this point gitolite only knows the repo name, the user name, and the fact that it is a read operation.</p>
<p>Here's the default flow:</p>
<ul>
<li><p>go through the <a href="#rule-accum">accumulated</a> rules for the repo in the sequence they appear in the conf file</p></li>
<li>for each rule:
<ul>
<li>skip the rule if it does not apply to this user</li>
<li>if the rule contains an &quot;R&quot; (i.e., it is &quot;R&quot;, &quot;RW&quot;, or any variant of &quot;RW&quot;), allow access and stop checking rules</li>
</ul></li>
<li><p>If no rule ends with a decision, (&quot;fallthru&quot;), deny access</p></li>
</ul>
<p>The <a href="#refex">refex</a> field is ignored for this check. (Git does not support distinguishing one ref from another for access control during read operations).</p>
<h5 id="deny-rules"><span class="header-section-number">2.6.2.1.1</span> read access respecting deny rules</h5>
<p>Deny rules (the &quot;-&quot; permission) are ignored by default. In our example, line 3 does not prevent wally from cloning the repo, because line 4 permits it.</p>
<p>You can change that by using the <code>deny-rules</code> <a href="#options">option</a>. If this option is active for a repo then this is the flow for access checking:</p>
<ul>
<li><p>go through the <a href="#rule-accum">accumulated</a> rule list for the repo in the sequence they appear in the conf file</p></li>
<li>for each rule:
<ul>
<li>skip the rule if it does not apply to this user</li>
<li>if it's a deny rule, deny access and stop checking rules</li>
<li>if the rule contains an &quot;R&quot; (i.e., it is &quot;R&quot;, &quot;RW&quot;, or any variant of &quot;RW&quot;), allow access and stop checking rules</li>
</ul></li>
<li><p>If no rule ends with a decision, (&quot;fallthru&quot;), deny access</p></li>
</ul>
<p>Apart from the extra check for deny rules, there is another very subtle but important difference here: the order of the rules matters now, where previously it did not.</p>
<p>Later in this document are a couple of <a href="#deny-rules-ex">examples</a> showing this option in use.</p>
<h4 id="write-access----push"><span class="header-section-number">2.6.2.2</span> write access -- push</h4>
<p>Write access is checked twice, once before passing control to git-receive-pack, and once from within the update hook.</p>
<p>The first check is identical to the one for read access, except of course the permission field must contain a &quot;W&quot;. As before, deny rules are ignored, and you can override that using the <a href="#deny-rules">deny-rules</a> option. The <a href="#refex">refex</a> field is also ignored, because at this point we don't know what refs are going to be pushed.</p>
<p>The <strong>second check</strong> happens from within the update hook. Deny rules <em>are</em> considered, which in turn means the <em>sequence</em> of the rules matters.</p>
<p>Also, this time, git supplies us with three more pieces of information: the name of the ref being updated (like &quot;refs/heads/master&quot;), the old SHA, and the new SHA. This information is sufficient to determine whether this is a normal push or a forced, (a.k.a rewind), push. A normal push requires the permission field to contain a &quot;W&quot;, while a forced push requires it to contain a &quot;+&quot;.</p>
<p>Here's how the actual rule matching happens:</p>
<ul>
<li><p>go through the <a href="#rule-accum">accumulated</a> rule list for the repo in the sequence they appear in the conf file</p></li>
<li>for each rule:
<ul>
<li>skip the rule if it does not apply to this user</li>
<li>If the ref does not match the <a href="#refex">refex</a>, skip the rule</li>
<li>If it's a deny rule, deny access and stop checking rules</li>
<li>If the permission field matches the specific <a href="#write-types">type of write</a> operation, allow access and stop checking rules</li>
</ul></li>
<li><p>If no rule ends with a decision, (&quot;fallthru&quot;), deny access</p></li>
</ul>
<p>Now all you need is to understand how <a href="#refex">refex</a> matching happens and how the permissions match the various <a href="#write-types">types of write operations</a>.</p>
<h3 id="permsum"><span class="header-section-number">2.6.3</span> summary of permissions</h3>
<p>The full set of permissions, in regex syntax, is <code>-|R|RW+?C?D?M?</code>. This expands to one of <code>-</code>, <code>R</code>, <code>RW</code>, <code>RW+</code>, <code>RWC</code>, <code>RW+C</code>, <code>RWD</code>, <code>RW+D</code>, <code>RWCD</code>, or <code>RW+CD</code>, all but the first two optionally followed by an <code>M</code>. And by now you know what they all mean.</p>
<h3 id="additional-topics"><span class="header-section-number">2.6.4</span> additional topics</h3>
<h4 id="rule-accum"><span class="header-section-number">2.6.4.1</span> rule accumulation</h4>
<p>Gitolite was meant to collect rules from multiple places and apply them all in sequence. For example, if you have the following (we've added line numbers to aid later explanation):</p>
<pre><code> 1  # we have 3 specifically named FOSS projects, but we also consider any
 2  # project in the foss/ directory to be FOSS.
 3  @FOSS-projects  =   git gitolite linux foss/..*

 4  # similarly for proprietary projects
 5  @prop-projects  =   foo bar baz prop/..*

 6  # our users are divided into staff, interns, and bosses
 7  @staff          =   alice dilbert wally
 8  @interns        =   ashok
 9  @bosses         =   PHB

10  # we have certain policies.  The first is that FOSS projects are readable
11  # by everyone
12  repo @FOSS-projects
13      R   =   @all

14  # the second is that bosses can read any repo if they wish to
15  repo @all
16      R   =   @bosses

17  # now we have specific rules for specific projects
18  repo git
19      RW+ =   junio
20      ...some other rules...

21  repo gitolite
22      RW+ =   sitaram
23      ...some other rules...

24  ...etc...</code></pre>
<p>the <strong>effective</strong> rule list for, say, the &quot;gitolite&quot; repo will be (keeping the line numbers the same so you know where they are coming from):</p>
<pre><code>13      R   =   @all            # since it is a member of @FOSS-projects
16      R   =   @bosses         # since every repo is a member of @all anyway
22      RW+ =   sitaram         # from the gitolite-specific ruleset
23      ...some other rules...  # from the gitolite-specific ruleset</code></pre>
<p>As you can see, for each user+repo combination, several rules will apply. Gitolite combines them all into one list (in the sequence they are found in the conf file), before applying the access checks.</p>
<p>This extends to patterns also. For example, if you have this:</p>
<pre><code>repo foss/apache
    ...some rules...</code></pre>
<p>then, because this repo fits the pattern <code>foss/..*</code>, it is considered part of the @FOSS-projects group, so all the rules that apply to that group are in play when someone accesses foss/apache.</p>
<p>This is what we meant by &quot;repo, or a group that it is a member of, or a (<a href="#wild">wild</a> repo) pattern that matches it, or a group that contains a pattern that matches it&quot;, up at the top of this document.</p>
<h4 id="deny-rules-ex"><span class="header-section-number">2.6.4.2</span> examples of deny rules</h4>
<p><strong>example 1</strong></p>
<pre><code> 1  @secret = secret/one secret/two [...]

 2  # put this at or near the top of the conf file, or at least before any
 3  # rules that give 'gitweb' and 'daemon' any kind of access
 4  repo @secret
 5      -   =   gitweb daemon
 6      option deny-rules = 1
 7      # make sure you do not set deny-rules to 0 for these repos later

 8  repo @all
 9      R   =   gitweb daemon

10  &lt;...other rules...&gt;</code></pre>
<p>In this example, we have lots of repos, which should all be accessible by gitweb or daemon, so we want the convenience provided by lines 8 and 9 (we don't want to put line 9 in <em>each</em> repo). However, we also have some secret repos, which we are able to list explicitly in some way, and we want to prevent gitweb or daemon from seeing them.</p>
<p>Therefore we apply the &quot;deny-rules&quot; option to just those repos, and ensure that the first rule encountered by these two &quot;users&quot; for those repos is a deny rule. This makes gitolite deny read access to those users for those repos.</p>
<p><strong>example 2</strong></p>
<p>In this example the &quot;open&quot; repos are fewer in number, so it is the opposite situation to the above in terms of our ability to enumerate all the repos.</p>
<pre><code>@open = git gitolite foss/..* [...]

# put this at or near the top of the conf file, or at least before any
# rules that give 'gitweb' and 'daemon' any access
repo @all
    -   =   gitweb daemon
    option deny-rules = 1

repo @open
    R   =   gitweb daemon
    option deny-rules = 0
    # make sure you do not set deny-rules to 1 for these repos later</code></pre>
<p>To see why this works, you need to remember that for <a href="#options">options</a> and <a href="#git-config">config</a> lines, a later setting <a href="#override_conf">overrides</a> earlier ones. So we set it to 1 for all repos, then selectively set it to 0 for some.</p>
<p>This means the &quot;deny-rules&quot; option applies to <em>all the repos except the &quot;open&quot; repos</em>. For such repos, the first rule encountered by gitweb and daemon is a deny rule, so they are denied read access.</p>
<h3 id="refex"><span class="header-section-number">2.6.5</span> matching a ref and a refex</h3>
<p>A refex is a word I made up to mean &quot;a regex that matches a ref&quot;. If you know <a href="#regex">regular expressions</a> you're halfway there.</p>
<p>In addition:</p>
<ul>
<li><p>If no refex is supplied, it defaults to <code>refs/.*</code>, for example in a rule like this:</p>
<pre><code>RW              =   alice</code></pre></li>
<li><p>A refex not starting with <code>refs/</code> <font color="gray">(or <code>VREF/</code>)</font> is assumed to start with <code>refs/heads/</code>. This means normal branches can be conveniently written like this:</p>
<pre><code>RW  master      =   alice
# becomes 'refs/heads/master' internally</code></pre>
<p>while tags will need to be fully qualified</p>
<pre><code>RW  refs/tags/v[0-9]    =   bob</code></pre></li>
<li><p>A refex is implicitly anchored at the start, but not at the end. In regular expression lingo, a <code>^</code> is assumed at the start (but no <code>$</code> at the end is assumed). So a refex of <code>master</code> will match all these:</p>
<pre><code>refs/heads/master
refs/heads/master1
refs/heads/master2
refs/heads/master/full</code></pre>
<p>If you want to restrict the match to just the one specific ref, use</p>
<pre><code>RW  master$     =   alice</code></pre></li>
</ul>
<h2 id="write-types"><span class="header-section-number">2.7</span> different types of write operations</h2>
<p>Git supplies enough information to the update hook to be able to distinguish several types of writes.</p>
<p>The most common are:</p>
<ul>
<li><code>RW</code> -- create a ref or fast-forward push a ref. No rewinds or deletes.</li>
<li><code>RW+</code> -- create, fast-forward push, rewind push, or delete a ref.</li>
</ul>
<p>Sometimes you want to allow people to push, but not <em>create</em> a ref. Or rewind, but not <em>delete</em> a ref. The <code>C</code> and <code>D</code> qualifiers help here.</p>
<ul>
<li><p>When a rule specifies <code>RWC</code> or <code>RW+C</code>, then <em>rules that do NOT have the C qualifier will no longer permit <strong>creating</strong> a ref</em>.</p>
<p><font color="gray">Please do not confuse this with the standalone <code>C</code> permission that allows someone to <a href="#create">create</a> a <strong>repo</strong></font></p></li>
<li><p>When a rule specifies <code>RWD</code> or <code>RW+D</code>, then <em>rules that do NOT have the D qualifier will no longer permit <strong>deleting</strong> a ref</em>.</p></li>
</ul>
<p>Note: These two can be combined, so you can have <code>RWCD</code> and <code>RW+CD</code> as well.</p>
<p>One very rare need is to reject merge commits (a commit series that is not a straight line of commits). The <code>M</code> qualifier helps here:</p>
<ul>
<li>When a rule has <code>M</code> appended to the permissions, <em>rules that do NOT have it will reject a commit sequence that contains a merge commit</em> (i.e., they only accept a straight line series of commits).</li>
</ul>
<h1 id="s3"><span class="header-section-number">3</span> the rc file, git-config, and options</h1>
<h2 id="rc"><span class="header-section-number">3.1</span> the &quot;rc&quot; file (<code>$HOME/.gitolite.rc</code>)</h2>
<p><strong>IMPORTANT</strong>: if you have a v3.0-v3.3 rc file it will still work. In fact internally the v3.4 rc file data gets converted to the v3.3 format. So just because you upgraded gitolite doesn't mean you have to change your rc file!</p>
<p><strong>v3.3 or before</strong>: [this][rc-33] is the document you need.</p>
<p><strong>NOTE 2</strong>: if you're migrating from g2, there are some settings that MUST be dealt with <strong>before</strong> running <code>gitolite setup</code>; please read the <a href="#migr">migration</a> page and linked pages, and especially the one on &quot;presetting the rc file&quot;</p>
<hr />
<p>The rc file for g3 is <em>quite</em> different from that of g2. The change affects <a href="#triggers">triggers</a> more than anything else, and to a very small extent <a href="#commands">commands</a>. Please see those links for details, especially if you want to add your own triggers or commands.</p>
<p>As before, it is designed to be the only thing unique to your site for most setups. What is new is that it is easy to extend it when new needs come up, without having to touch core gitolite.</p>
<p>The rc file is perl code, but you do NOT need to know perl to edit it. Just mind the commas, use single quotes unless you know what you're doing, and make sure the brackets and braces stay matched up!</p>
<p>Please look at the <code>~/.gitolite.rc</code> file that gets installed when you setup gitolite. As you can see there are 3 types of variables in it:</p>
<ul>
<li>a lot of simple variables (like <code>UMASK</code>, <code>GIT_CONFIG_KEYS</code>, etc)</li>
<li>a hash or two (like <code>ROLES</code>)</li>
<li>and one large list of features to be enabled (<code>ENABLE</code>)</li>
</ul>
<p>While some of the variables are documented in this file, many of them are not. Their purposes are to be found in each of their individual documentation files around; start with <a href="#cust">customising gitolite</a>. If a setting is used by an external command then running that command with '-h' may give you additional information.</p>
<h3 id="specific-variables"><span class="header-section-number">3.1.1</span> specific variables</h3>
<ul>
<li><p><code>$UMASK</code>, octal, default <code>0077</code></p>
<p>The default UMASK that gitolite uses makes all the repos and their contents have <code>rwx------</code> permissions. People who want to run gitweb (or cgit, redmine, etc) realise that this will not do.</p>
<p>The correct way to deal with this is to give this variable a value like <code>0027</code> (note the syntax: the leading 0 is required), and then make the user running the webserver (apache, www-data, whatever) a member of the 'git' group.</p>
<p>If you've already installed gitolite then existing files will have to be fixed up manually (for a umask or 0027, that would be <code>chmod -R g+rX</code>). This is because umask only affects permissions on newly created files, not existing ones.</p></li>
<li><p><code>$GIT_CONFIG_KEYS</code>, string, default empty</p>
<p>This setting allows the repo admin to define acceptable gitconfig keys.</p>
<p>Gitolite allows you to set git config values using the &quot;config&quot; keyword; see <a href="#git-config">here</a> for details and syntax.</p>
<p>However, if you are in an installation where the repo admin does not (and should not) have shell access to the server, then allowing him to set arbitrary repo config options <em>may</em> be a security risk -- some config settings allow executing arbitrary commands!</p>
<p>You have 3 choices. By default <code>$GIT_CONFIG_KEYS</code> is left empty, which completely disables this feature (meaning you cannot set git configs via the repo config).</p>
<p>The second choice is to give it a space separated list of settings you consider safe. (These are actually treated as a set of <a href="#regex">regular expression</a> patterns, and any one of them must match).</p>
<p>For example:</p>
<pre><code>$GIT_CONFIG_KEYS = 'core\.logAllRefUpdates core\..*compression';</code></pre>
<p>Each pattern should match the <em>whole</em> key (in other words, there is an implicit <code>^</code> at the start of each pattern, and a <code>$</code> at the end).</p>
<p>The third choice (which you may have guessed already if you're familiar with regular expressions) is to allow anything and everything: <code>$GIT_CONFIG_KEYS = '.*';</code></p></li>
<li><p><code>ROLES</code>, hash, default keys 'READERS' and 'WRITERS'</p>
<p>This specifies the role names allowed to be used by users running the <a href="#perms">perms</a> command. The <a href="#wild">wild</a> repos doc has more info on roles.</p></li>
<li><p><code>OWNER_ROLENAME</code>, string, default undef</p>
<p>(requires v3.5 or later)</p>
<p>By default, permissions on a wild repo can only be set by the <em>creator</em> of the repo (using the <a href="#perms">perms</a> command). But some sites want to allow other people to do this as well.</p>
<p>To enable this behaviour, the server admin must first set this variable to some string, say 'OWNERS'. (He must also add 'OWNERS' to the ROLES hash described in the previous bullet).</p>
<p>The creator of the repo can then add other users to the OWNERS role using the <a href="#perms">perms</a> command.</p>
<p>The <a href="#perms">perms</a> command, the new &quot;owns&quot; command, and possibly other commands in future, will then give these users the same privileges that they give to the creator of the repo.</p>
<p>(Also see the full documentation on <a href="#roles">roles</a>).</p></li>
<li><p><code>LOCAL_CODE</code>, string</p>
<p>This is described in more detail <a href="#localcode">here</a>. Please be aware <strong>this must be a FULL path</strong>, not a relative path.</p></li>
</ul>
<h2 id="git-config"><span class="header-section-number">3.2</span> &quot;git-config&quot; keys and values</h2>
<!-- pandoc: toc -->

<p>Here's all you want to know about setting repo-specific git-config values.</p>
<p>(Original version thanks to teemu dot matilainen at iki dot fi)</p>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p><strong>Note</strong>: this won't work unless the rc file has the right settings; please see <code>$GIT_CONFIG_KEYS</code> in the <a href="#rc">rc file doc</a>.</p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<h3 id="basic-syntax"><span class="header-section-number">3.2.1</span> basic syntax</h3>
<p>The syntax is simple:</p>
<pre><code>config sectionname.keyname = value</code></pre>
<p>For example:</p>
<pre><code>repo gitolite
    config hooks.mailinglist = gitolite-commits@example.tld
    config hooks.emailprefix = &quot;[gitolite] &quot;
    config foo.bar = &quot;&quot;</code></pre>
<p>This does either a plain &quot;git config section.key value&quot; (for the first 2 examples above) or &quot;git config --unset-all section.key&quot; (for the last example). Other forms of the <code>git config</code> command (<code>--add</code>, the <code>value_regex</code>, etc) are not supported.</p>
<h4 id="an-important-warning-about-deleting-a-config-line"><span class="header-section-number">3.2.1.1</span> an important warning about <strong>deleting</strong> a config line</h4>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p><strong>WARNING</strong>: simply deleting the config line from the <code>conf/gitolite.conf</code> file will <em>not</em> delete the variable from <code>repo.git/config</code>. You have to use the syntax in the last example to make gitolite execute a <code>--unset-all</code> operation on the given key.</p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<h3 id="substituting-the-repo-name-and-the-creator-name"><span class="header-section-number">3.2.2</span> substituting the repo name and the creator name</h3>
<p>You can also use the special values <code>%GL_REPO</code> and <code>%GL_CREATOR</code> in the string. The former is available to all repos, while the latter is only available to <a href="#wild">wild</a> repos.</p>
<pre><code>repo foo bar baz
    config hooks.mailinglist = %GL_REPO-commits@example.tld
    config hooks.emailprefix = &quot;[%GL_REPO] &quot;</code></pre>
<h3 id="override_conf"><span class="header-section-number">3.2.3</span> overriding config values</h3>
<p>You can repeat the 'config' line as many times as you like, and the <em>last</em> occurrence will be the one in effect. This allows you to override settings just for one project, as in this example:</p>
<pre><code>repo @all
    config hooks.mailinglist = %GL_REPO-commits@example.tld
    config hooks.emailprefix = &quot;[%GL_REPO] &quot;

repo customer-project
    # different mailing list
    config hooks.mailinglist = announce@customer.tld</code></pre>
<p>The &quot;delete config variable&quot; syntax can also be used, if you wish:</p>
<pre><code>repo secret     # no emails for this one please
    config hooks.mailinglist = &quot;&quot;
    config hooks.emailprefix = &quot;&quot;</code></pre>
<p>As you can see, the general idea is to place the most generic ones (<code>repo @all</code>, or repo patterns like <code>repo foo.*</code>) first, and place more specific ones later to override the generic settings.</p>
<h3 id="compensating-for-unsafe_patt"><span class="header-section-number">3.2.4</span> compensating for <code>UNSAFE_PATT</code></h3>
<p>Gitolite, by default, does not allow the following characters in the value of a config variable: <code>` ~ # $ &amp; ( ) | ; &lt; &gt;</code>. This is due to unspecified paranoia (and arguably only applies if your gitolite admin folks do not, and should not, have shell access to the server); see <a href="https://groups.google.com/d/topic/gitolite/9WNsA-Axmg4/discussion">this discussion</a> for some context. This restriction is enforced by a regex called <code>UNSAFE_PATT</code>, whose default value is <code>[`~#\$\&amp;()|;&lt;&gt;]</code>.</p>
<p>You can override this by placing a modified version in the rc file. For example, if you wanted to allow this (which contais a semicolon):</p>
<pre><code>config hooks.showrev = &quot;git show -C %s; echo&quot;</code></pre>
<p>you'd put the follwing line at the end of your rc file (notice there is no semicolon in the pattern here):</p>
<pre><code>$UNSAFE_PATT          = qr([`~#\$\&amp;()|&lt;&gt;]);</code></pre>
<p>Now, while this is fine for sites where the repo admins already have shell access to the server, it is too generous othewise, and may lead to a future compromise somewhere else that you did not anticipate.</p>
<p>Here's a better way:</p>
<ul>
<li><p>in the rc file, add the following within the '%RC' hash (for example, just after the UMASK line would do fine):</p>
<pre><code>SAFE_CONFIG                 =&gt;
    {
        SHOWREV             =&gt;  &quot;git show -C %s; echo&quot;
    },</code></pre></li>
<li><p>in your gitolite.conf file, add this instead of the line we saw earlier:</p>
<pre><code>config hooks.showrev = %SHOWREV</code></pre></li>
</ul>
<p>This mechanism allows you to add any number of <strong>specific</strong> violations to the <code>UNSAFE_PATT</code> rule instead of denaturing the pattern itself and potentially allowing something that could be used by a repo admin to obtain shell access at some later point in time.</p>
<h2 id="options"><span class="header-section-number">3.3</span> gitolite options</h2>
<p>Some gitolite features are enabled, or gitolite's behaviour changed, by setting &quot;options&quot;.</p>
<p>A line like 'option foo = 1' is really just syntactic sugar for 'config gitolite-options.foo = 1', so everything in the <a href="#git-config">git-config</a> page also applies here (especially the bit about <a href="#override_conf">overriding config values</a>).</p>
<p><strong>However</strong>, these values are <strong>not</strong> written into git's own <code>config</code> file, so git (or other programs running <code>git config</code>) will not see them. You can only query them using <code>gitolite git-config</code>, where they will appear in full in the output.</p>
<p>Options are set by repo. The syntax is very simple:</p>
<pre><code>option  foo.bar     =   baz</code></pre>
<p>Of course this is useless if some other part of gitolite, or some external command, is not querying for the option key 'foo.bar'!</p>
<p>Options are therefore documented in the section/page they belong in, not here. Here are some examples, although this list is not exhaustive:</p>
<ul>
<li><p><a href="#deny-rules">deny-rules</a> -- ask gitolite to honor deny rules during the pre-git check also.</p></li>
<li><p><a href="#mirroring">mirroring</a> related options -- tell gitolite who is the master server, and who are the slaves, for each repo.</p></li>
<li><p>the optional post-compile trigger 'update-gitweb-daemon-from-options' allows you to use options instead of special usernames gitweb and daemon to determine access for those tools.</p></li>
<li><p>you can set <a href="#rsev">repo-specific environment variables</a> for triggers and hooks to test, which is very useful.</p></li>
</ul>
<p>Here's how to disable an option from a single repo if it was enabled earlier in a group (which you might guess from reading the <a href="#git-config">git-config</a> page):</p>
<pre><code>@g = r1 r2 r3

repo @g
    option gitweb = 1

# but repo r2 should not be accessible by gitweb
repo r2
    option gitweb = &quot;&quot;</code></pre>
<h2 id="external"><span class="header-section-number">3.4</span> interfacing with external tools</h2>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p><strong>Note</strong>: The old gitolite (v1.x, v2.x) used to tie itself into knots dealing with gitweb and daemon. One of the goals of g3 was to get out of that game, which your author does not play anyway. This means statements like &quot;...special user called 'gitweb'...&quot; really apply to the <a href="#non-core">non-core</a> programs that gitolite ships with, not to &quot;core&quot; gitolite, and any or all of this functionality can be disabled by commenting out certain lines in the <a href="#rc">rc</a> file.</p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p>Also, <strong>note</strong> that gitolite does <strong>not</strong> install or configure gitweb/git-daemon -- that is a one-time setup you must do separately.</p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<h3 id="gitweb"><span class="header-section-number">3.4.1</span> gitweb</h3>
<p>The following repos are deemed to be readable by gitweb:</p>
<ul>
<li>any repos readable by the special user <code>gitweb</code></li>
<li><p>any repos containing one or more of the following types of lines: (actually, any config variable starting with <code>gitweb.</code>).</p>
<pre><code>config gitweb.owner         =   owner name
config gitweb.description   =   some description
config gitweb.category      =   some category</code></pre>
<p>Side note: the following shorter forms are available as <a href="#sugar">syntactic sugar</a> for the above longer forms:</p>
<pre><code>owner       =   owner name
desc        =   some description
category    =   some category</code></pre></li>
</ul>
<p>The list of gitweb-readable repos is written to a file whose name is given by the <a href="#rc">rc</a> file variable <code>GITWEB_PROJECTS_LIST</code>. The default value of this variable, if it is not specified or empty, is <code>$HOME/projects.list</code>.</p>
<p>In addition, each of the config variables described above is written to the repo to which it pertains, so that gitweb can use them.</p>
<h4 id="umask"><span class="header-section-number">3.4.1.1</span> changing the UMASK</h4>
<p>Gitweb (or cgit, redmine, etc.) typically runs under a different userid, and the default permissions that gitolite sets make them unreadable.</p>
<p>See the section on the <code>UMASK</code> variable in the documentation for the <a href="#rc">rc file</a>.</p>
<h4 id="repo-specific-authorisation-in-gitweb"><span class="header-section-number">3.4.1.2</span> repo-specific authorisation in gitweb</h4>
<p>Gitweb has a feature whereby it will call a (perl) function that you supply, passing it the full path to the repo being accessed. If the remote user is authenticated, the username will be available, so your function can take those two pieces of information and return true or false to allow or deny the repository access.</p>
<p>If you want to use gitolite's access rules in making this determination, you will first have to ensure that the HTTP username (i.e., the username known to apache/gitweb) is the same as the gitolite username. If you're using gitolite's <a href="#http">http</a> mode, this is probably already true, but if you're using the more widely used ssh mode, you'll have to make sure they match.</p>
<p>You then need to add <a href="gitweb.conf.html">this code</a> to your gitweb.conf.</p>
<h3 id="git-daemon"><span class="header-section-number">3.4.2</span> git-daemon</h3>
<p>Any repo readable by the special user <code>daemon</code> is deemed to be readable by git-daemon. For each of these repos, an empty file called <code>git-daemon-export-ok</code> is created in the repository (i.e., the <code>repo.git</code> directory inside <code>$HOME/repositories</code>).</p>
<h3 id="tips"><span class="header-section-number">3.4.3</span> tips</h3>
<p>Setting descriptions en-masse usually does not make sense, but you can certainly do things like</p>
<pre><code>repo @all
    R       =   gitweb daemon</code></pre>
<p>assuming you have other means of setting 'gitweb.description' and 'gitweb.owner'.</p>
<p>Also see <a href="#deny-rules">this</a> for a twist on that.</p>
<h1 id="s4"><span class="header-section-number">4</span> wild repos, mirroring, and other features</h1>
<h2 id="wild"><span class="header-section-number">4.1</span> &quot;wild&quot; repos (user created repos)</h2>
<!-- pandoc: toc -->

<h3 id="quick-introduction"><span class="header-section-number">4.1.1</span> quick introduction</h3>
<p>The wildrepos feature allows you to specify access control rules using regular expression patterns, so you can have many actual repos being served by a single set of rules in the config file. The regex pattern can also include the word <code>CREATOR</code> in it, allowing you to parametrise the name of the user creating the repo.</p>
<p>See the section on &quot;repo patterns&quot; later for additional information on what counts as a &quot;wild&quot; repo pattern and how it is matched.</p>
<h3 id="admin-declaring-wild-repos-in-the-conf-file"><span class="header-section-number">4.1.2</span> (admin) declaring wild repos in the conf file</h3>
<p>Here's an example:</p>
<pre><code>@prof       =   u1
@TAs        =   u2 u3
@students   =   u4 u5 u6

repo    assignments/CREATOR/a[0-9][0-9]
    C   =   @students
    RW+ =   CREATOR
    RW  =   WRITERS @TAs
    R   =   READERS @prof</code></pre>
<p>Note the &quot;C&quot; permission. This is a standalone &quot;C&quot;, which gives the named users the right to <em>create a repo</em>. <font color="gray">This is not to be confused with the &quot;RWC&quot; or its variants described elsewhere, which are about <em>branches</em>, not <em>repos</em>.</font></p>
<h3 id="create"><span class="header-section-number">4.1.3</span> (user) creating a specific repo</h3>
<p>For now, ignore the special usernames READERS and WRITERS, and just create a new repo, as user &quot;u4&quot; (a student):</p>
<pre><code>$ git clone git@server:assignments/u4/a12
Initialized empty Git repository in /home/sitaram/a12/.git/
Initialized empty Git repository in /home/git/repositories/assignments/u4/a12.git/
warning: You appear to have cloned an empty repository.</code></pre>
<p>Notice the <em>two</em> empty repo inits, and the order in which they occur ;-)</p>
<h3 id="a-slightly-different-example"><span class="header-section-number">4.1.4</span> a slightly different example</h3>
<p>Here's how the same example would look if you did not want the CREATOR's name to be part of the actual repo name.</p>
<pre><code>repo    assignments/a[0-9][0-9]
    C   =   @students
    RW+ =   CREATOR
    RW  =   WRITERS @TAs
    R   =   READERS @prof</code></pre>
<p>We haven't changed anything except the repo name pattern. This means that the first student that creates, say, <code>assignments/a12</code> becomes the owner. Mistakes (such as claiming a12 instead of a13) need to be rectified by an admin logging on to the back end, though it's not too difficult.</p>
<p>You could also repace the C line like this:</p>
<pre><code>    C   =   @TAs</code></pre>
<p>and have a TA create the repos in advance.</p>
<h3 id="repo-patterns"><span class="header-section-number">4.1.5</span> repo patterns</h3>
<h4 id="pattern-versus-normal-repo"><span class="header-section-number">4.1.5.1</span> pattern versus normal repo</h4>
<p>Due to projects like <code>gtk+</code>, the <code>+</code> character is now considered a valid character for an <em>ordinary</em> repo. Therefore, a pattern like <code>foo/.+</code> does not look like a regex to gitolite. Use <code>foo/..*</code> if you want that.</p>
<p>Also, <code>..*</code> by itself is not considered a valid repo pattern. Try <code>[a-zA-Z0-9].*</code>. <code>CREATOR/..*</code> will also work.</p>
<h4 id="line-anchored-regexes"><span class="header-section-number">4.1.5.2</span> line-anchored regexes</h4>
<p>A regex like</p>
<pre><code>repo assignments/S[0-9]+/A[0-9]+</code></pre>
<p>would match <code>assignments/S02/A37</code>. It will not match <code>assignments/S02/ABC</code>, or <code>assignments/S02/a37</code>, obviously.</p>
<p>But you may be surprised to find that it does not match even <code>assignments/S02/A37/B99</code>. This is because internally, gitolite <em>line-anchors</em> the given regex; so that regex actually becomes <code>^assignments/S[0-9]+/A[0-9]+$</code> -- notice the line beginning and ending metacharacters.</p>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p><em>Side-note: contrast with refexes</em></p>
</blockquote>
<blockquote>
<p>Just for interest, note that this is in contrast to the refexes for the normal &quot;branch&quot; permissions, as described in <code>doc/gitolite.conf.mkd</code> and elsewhere. These &quot;refexes&quot; are only anchored at the start; a pattern like <code>refs/heads/master</code> actually can match <code>refs/heads/master01/bar</code> as well, even if no one will actually push such a branch! You can anchor both sides if you really care, by using <code>master$</code> instead of <code>master</code>, but that is <em>not</em> the default for refexes.</p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<h3 id="roles"><span class="header-section-number">4.1.6</span> roles</h3>
<p>The tokens READERS and WRITERS are called &quot;role&quot; names. The access rules in the conf file decide what permissions these roles have, but they don't say what users are in each of these roles.</p>
<p>That needs to be done by the creator of the repo, using the <code>perms</code> command. You can run <code>ssh git@host perms -h</code> for detailed help, but in brief, that command lets you give and take away roles to users. <a href="#perms">This</a> has some more detail.</p>
<h4 id="adding-other-roles"><span class="header-section-number">4.1.6.1</span> adding other roles</h4>
<p>If you want to have more than just the 2 default roles, say something like:</p>
<pre><code>repo foo/..*
  C                 =   u1
  RW    refs/tags/  =   TESTERS
  -     refs/tags/  =   @all
  RW+               =   WRITERS
  RW                =   INTERNS
  R                 =   READERS
  RW+D              =   MANAGERS</code></pre>
<p>You can add the new names to the ROLES hash in the <code>~/.gitolite.rc</code> file; see comments in that file for how to do that. Be sure to run the 2 commands mentioned there after you have added the roles.</p>
<h5 id="rolenamewarn"><span class="header-section-number">4.1.6.1.1</span> <font color="red"><strong>IMPORTANT WARNING ABOUT THIS FEATURE</strong></font></h5>
<p>Please make sure that none of the role names conflict with any of the user names or group names in the system. For example, if you have a user called &quot;foo&quot; or a group called &quot;@foo&quot;, make sure you do not include &quot;foo&quot; as a valid role in the ROLES hash.</p>
<p>You can keep things sane by using UPPERCASE names for roles, while keeping all your user and group names lowercase; then you don't have to worry about this problem.</p>
<h4 id="setting-default-roles"><span class="header-section-number">4.1.6.2</span> setting default roles</h4>
<p>You can setup some default role assignments as soon as a new wild repo is created.</p>
<p>Here's how:</p>
<ul>
<li><p>enable the 'set-default-roles' feature in the rc file by uncommenting it if it is already present or adding it to the ENABLE list if it is not.</p></li>
<li><p>supply a set of default role assignments for a wild repo pattern by adding lines like this to the repo config para:</p>
<pre><code>option default.roles-1  =   READERS @all
option default.roles-2  =   WRITERS @senior-devs</code></pre></li>
</ul>
<p>This will then behave as if the <a href="#perms">perms</a> command was used immediately after the repo was created to add those two role assignments.</p>
<p>If you want to simulate the old (pre v3.5) <code>DEFAULT_ROLE_PERMS</code> rc file variable, just add them under a <code>repo @all</code> line. (Remember that this only affects newly created wild repos, despite the '@all' name).</p>
<h4 id="specifying-owners"><span class="header-section-number">4.1.6.3</span> specifying owners</h4>
<p>See the section on <code>OWNER_ROLENAME</code> in the <a href="#rc">rc file documentation</a>.</p>
<h3 id="listing-wild-repos"><span class="header-section-number">4.1.7</span> listing wild repos</h3>
<p>In order to see what repositories were created from a wildcard, use the 'info' command. Try <code>ssh git@host info -h</code> to get help on the info command.</p>
<h3 id="deleting-a-wild-repo"><span class="header-section-number">4.1.8</span> deleting a wild repo</h3>
<p>Run the whimsically named &quot;D&quot; command -- try <code>ssh git@host D -h</code> for more info on how to delete a wild repo. (Yes the command is &quot;D&quot;; it's meant to be a counterpart to the &quot;C&quot; permission that allowed you to create the repo in the first place). Of course this only works if your admin has enabled the command (gitolite ships with the command disabled for remote use).</p>
<h2 id="mirroring"><span class="header-section-number">4.2</span> mirroring using gitolite</h2>
<!-- pandoc: toc -->

<p><font color="red"><strong>WARNING</strong> existing gitolite mirroring users please note: <strong>there are <a href="#g2i-mirroring">significant changes</a></strong> in syntax and usage compared to g2. If you're not the kind who reads documentation before doing serious system admin things, well... good luck!</font></p>
<hr />
<p>Mirroring is simple: you have one &quot;master&quot; server and one or more &quot;slave&quot; servers. The slaves get updates only from the master; to the rest of the world they are at best read-only.</p>
<p>Gitolite extends this simple notion in the following ways:</p>
<ul>
<li><p>Different masters and sets of slaves for different repos</p>
<p>This lets you do things like:</p>
<ul>
<li>Use the server closest to <em>most</em> of its developers as the master for that repo.</li>
<li>Not mirror a repo at all to some servers.</li>
<li>Have repos that are purely local to a server (not mirrored at all).</li>
<li>Negotiate mirroring with servers that are not even under your control.</li>
<li>Push to a slave on demand or via cron (helps deal with bandwidth or connectivity constraints).</li>
</ul></li>
<li><p>Pushes to a slave can be transparently forwarded to the real master.</p>
<p>Your developers need not worry about where a repo's master is -- they just write to their local mirror for <em>all</em> repos, even if their local mirror is only a slave for some.</p></li>
</ul>
<h3 id="caveats"><span class="header-section-number">4.2.1</span> caveats</h3>
<ul>
<li><p>Mirroring will never <em>create</em> a repo on a slave; it has to exist and be prepared to receive updates from the master.</p>
<p>However, there is limited support for auto-creating wild card repos and sending 'perms' info across, with the following caveats at present. (Some of this text won't make sense unless you know what those features are).</p>
<ul>
<li><p><em>WARNING: it does NOT make sense to mirror wild repos in setups where the authentication data is not the same (i.e., where &quot;alice&quot; on the master and &quot;alice&quot; on a slave maybe totally different people)</em>.</p></li>
<li><p>This has only been minimally tested. For example, complex setups or asymmetric configs on master and slave, etc. have NOT been tested.</p></li>
<li><p>Permission changes will only propagate on the next 'git push'. Of course, if you know the name of the slave server, you can run</p>
<pre><code>ssh git@host mirror push slave-server-name repo-name</code></pre></li>
<li><p>Using 'perms' on a slave is allowed but will neither propagate nor persist. They will be overwritten by whatever perms the master has (even if it is an empty set) on the next 'git push'.</p></li>
<li><p>As with lots of extra features in gitolite, smart http support is not on my radar. Don't ask.</p></li>
</ul>
<p>Please test it out and let me know if something surprising happens. Be aware that I have been known to claim bugs are features if I don't have time to fix them immediately :-)</p></li>
<li><p>Mirroring is only for git repos. Ancillary files like gl-creator and gl-perms in the repo directory are not mirrored; you must do that separately. Files in the admin directory (like log files) are also not mirrored.</p></li>
<li><p>If you ever do a <a href="#bypass">bypass push</a>, mirroring will not work. Mirroring checks also will not work -- for example, you can push to a slave, which is not usually a good idea. So don't bypass gitolite if the repo is mirrored!</p></li>
<li><p>From v3.5.3 on, gitolite uses an asynchronous push to the slaves, so that the main push returns immediately, without waiting for the slave pushes to complete. Keep this in mind if you're writing scripts that do a push, and then read one of the slaves immediately -- you will need to add a few seconds of sleep in your script.</p></li>
</ul>
<h3 id="setting-up-mirroring"><span class="header-section-number">4.2.2</span> setting up mirroring</h3>
<p>This is in two parts: the initial setup and the rc file, followed by the conf file settings and syntax.</p>
<h4 id="the-initial-setup-and-the-rc-filerc"><span class="header-section-number">4.2.2.1</span> the initial setup and the <a href="#rc">rc file</a></h4>
<p>On <strong>each</strong> server:</p>
<ul>
<li><p>Install gitolite normally. Make clones of the server's 'gitolite-admin' repo on your workstation so you can admin them all from one place.</p></li>
<li><p>Give the server a short, simple, &quot;hostname&quot; and set the HOSTNAME in the rc file (i.e., <code>~/.gitolite.rc</code> on the server) to this name, for example 'mars'. <em>Note: this has nothing to do with the hostname of the server in networking or DNS terms, or in OS terms. This is internal to gitolite</em>.</p></li>
<li><p>Run ssh-keygen if needed and get an ssh key pair for the server. Copy the public key to a common area and name it after the host, but with 'server-' prefixed. For example, the pubkey for server 'mars' must be stored as 'server-mars.pub'.</p></li>
<li><p>Copy all keys to all the admin repo clones on your workstation and and add them as usual. This is an <code>O(N^2)</code> operation ;-)</p>
<p>You may have guessed that the prefix 'server-' is special, and distinguishes a human user from a mirroring peer.</p></li>
<li><p>Create &quot;host&quot; aliases to refer to all other machines. See <a href="#ssh-ha">here</a> for what/how.</p>
<p>The host alias for a host (in all other machines' <code>~/.ssh/config</code> files) MUST be the same as the <code>HOSTNAME</code> in the referred host's <code>~/.gitolite.rc</code>. Gitolite mirroring <strong>requires</strong> this consistency in naming; things will NOT work otherwise.</p>
<p>Normally you should be able to build one common file and append it to all the servers' <code>~/.ssh/config</code> files.</p></li>
<li><p>The following <strong>MUST</strong> work for <strong>each pair</strong> of servers that must talk to each other:</p>
<pre><code># on server mars
ssh phobos info
# the response MUST start with &quot;hello, server-mars...&quot;</code></pre>
<p>Note the exact syntax used; variations like &quot;ssh git@phobos.example.com info&quot; are NOT sufficient. That is why you need the ssh host aliases.</p>
<p>Check this command from <em>everywhere to everywhere else</em>, and make sure you get expected results. <strong>Do NOT proceed otherwise.</strong></p></li>
<li><p>Setup the gitolite.conf file on all the servers. If the slaves are to be exact copies of the master, you need to do the complete configuration only on the master; the slaves can have just this:</p>
<pre><code>repo gitolite-admin
    RW+     =   &lt;some local admin&gt;

    option mirror.master    =   mars
    option mirror.slaves    =   phobos</code></pre>
<p>because on the first push to the master it will update all the slaves anyway.</p></li>
<li><p>When that is all done and tested, <strong>enable mirroring</strong> by going through the rc file and uncommenting all the lines mentioning <code>Mirroring</code>.</p></li>
</ul>
<h4 id="conf-file-settings-and-syntax"><span class="header-section-number">4.2.2.2</span> conf file settings and syntax</h4>
<p>Mirroring is defined by the following <a href="#options">options</a>. You can have different settings for different repos, and of course some repos may not have any mirror options at all -- they are then purely local.</p>
<pre><code>repo foo
    ...access rules...

    option mirror.master        =   mars
    option mirror.slaves        =   phobos deimos
    option mirror.redirectOK    =   all</code></pre>
<p>The first line is easy, since a repo can have only one master.</p>
<p>The second is a space separated list of hosts that are all slaves. You can have several slave lists, as long as the config key starts with 'mirror.slaves' and is unique. For example.</p>
<pre><code>    option mirror.slaves-1   =   phobos deimos
    option mirror.slaves-2   =   io europa
    option mirror.slaves-3   =   ganymede callisto</code></pre>
<p>Do not repeat a key; then only the last line for that key will be effective.</p>
<h3 id="redirected-pushes"><span class="header-section-number">4.2.3</span> redirected pushes</h3>
<p><strong>Please read carefully; there are security implications if you enable this for mirrors NOT under your control</strong>.</p>
<p>Normally, a master, (and <em>only</em> a master), pushes to a slave, and the slaves are &quot;read-only&quot; to the users. Gitolite allows a <em>slave</em> to receive pushes from a user and transparently redirect them to the <em>master</em>.</p>
<p>This simplifies things for users in complex setups, letting them use their local mirror for both fetch and push access to all repos.</p>
<p>Just remember that if you do this, <strong>authentication</strong> happens on the slave, but <strong>authorisation</strong> is on the master. The master is trusting the slave to authenticate the user correctly, <em>and</em> use the same authentication data (i.e., user alice on the slave should be guaranteed to be the same as user alice on the master).</p>
<p>Please note that the part of the authorisation that happens before passing control to git-receive-pack (see the <a href="#rules">access rules</a> page) will happen on the slave as well.</p>
<p>The syntax for enabling this is one of these:</p>
<pre><code>option mirror.redirectOK    =   all
option mirror.redirectOK    =   phobos deimos</code></pre>
<p>The first syntax trusts all valid slaves to redirect user pushes, while the second one trusts only some slaves.</p>
<p>Note that you cannot redirect gitolite commands (like perms, etc).</p>
<h3 id="sync"><span class="header-section-number">4.2.4</span> manually synchronising a slave repo</h3>
<p>You can use the <code>gitolite mirror push</code> command on a master to manually synchronise any of its slaves. Try it with <code>-h</code> to get usage info.</p>
<p>Tip: if you want to do this to all the slaves, try this:</p>
<pre><code>for s in `gitolite git-config -r reponame mirror.slave | cut -f3`
do
    gitolite mirror push $s reponame
done</code></pre>
<p>This command can also be run remotely; run <code>ssh git@host mirror -h</code> for details.</p>
<h3 id="HOSTNAME"><span class="header-section-number">4.2.5</span> appendix A: HOSTNAME substitution</h3>
<p>Wherever gitolite sees the word <code>%HOSTNAME</code>, it will replace it with the HOSTNAME supplied in the rc file, if one was supplied. This lets you maintain configurations for all servers in one repo, yet have them act differently on different servers, by saying something like:</p>
<pre><code>subconf &quot;%HOSTNAME/*.conf&quot;</code></pre>
<p>You can use it in other places also, for example:</p>
<pre><code>RW+     VREF/NAME/subs/%HOSTNAME/       =   @%HOSTNAME-admins</code></pre>
<p>(you still have to define @mars-admins, @phobos-admins, etc., but the actual VREF is now one line instead of one for each server!)</p>
<h3 id="appendix-b-efficiency-versus-paranoia"><span class="header-section-number">4.2.6</span> appendix B: efficiency versus paranoia</h3>
<p>If you're paranoid enough to use mirrors, you should be paranoid enough to set this on each server, despite the possible CPU overhead:</p>
<pre><code>git config --global receive.fsckObjects true</code></pre>
<h3 id="appendix-c-moving-the-admin-repo-to-a-different-master"><span class="header-section-number">4.2.7</span> appendix C: moving the admin repo to a different master</h3>
<p>Moving only some repos (other than the gitolite-admin repo) to a different master is easy. Just make the change in the gitolite.conf file, add, commit, and push.</p>
<p>Even for the gitolite-admin repo, if the current master is ok, it's the same thing; just make the change and push <em>to the current master</em>. Subsequent pushes will go to the new master, of course.</p>
<p>But if the current master is already dead, there's a bit of a catch-22. You can't push to the master because it is dead, and you can't push to any slave because they won't accept updates from anywhere but the server they think is the master.</p>
<p>Here's how to resolve this:</p>
<ol style="list-style-type: decimal">
<li><p>On <em>each</em> slave:</p>
<ul>
<li><p>edit <code>~/.gitolite/conf/gitolite.conf</code> to change the master and slave options for the gitolite-admin repo.</p></li>
<li><p>run <code>gitolite setup</code></p></li>
</ul></li>
<li><p>Now clone the admin repo from the <em>new</em> master to your workstation, change the options for the rest of the repos (if needed), then add/commit/push.</p></li>
</ol>
<p>And that should be all you need to do.</p>
<h2 id="deleg"><span class="header-section-number">4.3</span> delegating access control responsibilities</h2>
<p>Delegation allows you to divide up a large conf file into smaller groups of repos (called <strong>subconf</strong>s) and hand over responsibility to manage them to <strong>sub-admin</strong>s. Gitolite can prevent one sub-admin from being able to set access rules for any other sub-admin's repos.</p>
<p>Delegation is achieved by combining two gitolite features: <a href="#subconf">subconf</a> and the <a href="#NAME">NAME VREF</a>.</p>
<p>To understand delegation, read both those links then come back to this example.</p>
<h3 id="example"><span class="header-section-number">4.3.1</span> example</h3>
<pre><code>@webbrowsers        = firefox lynx browsers/..*
@webservers         = apache nginx servers/..*
@malwares           = conficker storm ms/..*
    # side note: if anyone objects, we claim ms stands for &quot;metasploit&quot; ;-)

# the admin repo access was probably like this to start with:
repo gitolite-admin
    RW+                                     = sitaram
# now add these lines to the config for the admin repo
    RW                                      = alice bob mallory
    RW  VREF/NAME/conf/subs/webbrowsers     = alice
    RW  VREF/NAME/conf/subs/webservers      = bob
    RW  VREF/NAME/conf/subs/malwares        = mallory
    -   VREF/NAME/                          = alice bob mallory</code></pre>
<p>Finally, you tell gitolite to pull in these files using the &quot;subconf&quot; command</p>
<pre><code>subconf &quot;subs/*.conf&quot;</code></pre>
<p>And that's it.</p>
<h3 id="subconf"><span class="header-section-number">4.3.2</span> the subconf command</h3>
<p>Subconf is exactly like the include command in syntax:</p>
<pre><code>subconf &quot;foo.conf&quot;</code></pre>
<p>but while reading the included file (as well as anything included from it), gitolite sets the &quot;subconf name&quot; to &quot;foo&quot;.</p>
<p>A &quot;subconf&quot; imposes some restrictions on what repos can be managed.</p>
<p>For example, while the subconf name is &quot;foo&quot;, as in the above example, gitolite will only process &quot;repo&quot; lines for:</p>
<ul>
<li>A repo called &quot;foo&quot;.</li>
<li>A group called &quot;@foo&quot;, as long as the group is defined in the main conf file (i.e., <em>outside</em> &quot;foo.conf&quot;).</li>
<li>A member of a group called &quot;@foo&quot; (again, defined outside).</li>
<li>A repo that matches a member of a group called &quot;@foo&quot; if that member is a regular expression pattern.</li>
</ul>
<p>Here's an example. If the main conf file contains</p>
<pre><code>@foo    =   aa bb cc/..*</code></pre>
<p>then the subconf can only accept repo statements that refer to 'foo', '@foo', 'aa', 'bb', or any repo whose name starts with 'cc/'.</p>
<p><strong>Note</strong>: the subconf name &quot;master&quot; is special; it is the default subconf in effect for the main conf file and has no restrictions.</p>
<h4 id="how-the-subconf-name-is-derived"><span class="header-section-number">4.3.2.1</span> how the &quot;subconf name&quot; is derived</h4>
<p>For subconf lines that look just like include statements, i.e.,</p>
<pre><code>subconf &quot;foo/bar.conf&quot;
subconf &quot;frob/*.conf&quot;
    # assume frob has files aa.conf, bb.conf</code></pre>
<p>the subconf name as each file is being processed is the base name of the file. This means it would be &quot;bar&quot; for the first line, &quot;aa&quot; when processing &quot;frob/aa.conf&quot;, and &quot;bb&quot; when processing &quot;frob/bb.conf&quot;.</p>
<p>A variation of subconf exists that can explicitly state the subconf name:</p>
<pre><code>subconf foo &quot;frob/*.conf&quot;</code></pre>
<p>In this variation, regardless of what file in &quot;frob/&quot; is being read, the subconf name in effect is &quot;foo&quot;.</p>
<h3 id="security-notes"><span class="header-section-number">4.3.3</span> security notes</h3>
<h4 id="group-names"><span class="header-section-number">4.3.3.1</span> group names</h4>
<p>You can use &quot;@group&quot;s defined in the main config file but do not attempt to redefine or extend them in your own subconf file. If you must extend a group (say <code>@foo</code>) defined in the main config file, do this:</p>
<pre><code>@myfoo  =   @foo
# now do whatever you want with @myfoo</code></pre>
<p>Group names you define in your subconf will not clash even if the exact same name is used in another subconf file, so you need not worry about that.</p>
<h4 id="delegating-pubkeys"><span class="header-section-number">4.3.3.2</span> delegating pubkeys</h4>
<p>Short answer: not gonna happen.</p>
<p>The delegation feature is meant only for access control rules, not pubkeys. Adding/removing pubkeys is a much more significant event than changing branch level permissions for people already on staff, and only the main admin should be allowed to do it.</p>
<p>Gitolite's &quot;userids&quot; all live in the same namespace. This is unlikely to change, so please don't ask -- it gets real complicated to do otherwise. Allowing sub-admins to add users means username collisions, which also means security problems (admin-A creates a pubkey for Admin-B, thus gaining access to all of Admin-B's stuff).</p>
<p>If you feel the need to delegate even that, please just go the whole hog and give them separate gitolite instances (i.e., running under different gitolite hosting users)!</p>
<h2 id="special"><span class="header-section-number">4.4</span> special features and setups</h2>
<!-- pandoc: toc -->

<hr />
<h3 id="elsewhere"><span class="header-section-number">4.4.1</span> putting 'repositories' and '.gitolite' somewhere else</h3>
<p>Gitolite insists that the &quot;repositories&quot; and &quot;.gitolite&quot; directories be in <code>$HOME</code>. If you want them somewhere else:</p>
<ul>
<li>do the install as normal,</li>
<li><em>then</em> move those directories to wherever you want and replace them with symlinks pointing to the new location.</li>
</ul>
<h3 id="writable"><span class="header-section-number">4.4.2</span> disabling pushes to take backups</h3>
<p>The <code>writable</code> command allows you to disable pushes to all repos or just the named repo, in order to do file-system level things to the repo directory that require it not to change, like using normal backup software.</p>
<p>Run <code>gitolite writable -h</code> for more info.</p>
<h3 id="pers"><span class="header-section-number">4.4.3</span> &quot;personal&quot; branches</h3>
<p>&quot;personal&quot; branches are great for environments where developers need to share work but can't directly pull from each other (usually due to either a networking or authentication related reason, both common in corporate setups).</p>
<p>Personal branches exist <strong>in a namespace</strong> of their own. The syntax is</p>
<pre><code>    RW+ personal/USER/  =   @userlist</code></pre>
<p>where the &quot;personal&quot; can be anything you like (but cannot be empty), and the &quot;/USER/&quot; part is <strong>necessary (including both slashes)</strong>.</p>
<p>A user &quot;alice&quot; (if she's in the userlist) can then push any branches inside <code>personal/alice/</code>. Which means she can push <code>personal/alice/foo</code> and <code>personal/alice/bar</code>, but NOT <code>personal/alice</code>.</p>
<p>(Background: at runtime the &quot;USER&quot; component will be replaced by the name of the invoking user. Access is determined by the right hand side, as usual).</p>
<p>Compared to using arbitrary branch names on the same server, this:</p>
<ul>
<li>Reduces namespace pollution by corralling all these ad hoc branches into the &quot;personal/&quot; namespace.</li>
<li>Reduces branch name collision by giving each developer her own sub-hierarchy within that.</li>
<li>Removes the need to think about access control, because a user can push only to his own sub-hierarchy.</li>
</ul>
<h3 id="delegating-access-control-responsibilities"><span class="header-section-number">4.4.4</span> delegating access control responsibilities</h3>
<p>See <a href="#deleg">this</a>.</p>
<h3 id="keysonly"><span class="header-section-number">4.4.5</span> using pubkeys obtained from elsewhere</h3>
<p>If you're not managing keys via the gitolite-admin repo, but getting them from somewhere else, you'll want to periodically &quot;update&quot; the keys.</p>
<p>To do that, first edit your rc file and add something like this:</p>
<pre><code>SSH_AUTHKEYS                =&gt;
    [
        'post-compile/ssh-authkeys',
    ],</code></pre>
<p>Then write a script that</p>
<ul>
<li><p>gets all the keys and dumps them into <code>$HOME/.gitolite/keydir</code> (or into a subdirectory of it).</p></li>
<li><p>runs <code>gitolite trigger SSH_AUTHKEYS</code>.</p></li>
</ul>
<p>Run this from cron or however you want.</p>
<h3 id="gh"><span class="header-section-number">4.4.6</span> giving users their own repos</h3>
<p>(Please see <a href="#wild">this</a> for background on the ideas in this section).</p>
<p>It's very easy to give users their own set of repos to create, with the username at the top level. The simplest setup is:</p>
<pre><code>repo CREATOR/..*
    C   =   @all
    RW+ =   CREATOR
    RW  =   WRITERS
    R   =   READERS</code></pre>
<p>Now users can create any repo under their own name simply by cloning it or pushing to it, then use the <a href="#perms">perms</a> command to add other users to their WRITERS and READERS lists.</p>
<p>Of course you can get much more creative if you add a few more roles (see &quot;roles&quot; in <a href="#wild">this</a> page).</p>
<p><font color="gray">(I prefer using some prefix, say &quot;u&quot;, as in <code>repo u/CREATOR/..*</code>. This helps to keep user-created repos separate, and avoid name clashes in some far-fetched scenarios).</font></p>
<h2 id="rare"><span class="header-section-number">4.5</span> rare or one-time activities</h2>
<h3 id="existing"><span class="header-section-number">4.5.1</span> moving existing repos into gitolite</h3>
<p><strong>WARNINGS</strong></p>
<ul>
<li><p>Gitolite <strong>will clobber</strong> any existing <code>update</code> hook in your repos when you do this. Please see either the [cookbook][] or the <a href="#cust">customisation</a> document for information on how to make your existing update hook work with gitolite.</p></li>
<li><p>Gitolite <em>may clobber</em> any existing &quot;git-daemon-export-ok&quot; file in your repo; see the page on <a href="#external">interfacing with external tools</a> for how to enable that via gitolite.</p></li>
</ul>
<p>With that out of the way, here's how to do this:</p>
<p>First, on the server:</p>
<ul>
<li><p>Move the repos to <code>$HOME/repositories</code>.</p></li>
<li><p>Make sure that:</p>
<ul>
<li>They are all <em>bare</em> repos.</li>
<li>All the repo names end in &quot;.git&quot;.</li>
<li>All the files and directories are owned and writable by the gitolite <a href="#nnc">hosting user</a> (especially true if you copied them as root).</li>
</ul></li>
<li><p>Run <code>gitolite setup</code>. <strong>If you forget this step, you can also forget about write access control!</strong></p></li>
</ul>
<p>Then, back on your workstation:</p>
<ul>
<li><p>If the repos are normal repos, <a href="#repos">add them</a> to conf/gitolite.conf in your clone of the admin repo, then commit and push the change.</p>
<p>If the repos are <a href="#wild">wildcard</a> repos that already match some pattern in the conf file, you need to manually create the gl-creator file, like so:</p>
<pre><code>echo username &gt; ~/repositories/path/to/repo.git/gl-creator</code></pre>
<p>I haven't yet found this to be common enough to bother wrapping it in a nice interface or command.</p></li>
</ul>
<h3 id="moving"><span class="header-section-number">4.5.2</span> moving servers</h3>
<p>This is adapted from the &quot;migrating&quot; section of the <a href="#install">install</a> page; if you're actually <em>migrating</em> from g2 please go there!</p>
<p>Nothing in any of the gitolite install/setup/etc will ever touch the <em>data</em> in any repository except the gitolite-admin repo. The only thing it will normally touch is the <code>update</code> hook. So one fool-proof way of &quot;moving&quot; servers is this (untested but should work; feedback appreciated):</p>
<ol style="list-style-type: decimal">
<li><p>Install gitolite on the new server, using the same key for the admin as for the old server.</p></li>
<li><p>Copy the <a href="#rc">rc</a> file from the old server, overwriting this one.</p></li>
<li><p><a href="#writable">Disable</a> the old server so people won't push to it.</p></li>
<li><p>Copy all the repos over from the old server, including gitolite-admin. Make sure the files end up with the right ownership and permissions; if not, chown/chmod them.</p></li>
<li><p>Run <code>gitolite setup</code>.</p></li>
<li><p>On a clone of the old gitolite-admin, add a new remote (or change an existing one) to point to the new server. Then <code>git push -f</code> to this remote.</p></li>
</ol>
<h1 id="s5"><span class="header-section-number">5</span> smart http</h1>
<h2 id="http"><span class="header-section-number">5.1</span> how to setup gitolite to use smart http mode</h2>
<p><strong>Note</strong>: &quot;smart http&quot; refers to the feature that came with git 1.6.6, late 2009 or so. The base documentation for this is <code>man git-http-backend</code>. Do <strong>NOT</strong> read <code>Documentation/howto/setup-git-server-over-http.txt</code> and think that is the same or even relevant -- that is from 2006 and is quite different (and arguably obsolete).</p>
<h3 id="warnings-and-important-notes"><span class="header-section-number">5.1.1</span> WARNINGS and important notes</h3>
<ul>
<li><p>Please read <a href="#auth">authentication versus authorisation</a> first, and make sure you understand what is gitolite's responsibility and what isn't.</p></li>
<li><p>I have tested this only on stock Fedora 16; YDMV.</p></li>
</ul>
<h3 id="assumptions-1"><span class="header-section-number">5.1.2</span> assumptions:</h3>
<ul>
<li>Apache 2.x and git installed.</li>
<li>Httpd runs under the &quot;apache&quot; userid; adjust instructions below if not.</li>
<li>Similarly for &quot;/var/www&quot; and other file names/locations.</li>
</ul>
<h3 id="instructions-1"><span class="header-section-number">5.1.3</span> instructions</h3>
<p>The detailed instructions I used to have in g2 have now been replaced by a script called <code>t/smart-http.root-setup</code>. <strong>Do NOT run this script as is -- it is actually meant for my testing setup and deletes stuff</strong>. However, it does provide an excellent (and working!) narration of what you need to do to install gitolite in smart http mode.</p>
<p>Make a copy of the script, go through it carefully, (possibly removing lines that delete files etc.), change values per your system, and only then run it.</p>
<p><font color="gray">Note that the <code>GIT_PROJECT_ROOT</code> variable (see &quot;man git-http-backend&quot;) is no longer optional. Make sure you set it to some place outside apache's <code>DOCUMENT_ROOT</code>.</font></p>
<h3 id="making-repositories-available-to-both-ssh-and-http-mode-clients"><span class="header-section-number">5.1.4</span> Making repositories available to both ssh and http mode clients</h3>
<p>This section has been contributed by Thomas Hager (duke at sigsegv dot at), and is available <a href="#ssh-and-http">here</a>.</p>
<h3 id="usage"><span class="header-section-number">5.1.5</span> usage</h3>
<h4 id="client-side"><span class="header-section-number">5.1.5.1</span> client side</h4>
<p>Git URLs look like <code>http://user:password@server/git/reponame.git</code>.</p>
<p>The custom commands, like &quot;info&quot;, &quot;expand&quot; should be handled as follows. The command name will come just after the <code>/git/</code>, followed by a <code>?</code>, followed by the arguments, with <code>+</code> representing a space. Here are some examples:</p>
<pre><code># ssh git@server info
curl http://user:password@server/git/info
# ssh git@server info repopatt
curl http://user:password@server/git/info?repopatt
# ssh git@server info repopatt user1 user2
curl http://user:password@server/git/info?repopatt+user1+user2</code></pre>
<p>With a few nice shell aliases, you won't even notice the horrible convolutions here ;-) See t/smart-http for a couple of useful ones.</p>
<h4 id="server-side"><span class="header-section-number">5.1.5.2</span> server side</h4>
<p>The 'gitolite' command (for example, 'gitolite compile', 'gitolite query-rc', and so on) <em>can</em> be run on the server, but it's not straightforward. Assuming you installed exactly as given in this document, you should</p>
<ul>
<li>get a shell by using, say, <code>su -s /bin/bash - apache</code></li>
<li>run <code>export HOME=$HOME/gitolite-home</code></li>
<li>run <code>export PATH=$PATH:$HOME/bin</code></li>
</ul>
<p>and <em>then</em> you can run <code>gitolite &lt;subcommand&gt;</code></p>
<h2 id="ssh-and-http"><span class="header-section-number">5.2</span> Making repositories available to both ssh and http mode clients</h2>
<p>Copyright Thomas Hager (duke at sigsegv dot at). Licensed under CC-BY-NC-SA unported 3.0, http://creativecommons.org/licenses/by-nc-sa/3.0/</p>
<p>Assumptions:</p>
<ul>
<li>Apache 2.x with CGI and Suexec support installed.</li>
<li>Git and Gitolite installed with user &quot;git&quot; and group &quot;git&quot;, and pubkey SSH access configured and working.</li>
<li>Git plumbing installed to /usr/libexec/git-core</li>
<li>Gitolite base located at /opt/git</li>
<li>Apache <code>DOCUMENT_ROOT</code> set to /var/www</li>
<li>Apache runs with user www and group www</li>
</ul>
<p>Please adjust the instructions below to reflect your setup (users and paths).</p>
<p>Edit your .gitolite.rc and add</p>
<pre><code>$ENV{PATH} .= &quot;:/opt/git/bin&quot;;</code></pre>
<p>at the very top (as described in <code>t/smart-http.root-setup</code>).</p>
<p>Next, check which document root your Apache's suexec accepts:</p>
<pre><code># suexec -V
 -D AP_DOC_ROOT=&quot;/var/www&quot;
 -D AP_GID_MIN=100
 -D AP_HTTPD_USER=&quot;www&quot;
 -D AP_LOG_EXEC=&quot;/var/log/apache/suexec.log&quot;
 -D AP_SAFE_PATH=&quot;/usr/local/bin:/usr/bin:/bin&quot;
 -D AP_UID_MIN=100
 -D AP_USERDIR_SUFFIX=&quot;public_html&quot;</code></pre>
<p>We're interested in <code>AP_DOC_ROOT</code>, which is set to <code>/var/www</code> in our case.</p>
<p>Create a <code>bin</code> and a <code>git</code> directory in <code>AP_DOC_ROOT</code>:</p>
<pre><code>install -d -m 0755 -o git -g git /var/www/bin
install -d -m 0755 -o www -g www /var/www/git</code></pre>
<p><code>/var/www/git</code> is just a dummy directory used as Apache's document root (see below).</p>
<p>Next, create a shell script inside <code>/var/www/bin</code> named <code>gitolite-suexec-wrapper.sh</code>, with mode <strong>0700</strong> and owned by user and group <strong>git</strong>. Add the following content:</p>
<pre><code>#!/bin/bash
#
# Suexec wrapper for gitolite-shell
#

export GIT_PROJECT_ROOT=&quot;/opt/git/repositories&quot;
export GITOLITE_HTTP_HOME=&quot;/opt/git&quot;

exec ${GITOLITE_HTTP_HOME}/gitolite-source/src/gitolite-shell</code></pre>
<p>Edit your Apache's config to add http pull/push support, preferably in a dedicated <code>VirtualHost</code> section:</p>
<pre><code>&lt;VirtualHost *:80&gt;
    ServerName        git.example.com
    ServerAlias       git
    ServerAdmin       you@example.com

    DocumentRoot /var/www/git
    &lt;Directory /var/www/git&gt;
        Options       None
        AllowOverride none
        Order         allow,deny
        Allow         from all
    &lt;/Directory&gt;

    SuexecUserGroup git git
    ScriptAlias /git/ /var/www/bin/gitolite-suexec-wrapper.sh/
    ScriptAlias /gitmob/ /var/www/bin/gitolite-suexec-wrapper.sh/

    &lt;Location /git&gt;
        AuthType Basic
        AuthName &quot;Git Access&quot;
        Require valid-user
        AuthUserFile /etc/apache/git.passwd
    &lt;/Location&gt;
&lt;/VirtualHost&gt;</code></pre>
<p>This Apache config is just an example, you probably should adapt the authentication section and use https instead of http!</p>
<p>Finally, add an <code>R = daemon</code> access rule to all repositories you want to make available via http.</p>
<h1 id="s6"><span class="header-section-number">6</span> customising gitolite</h1>
<h2 id="cust"><span class="header-section-number">6.1</span> customising gitolite</h2>
<!-- pandoc: toc -->

<p>Much of gitolite (g3)'s functionality comes from programs and scripts that are not considered &quot;core&quot;. This keeps the core simpler, and allows you to enhance gitolite for your own purposes without too much fuss. (As an extreme example, even mirroring is not in core now!)</p>
<p>Here's how to find out more:</p>
<ul>
<li><p>this document describes the types of non-core programs and how/where to install your own</p></li>
<li><p>the <a href="#dev-notes">developer notes</a> page tells you how to write your own non-core programs</p></li>
<li><p>the <a href="#non-core">list of non-core programs</a> talks about what's already shipped with gitolite, with a brief description of each</p></li>
</ul>
<hr />
<h3 id="ncintro"><span class="header-section-number">6.1.1</span> introduction</h3>
<p>There are 5 basic types of non-core programs.</p>
<ul>
<li><em>Commands</em> can be run from the shell command line. Among those, the ones in the ENABLE list in the rc file can also be run remotely.</li>
<li><em>Hooks</em> are standard git hooks.</li>
<li><em>Sugar scripts</em> change the conf language for your convenience. The word sugar comes from &quot;syntactic sugar&quot;.</li>
<li><em>Triggers</em> are to gitolite what hooks are to git. I just chose a different name to avoid confusion and constant disambiguation in the docs.</li>
<li><strong>VREFs</strong> are extensions to the access control check part of gitolite.</li>
</ul>
<h3 id="ncloc"><span class="header-section-number">6.1.2</span> locations...</h3>
<h4 id="for-non-core-programs-shipped-with-gitolite"><span class="header-section-number">6.1.2.1</span> ...for non-core programs shipped with gitolite</h4>
<p><code>gitolite query-rc GL_BINDIR</code> will tell you where shipped non-core programs reside. Within that directory, the subdirectories of interest are:</p>
<ul>
<li><code>commands</code> for commands.</li>
<li><code>syntactic-sugar</code> for sugar scripts.</li>
<li><code>triggers</code> and <code>lib/Gitolite/Triggers</code> for triggers (<a href="#triggers">this</a> will explain the difference).</li>
<li><code>VREF</code> for <a href="#vref">VREFs</a>.</li>
</ul>
<h4 id="localcode"><span class="header-section-number">6.1.2.2</span> ...for <em>your</em> non-core programs</h4>
<p>If you want to add your own non-core programs, or even <em>override</em> the shipped ones with your own, you can.</p>
<p>Put your programs in some convenient directory and use the <code>LOCAL_CODE</code> rc variable to tell gitolite where that is. <strong>Please supply the FULL path</strong> to this variable.</p>
<p>Within that directory, you can use any or all of these subdirectories:</p>
<ul>
<li><code>commands</code></li>
<li><code>hooks/common</code> (see note below)</li>
<li><code>syntactic-sugar</code></li>
<li><code>triggers</code> and <code>lib/Gitolite/Triggers</code></li>
<li><code>VREF</code></li>
</ul>
<p>Note: the <code>hooks/common</code> directory is a bit special. If you add new hooks to this, you must run either <code>gitolite setup</code>, or at least <code>gitolite setup --hooks-only</code>.</p>
<h4 id="pushcode"><span class="header-section-number">6.1.2.3</span> using the gitolite-admin repo to manage non-core code</h4>
<p>The location given in <code>LOCAL_CODE</code> could be anywhere on disk, like say <code>$ENV{HOME}/local</code>.</p>
<p>However, some administrators find it convenient to use the admin repo to manage this code as well, getting the benefits of versioning them as well as making changes to them without having to log on to the server.</p>
<p>To do this, simply point <code>LOCAL_CODE</code> to someplace inside <code>$GL_ADMIN_BASE</code> (i.e., <code>$HOME/.gitolite</code>) in the rc file.</p>
<p>If you want to do this, I <strong>strongly</strong> suggest:</p>
<pre><code>LOCAL_CODE                  =&gt;  &quot;$ENV{HOME}/.gitolite/local&quot;,</code></pre>
<p>Then you create a directory called &quot;local&quot; in your gitolite clone, and put stuff there (e.g., VREFs go in <code>local/VREF</code>, and commands in <code>local/commands</code>).</p>
<p>(Note: when you do this, gitolite takes care of running <code>gitolite setup --hooks-only</code> when you change any hooks and push).</p>
<h5 id="security-note-on-this-mode-of-managing-non-core-code"><span class="header-section-number">6.1.2.3.1</span> <strong>SECURITY</strong> note on this mode of managing non-core code</h5>
<p><strong>In this mode, anyone who can push changes to the admin repo will effectively be able to run any arbitrary command on the server.</strong></p>
<p>This may not matter to many (small) sites, but a large site with lots of administrators may want to keep the two rights (i.e., &quot;right to push to the gitolite-admin repo&quot; and &quot;right to run arbitrary programs on the server&quot;) separate.</p>
<h3 id="nctypes"><span class="header-section-number">6.1.3</span> types of non-core programs</h3>
<h4 id="commands"><span class="header-section-number">6.1.3.1</span> gitolite &quot;commands&quot;</h4>
<p>Gitolite comes with several commands that users can run. Remote users run commands by saying:</p>
<pre><code>ssh git@host command-name [args...]</code></pre>
<p>while on the server you can run</p>
<pre><code>gitolite command [args...]</code></pre>
<p>Very few commands are designed to be run both ways, but it can be done, by checking for the presence of env var <code>GL_USER</code>.</p>
<p>All commands respond to a single <code>-h</code> option with a suitable message.</p>
<p>You can get a <strong>list of available commands</strong> by using the <code>help</code> command. Naturally, a remote user will see a much smaller list than the server user.</p>
<p>You allow a command to be run from remote clients by adding its name to (or uncommenting it if it's already added but commented out) the ENABLE list in the <a href="#rc">rc</a> file.</p>
<h4 id="hooks"><span class="header-section-number">6.1.3.2</span> hooks and gitolite</h4>
<p>You can install any hooks except these:</p>
<ul>
<li><p>(all repos) gitolite reserves the <code>update</code> hook. See the &quot;update hook&quot; section in <a href="#dev-notes">dev-notes</a> if you want additional update hook functionality.</p></li>
<li><p>(gitolite-admin repo only) gitolite reserves the <code>post-update</code> hook.</p></li>
</ul>
<p>How/where to install them is described in detail in the &quot;locations&quot; section above, especially <a href="#localcode">this</a> and <a href="#pushcode">this</a>. The summary is that you put them in the &quot;hooks/common&quot; sub-directory within the directory whose name is given in the <code>LOCAL_CODE</code> rc variable, then run <code>gitolite setup</code>.</p>
<h5 id="rsh"><span class="header-section-number">6.1.3.2.1</span> repo-specific hooks</h5>
<p>If you want to add hooks only to specific repos, do this:</p>
<ul>
<li><p>create a directory called <code>hooks/repo-specific</code> in the location specified by the <a href="#localcode"><code>LOCAL_CODE</code></a> rc variable</p></li>
<li><p>add your hooks here, with descriptive names (i.e., not &quot;post-receive&quot;, etc., but maybe &quot;jenkins&quot; or &quot;deploy&quot; or whatever)</p></li>
<li><p>uncomment the 'repo-specific-hooks' line in the rc file or add it to the ENABLE list if it doesn't exist.</p>
<p>If your rc file does not have an ENABLE list, you need to add this to the POST_COMPILE and the POST_CREATE lists. Click <a href="#addtrig">here</a> for more on all this.</p></li>
<li><p>now add lines like this to your conf file:</p>
<pre><code>repo    foo
    RW+     =   @all
    option hook.post-receive    =   deploy</code></pre>
<p>The syntax should be fairly obvious, but just to be clear, in this case a symlink called &quot;post-receive&quot; will be placed in foo.git/hooks, pointing to the executable called &quot;deploy&quot; in hooks/repo-specific in the local-code area.</p>
<p><strong>WARNING</strong>: if the hook already exists, it is silently overwritten.</p>
<p><strong>WARNING</strong>: once the hook is placed, you can't remove it through gitolite. That is, removing the option line won't do anything. You'll have to go to the server and remove it manually. (You could, as a simple work-around, create a &quot;no-op&quot; script that just does &quot;exit 0&quot;, and change the option line to point the hook to that, so it <em>effectively</em> gets deleted!).</p></li>
</ul>
<h4 id="sugar"><span class="header-section-number">6.1.3.3</span> syntactic sugar</h4>
<p>Sugar scripts help you change the perceived syntax of the conf language. The base syntax of the language is very simple, so sugar scripts take something <em>else</em> and convert it into that.</p>
<p>That way, the admin sees additional features (like allowing continuation lines), while the parser in the core gitolite engine does not change.</p>
<p>If you want to write your own sugar scripts, please read the &quot;your own sugar&quot; section in <a href="#dev-notes">dev-notes</a> first then email me.</p>
<p>You enable a sugar script by uncommenting the feature name in the ENABLE list in the rc file.</p>
<h4 id="triggers"><span class="header-section-number">6.1.3.4</span> triggers</h4>
<p>Triggers have their own <a href="#triggers">document</a>.</p>
<h4 id="vrefs"><span class="header-section-number">6.1.3.5</span> VREFs</h4>
<p>VREFs also have their own <a href="#vref">document</a>.</p>
<h2 id="non-core"><span class="header-section-number">6.2</span> non-core features shipped with gitolite</h2>
<!-- pandoc: toc -->

<p><strong>Important Notes on &quot;non-core&quot; features</strong>:</p>
<ol style="list-style-type: decimal">
<li><p>The <a href="#cust">customisation</a> document is the starting point for all information about customising gitolite.</p></li>
<li><p>If a non-core feature is shipped with gitolite, but information about it is not found in this document, it can be found within the source code; please look there.</p>
<p><a href="#commands">Commands</a>, however, have some extra magic, which is not available to the other types of non-core programs:</p>
<ul>
<li><p>running the command with a single <code>-h</code> option (i.e., <code>gitolite     &lt;command&gt; -h</code> or <code>ssh git@host &lt;command&gt; -h</code>), will display a suitable message. Please report a bug to me if one of them doesn't.</p></li>
<li><p>running 'help', (either as <code>gitolite help</code> on the server, or <code>ssh     git@host help</code> remotely), will give you a list of commands you are allowed to run.</p></li>
</ul></li>
<li><p>Non-core code is <strong>meant</strong> to be <a href="#localcode">localised for your site</a> if you don't like what the shipped version does. You can even maintain it <a href="#pushcode">within your gitolite-admin repo</a> if you wish.</p></li>
</ol>
<hr />
<h3 id="commands"><span class="header-section-number">6.2.1</span> commands</h3>
<p>This is a list of commands that are available in gitolite, with brief descriptions and, if available, a link to more detailed information. Note that in most cases running it with <code>-h</code> will give you enough to work with.</p>
<p>Also note that not all of these commands are available remotely.</p>
<p>(The more common/important commands are in bold).</p>
<ul>
<li><em>access</em> -- print or test access rights for repo/user</li>
<li><em>create</em> -- create a wild repo</li>
<li><em>creator</em> -- print or test creator name for wild repo</li>
<li><em>D</em> -- lets you <em>D</em>elete wild repos created using the <em>C</em> permission :)</li>
<li><strong>desc</strong> -- show/set description for wild repo</li>
<li><em>fork</em> -- fork a repo on the server. This uses the <code>-l</code> option to git clone, so it runs really fast</li>
<li><em>git-config</em> -- print (or text existence of) 'config' values in the repo. (Don't forget that <code>option foo.bar = 1</code> is merely syntactic sugar for <code>config gitolite-options.foo.bar = 1</code>, so this can be used to query gitolite options also</li>
<li><strong>help</strong> -- see note 1 at the top of this document</li>
<li><em>htpasswd</em> -- sets your htpasswd</li>
<li><strong><a href="#info">info</a></strong> -- print git/gitolite version, list repos you have access to</li>
<li><em>[lock][locking]</em> -- lock binary files for exclusive use (in combination with the 'lock' VREF)</li>
<li><em><a href="#sync">mirror</a></em> -- manually mirror a repo to a slave</li>
<li><strong><a href="#perms">perms</a></strong> -- list or set permissions for wild repo</li>
<li><em><a href="#bypass">push</a></em> -- push a gitolite repo locally, bypassing gitolite</li>
<li><em>rsync</em> -- bundling support for gitolite</li>
<li><em>sshkeys-lint</em> -- look for potential problems in ssh keys</li>
<li><em>[sskm][]</em> -- self-service key management</li>
<li><em>sudo</em> -- allows an admin (i.e., someone who has push rights to the 'gitolite-admin' repo) to run any remote command as some other user. This is useful, for example, when a user claims he is unable to access a repo, and you need to check the 'info' output for him, etc. However, it does not work the other way, sorry!</li>
<li><em>symbolic-ref</em> -- run <code>git symbolic-ref</code> on a repo, remotely</li>
<li><em>who-pushed</em> -- determine who pushed a given commit</li>
<li><em>writable</em> -- disable/enable writes to specific repo (or all repos, if you're an admin)</li>
</ul>
<h3 id="syntactic-sugar"><span class="header-section-number">6.2.2</span> syntactic sugar</h3>
<p>The following &quot;sugar&quot; programs are available:</p>
<ul>
<li><em>continuation-lines</em> -- allow C-style backslash escaped continuation lines in the conf file</li>
<li><em>keysubdirs-as-groups</em> -- use the last component of the sub-directory name within keydir as a group name</li>
<li><strong>macros</strong> -- simple line-wise macro processor</li>
</ul>
<h3 id="triggers-1"><span class="header-section-number">6.2.3</span> triggers</h3>
<p>Here's a list of <strong>features</strong> that are enabled by <a href="#triggers">triggers</a>, or a combination of a trigger and something else, like a command.</p>
<ul>
<li><em>Alias</em> -- allow repos to have aliases</li>
<li><em>AutoCreate</em> -- deny auto-create of wild repos on R or RW access</li>
<li><em>bg</em> -- allow long running post-compile/post-create jobs to be backgrounded</li>
<li><em>CpuTime</em> -- CPU and elapsed times for gitolite+git</li>
<li><strong><a href="#mirroring">Mirroring</a></strong> -- mirroring all or some repos</li>
<li><em><a href="#partial-copy">partial-copy</a></em> -- simulated read control for branches (in combination with the partial-copy VREF)</li>
<li><em>RefexExpr</em> -- (in combination with VREF/refex-expr) logical expressions over refexes, like &quot;refex-1 and not refex-2&quot;. (Example: changing file 'foo' but not on 'master' branch)</li>
<li><em>renice</em> -- renice the git operation</li>
<li><em>RepoUmask</em> -- repo-specific umask settings</li>
<li><em>Shell</em> -- see &quot;giving shell access to gitolite users&quot; in the <a href="#sts">ssh troubleshooting and tips</a> page. This also need the 'ssh-authkeys-shell-users' trigger to be enabled.</li>
<li><em>ssh-authkeys-shell-users</em> -- see 'Shell' entry just above</li>
<li><em>ssh-authkeys-split</em> -- split pubkey files with multiple keys into separate files with one pubkey each</li>
<li><em>update-description-file</em> -- if you want the 'description' file to be updated instead of the 'gitweb.description' config entry (e.g. cgit users)</li>
<li><em>upstream</em> -- manage local, gitolite-controlled, copies of read-only upstream repos</li>
</ul>
<p>In addition, the following post-compile trigger scripts are enabled by default, so are included here only for completeness and in case you wish to disable them:</p>
<ul>
<li>ssh-authkeys -- process keys in keydir/ and add/update appropriate lines to the authorized keys file</li>
<li>update-git-configs -- run <code>git config</code> in each repo to add/update entries as needed</li>
<li>update-git-daemon-access-list -- create/delete the 'git-daemon-export-ok' files in each repo as needed</li>
<li>update-gitweb-access-list -- create the &quot;projects.list&quot; file that gitweb uses to determine what repos to show/not show</li>
</ul>
<h3 id="vrefs-1"><span class="header-section-number">6.2.4</span> VREFs</h3>
<p>VREFs are a complex topic and have their <a href="#vref">own page</a> with lots more details. However, here's a list of VREFs shipped with gitolite:</p>
<ul>
<li><em><a href="#COUNT">COUNT</a></em> -- restrict pushes by number of changed or new files pushed</li>
<li><em>EMAIL-CHECK</em> -- check if all new commits are authored by the person pushing</li>
<li><em>[lock][locking]</em> -- lock binary files for exclusive use (in combination with the 'lock' command)</li>
<li><em>MAX_NEWBIN_SIZE</em> -- restrict by size of new binary files (helps catch people checking in random PDFs, JARs, WARs, etc.)</li>
<li><strong><a href="#NAME">NAME</a></strong> -- restrict pushes by dir/file name</li>
<li><a href="#partial-copy">partial-copy</a> -- simulated read control for branches (in combination with the partial-copy trigger)</li>
<li><em>refex-expr</em> -- (in combination with the refex-expr trigger) logical expressions over refexes, like &quot;refex-1 and not refex-2&quot;. (Example: changing file 'foo' but not on 'master' branch)</li>
<li><em><a href="#votes">VOTES</a></em> -- voting on commits a la gerrit</li>
</ul>
<h3 id="details-on-some-non-core-programs"><span class="header-section-number">6.2.5</span> details on some non-core programs</h3>
<p>These non-core programs needed more detail than could be provided in the source code, but did not fit anywhere else neatly enough.</p>
<h4 id="partial-copy"><span class="header-section-number">6.2.5.1</span> partial-copy: selective read control for branches</h4>
<p>Git (and therefore gitolite) cannot do selective read control -- allowing someone to read branch A but not branch B. It's the entire repo or nothing.</p>
<p><font color="gray">(Side note: Gerrit Code Review can do that, but that is because they have their own git stack (and their own sshd, and so on) all in one big Java program. Gerrit is <em>really</em> useful if you want code review to be part of the access control decision) </font></p>
<p>Gitolite can now help you do this. Note that this is only for branches; you can't do this for files and directories.</p>
<p>Here's how:</p>
<ol style="list-style-type: decimal">
<li><p>enable 'partial-copy' in the ENABLE list in the rc file.</p></li>
<li><p>for each repo &quot;foo&quot; which has secret branches that a certain set of developers (we'll use a group called <code>@temp-emp</code> as an example) are not supposed to see, do this:</p>
<pre><code>repo foo
    # rules should allow @temp-emp NO ACCESS

repo foo-partialcopy-1
    -   secret-branch               =   @temp-emp

    # other rules; see notes below

    -   VREF/partial-copy           =   @all
    config gitolite.partialCopyOf   =   foo</code></pre>
<p><strong>IMPORTANT NOTES</strong>:</p>
<ul>
<li><p>if you're using other VREFs, <strong>make sure</strong> this one is placed at the end, after all the others.</p></li>
<li><p>remember that any change allowed to be made to the partial-copy repo will propagate to the main repo so make sure you use other rules to restrict pushes to other branches and tags as needed.</p></li>
</ul></li>
</ol>
<p>And that should be it. <strong>Please test it and let me know if it doesn't work!</strong></p>
<p>WARNINGS:</p>
<ul>
<li><p>If you change the config to disallow something that used to be allowed, you should delete the partial repo on the server and then run <code>gitolite     compile; gitolite trigger POST_COMPILE</code> to let it build again.</p></li>
<li><p>Not tested with smart http; probably won't work.</p></li>
<li><p>Also not tested with mirroring, or with wild card repos.</p></li>
</ul>
<h2 id="dev-notes"><span class="header-section-number">6.3</span> notes for developers</h2>
<!-- pandoc: toc -->

<p>Gitolite has a huge bunch of existing features that gradually need to be moved over. Plus you may want to write your own programs to interact with it.</p>
<p><strong>This document is about <em>writing</em> hooks, commands, triggers, VREFS, and sugar scripts. <em>Installing</em> them, including &quot;where and how&quot;, is described <a href="#localcode">here</a></strong>.</p>
<p>Note: the <a href="#cust">customisation</a> document is the starting point for all information about customising gitolite.</p>
<h3 id="environment-variables-and-other-inputs"><span class="header-section-number">6.3.1</span> environment variables and other inputs</h3>
<p>In general, the following environment variables should always be available:</p>
<pre><code>GL_BINDIR
GL_REPO_BASE
GL_ADMIN_BASE</code></pre>
<p>In addition, commands invoked by a remote client also have <code>GL_USER</code>, while hooks have <code>GL_USER</code> as well as <code>GL_REPO</code>.</p>
<p>A special form of the <a href="#options">option</a> syntax can be used to set <a href="#rsev">repo-specific environment variables</a>.</p>
<p>Finally, note that triggers get a lot of relevant information from gitolite as arguments; see <a href="#triggers">here</a> for details.</p>
<h3 id="apis"><span class="header-section-number">6.3.2</span> APIs</h3>
<h4 id="the-shell-api"><span class="header-section-number">6.3.2.1</span> the shell API</h4>
<p>The following commands exist to help you write shell scripts that interact easily with gitolite. Each of them responds to <code>-h</code> so please run that for more info.</p>
<ul>
<li><p><code>gitolite access</code> to check access rights given repo, user, type of access (R, W, ...) and refname (optional). Example use: src/commands/desc.</p></li>
<li><p><code>gitolite creator</code> to get/check the creator of a repo. Example use: src/commands/desc.</p></li>
<li><p><code>gitolite git-config</code> to check gitolite options or git config variables directly from gitolite's &quot;compiled&quot; output, (i.e., without looking at the actual <code>repo.git/config</code> file or using the <code>git config</code> command). Example use: src/triggers/post-compile/update-gitweb-access-list.</p></li>
<li><p><code>gitolite query-rc</code> to check the value of an RC variable. Example use: src/commands/desc.</p></li>
</ul>
<p>In addition, you can also look at the comments in src/lib/Gitolite/Easy.pm (the perl API module) for ideas.</p>
<h4 id="the-perl-api"><span class="header-section-number">6.3.2.2</span> the perl API</h4>
<p>...is implemented by Gitolite::Easy; the comments in src/lib/Gitolite/Easy.pm serve as documentation.</p>
<p>Note that some of the perl functions called by Easy.pm will change the current directory to something else, without saving and restoring the directory. Patches (to Easy.pm <em>only</em>) welcome.</p>
<h3 id="writing-your-own..."><span class="header-section-number">6.3.3</span> writing your own...</h3>
<h4 id="commands-1"><span class="header-section-number">6.3.3.1</span> ...commands</h4>
<p>Commands are standalone programs, in any language you like. They simply receive the arguments you append. In addition, the env var <code>GL_USER</code> is available if it is being run remotely. src/commands/desc is the best example at present.</p>
<h4 id="hooks"><span class="header-section-number">6.3.3.2</span> ...hooks</h4>
<h5 id="anything-but-the-update-hook"><span class="header-section-number">6.3.3.2.1</span> anything but the update hook</h5>
<p>If you want to add any hook other than the update hook, 'man githooks' is all you need.</p>
<h5 id="update-hook"><span class="header-section-number">6.3.3.2.2</span> update hook</h5>
<p>If you want to add additional <code>update</code> hook functionality, do this:</p>
<ul>
<li><p>Write and test your update hook separately from gitolite.</p></li>
<li><p>Now add the code as a VREF (see <a href="#localcode">here</a> for details). Let's say you called it &quot;foo&quot;.</p>
<p>NOTE: if you don't care about all the extra stuff that VREFs give you over a normal update hook, you don't have to read that document at all; just put the code in the right place and go to the next step.</p></li>
<li><p>To call your new update hook to all accesses for all repos, add this to the end of your conf file:</p>
<pre><code>repo @all
    -       VREF/foo        =   @all</code></pre></li>
</ul>
<p>As you probably guessed, you can make your additional update hooks more selective, applying them only to some repos / users / combinations.</p>
<p>Note: a normal update hook expects 3 arguments (ref, old SHA, new SHA). A VREF will get those three, followed by at least 4 more. Your VREF should just ignore the extra args.</p>
<h4 id="trigger-programs"><span class="header-section-number">6.3.3.3</span> ...trigger programs</h4>
<p>Trigger programs run at specific points in gitolite's execution, with specific arguments being passed to them. See the <a href="#triggers">triggers</a> page for details.</p>
<p>You can write programs that are both manually runnable as well as callable by trigger events, especially if they don't <em>need</em> any arguments.</p>
<h4 id="sugar"><span class="header-section-number">6.3.3.4</span> ...&quot;sugar&quot;</h4>
<p>Syntactic sugar helpers are NOT complete, standalone, programs. They must include a perl sub called <code>sugar_script</code> that takes in a listref, and returns a listref. The listrefs point to a list that contains the entire conf file (with all <a href="#include">include</a> processing already done). You create a new list with contents modified as you like and return a ref to it.</p>
<p>There are a couple of examples in src/syntactic-sugar.</p>
<h3 id="appendix-1-notes-on-the-input-trigger"><span class="header-section-number">6.3.4</span> appendix 1: notes on the INPUT trigger</h3>
<p>Note: some of this won't make sense if you haven't read about <a href="#triggers">triggers</a>.</p>
<p>The INPUT trigger sequence is designed to set or change environment variables or the argument list. (Side note: this means INPUT triggers have to be written as perl modules; they cannot be standalone scripts). This is a very powerful idea so an extended description may be useful.</p>
<p>Sshd invokes gitolite-shell with the SSH_ORIGINAL_COMMAND env var containing the git/gitolite command and one argument: the gitolite username.</p>
<ul>
<li>see <a href="#glssh">this</a> for details on the latter</li>
<li>the <em>first</em> thing gitolite does in smart http mode is to use the REMOTE_USER and the CGI variables that apache provides to <em>construct</em> a fake argument list and a fake SSH_ORIGINAL_COMMAND env var, so the rest of the code can stay the same</li>
</ul>
<p>The INPUT trigger is then run. The purpose of the input trigger is to ensure that the first argument <em>is</em> the gitolite username, and that the SSH_ORIGINAL_COMMAND env var contains the actual command to execute. It can also be used to set up any other environment variables that you may decide you need.</p>
<p>Wait... didn't we say that's what gitolite-shell gets anyway, just now?</p>
<p>Well, we lied a bit there; it's not always true!</p>
<p>For example, if <a href="#giving-shell">this</a> feature is used, the first argument <em>may</em> be &quot;-s&quot;, with the username in the <em>second</em> argument. Shell.pm deals with that. <font color="gray">(Order matters. If you use this feature, put the <code>'Shell::input',</code> line ahead of the others, since it is the only one prepared to deal with username not being the first argument).</font></p>
<p>If you look at CpuTime.pm, you'll see that it's <code>input()</code> function doesn't set or change anything, but does set a package variable to record the start time. Later, when the same module's <code>post_git()</code> function is invoked, it uses this variable to determine elapsed time.</p>
<p><em>(This is a very nice and simple example of how you can implement features by latching onto multiple events and sharing data to do something)</em>.</p>
<p>You can even change the reponame the user sees, behind his back. Alias.pm handles that.</p>
<p>Finally, as an exercise for the reader, consider how you would create a brand new env var that contains the <em>comment</em> field of the ssh pubkey that was used to gain access, using the information <a href="#kfn">here</a>.</p>
<h3 id="rsev"><span class="header-section-number">6.3.5</span> appendix 2: repo-specific environment variables</h3>
<p>A special form of the <a href="#options">option</a> syntax can be used to set repo-specific environment variables that are visible to gitolite triggers and any git hooks you may install.</p>
<p>For example, let's say you installed a post-update hook that initiates a CI job. By default, of course, this hook will be active for <em>all</em> gitolite-managed repos. However, you only want it to run for some specific repos, say r1, r2, and r4.</p>
<p>To do that, first add this to the gitolite.conf:</p>
<pre><code>repo r1 r2 r4
    option ENV.CI = 1</code></pre>
<p>This creates an environment variable called <code>GL_OPTION_CI</code> with the value 1, before any trigger or hook is invoked.</p>
<p>Note: option names <em>must</em> start with <code>ENV.</code>, followed by a seqence of characters composed of alphas, numbers, and the underscore character.</p>
<p>Now the hook running the CI job can easily decide what to do:</p>
<pre><code># exit if $GL_OPTION_CI is not set
[ -z $GL_OPTION_CI ] &amp;&amp; exit

... rest of CI job code as before ...</code></pre>
<p>Of course you can also do the opposite; i.e. decide that the listed repos should <em>not</em> run the CI job but all other repos should:</p>
<pre><code>repo @all
    option ENV.CI = 1

repo r1 r2 r4
    option ENV.CI = &quot;&quot;</code></pre>
<p>(The hook code remains the same as before.)</p>
<p><font color="gray">Before this feature was added, you could still do this, by using the <code>gitolite git-config</code> command inside the hook code to test for options and configs set for the repo, like:</p>
<pre><code>if gitolite git-config -q reponame gitolite-options.option-name
then
    ...</code></pre>
<p>The new method is much more convenient, as you can see.</font></p>
<h3 id="lff"><span class="header-section-number">6.3.6</span> appendix 3: log file format</h3>
<p>Here's a brief description of gitolite's log file format. All fields are tab separated.</p>
<p>There are two kinds of lines in the log file:</p>
<ul>
<li><p>third field non-empty: actual log lines. These are documented below.</p></li>
<li><p>third field empty (i.e., two tabs after the second field): informational output. These are NOT documented and may change without notice. They can be turned off completely by setting the RC variable <code>LOG_EXTRA</code> to 0.</p></li>
</ul>
<p>For all types of log lines, the first two fields are:</p>
<ul>
<li><p>field 1: local time, in YYYY-MM-DD.HH:MM:SS format</p></li>
<li><p>field 2: transaction ID or &quot;TID&quot;. This is actually the PID of the outermost command that was initiated (usually &quot;gitolite-shell&quot;). It helps to keep log lines pertaining to one &quot;run&quot; together, even if several sub-commands are spawned (like for example from triggers, or even the update hook itself).</p></li>
</ul>
<p>The third and later fields are all dependent on what type of log line it is.</p>
<p>The various log line formats are:</p>
<ul>
<li><p><strong>start</strong></p>
<p>This line denotes the beginning of a gitolite operation.</p>
<ul>
<li><p>field 3: 'ssh' or 'http'</p></li>
<li><p>field 4: <code>ARGV=&lt;comma-separated list of command line arguments&gt;</code></p>
<p>Usually this is just the gitolite username (the argument to gitolite-shell, as supplied by the forced command in the authorized keys file). If you're <a href="#giving-shell">giving shell access</a> to some users, this would be &quot;-s,username&quot;. That's two command line arguments (&quot;-s&quot; and the username), comma separated.</p></li>
<li><p>field 5: <code>SOC=&lt;original command from client&gt;</code></p>
<p>This is the command exactly as the git client sent it, or the user typed it. Typically this is one of these:</p>
<pre><code>git-upload-pack 'reponame'
git-receive-pack 'reponame'</code></pre>
<p>(including the single quotes, because that's what the client sent).</p>
<p>Gitolite commands are also recorded as is, so this could be something like <code>info</code> or perhaps <code>perms -l reponame</code> etc.</p></li>
<li><p>field 6: <code>FROM=&lt;ip address&gt;</code></p></li>
</ul></li>
<li><p><strong>pre-git</strong></p>
<p>This log line appears when the first access check succeeds (i.e., before git-upload-pack or git-receive-pack is called).</p>
<ul>
<li>field 3: 'pre_git'</li>
<li>field 4: reponame</li>
<li>field 5: username</li>
<li>field 6: 'R' or 'W'</li>
<li>field 7: 'any'</li>
<li>field 8: the refex that allowed access</li>
</ul></li>
<li><p><strong>update</strong></p>
<p>This log line appears when the second access check succeeds (i.e., when the update hook decides to allow the push).</p>
<ul>
<li>field 3: 'update'</li>
<li>field 4: reponame</li>
<li>field 5: username</li>
<li>field 6: 'W', '+', 'C', 'D', 'WM', '+M', 'CM', or 'DM'</li>
<li>field 7: ref name (like 'refs/heads/master')</li>
<li>field 8: old SHA</li>
<li>field 9: new SHA</li>
<li>field 10: the refex that allowed access</li>
</ul>
<p>The values in field 6 reflect the possible <a href="#write-types">write types</a>, but note that there is a difference between what the log file contains and what the gitolite.conf file contains (e.g., <code>+</code> versus <code>RW+</code>). There's another subtle difference for those who are not thinking clearly: the <code>RW+</code> in the conf file is a permission, but it would show up as a <code>+</code> in the log file only if an <em>actual</em> force push had happened, otherwise it would be just <code>W</code>.</p>
<p>By the way, notice that fields 7 to 9 are exactly what git itself supplies the update hook (see 'man githooks').</p>
<p><font color="gray">There is a special version of this line that appears when someone <a href="#bypass">bypasses</a> gitolite's access control to push directly on the server. The 'reponame' (field 4) is replaced by the full path of the repo being pushed to, the username (field 5) is replaced by the Unix userid in parentheses, and the operation code (field 6) is 'bypass'.</font></p></li>
<li><p><strong>create</strong></p>
<p>This log line appears when a wild repo was auto-created by a user.</p>
<ul>
<li>field 3: 'create'</li>
<li>field 4: reponame</li>
<li>field 5: username</li>
<li>field 6: 'R' or 'W'</li>
</ul>
<p>Field 6 is 'perms-c' if the wild repo is created using the perms command's '-c' option.</p></li>
<li><p><strong>end</strong></p>
<p>This indicates the end of the transaction. Normally, you should not see any more lines with the same TID after this line.</p>
<ul>
<li>field 3: 'END'</li>
</ul></li>
<li><p><strong>warnings</strong> and <strong>errors</strong></p>
<p>Typically seen when access is denied.</p>
<ul>
<li>field 3: 'warn' or 'die'</li>
<li>field 4: message. Parts of the message (like reponame, username, etc) are not split out into fields, though.</li>
</ul></li>
<li><p><strong>cli</strong></p>
<p>This logs gitolite sub-commands run directly on the server, like <code>gitolite setup</code> etc.</p>
<ul>
<li>field 3: 'cli'</li>
<li>field 4: 'gitolite'</li>
<li>field 5 to end: arguments supplied to gitolite command, one per field</li>
</ul></li>
</ul>
<h2 id="vref"><span class="header-section-number">6.4</span> virtual refs</h2>
<!-- pandoc: toc -->

<p><strong>IMPORTANT</strong>: fallthru is success in VREFs, unlike the normal refs. That won't make sense until you read further, but I had to put it up here for folks who stop reading halfway!</p>
<hr />
<p>VREFs are a mechanism to add additional constraints to a push.</p>
<p>Here's an example to start you off.</p>
<p>To disallow junior developers from changing more than five files, or from touching the Makefile, you can do this:</p>
<pre><code>repo foo
    RW+                     =   @all-devs
    -   VREF/COUNT/5        =   @junior-devs
    -   VREF/NAME/Makefile  =   @junior-devs</code></pre>
<hr />
<h3 id="basic-use"><span class="header-section-number">6.4.1</span> basic use</h3>
<p>Normally, rules deal with branches and tags (which git collectively calls &quot;refs&quot;). The &quot;ref&quot; is a property of the push which gitolite checks against the set of rules.</p>
<p>VREFs (&quot;virtual refs&quot;) are other properties of a push that gitolite can be told to check, in addition to the normal ref. For example, &quot;this push has more than 5 changed files&quot; could be one property. Or &quot;this push changed the file called Makefile&quot; could be another.</p>
<p>The simplest way to use them is as <em>additional</em> &quot;deny&quot; rules to fail a push that might otherwise have passed. This is what the example at the top shows. Using VREFs like this does not require any great understanding of, or thinking about, how they work under the hood.</p>
<h3 id="advanced-use"><span class="header-section-number">6.4.2</span> advanced use</h3>
<p>More complex uses are possible, but may be harder to understand. You may want to experiment with the rules to solidify your understanding as you read this.</p>
<h4 id="differences-from-normal-refs"><span class="header-section-number">6.4.2.1</span> differences from normal refs</h4>
<p>We know where normal refs (like &quot;refs/heads/master&quot; or &quot;refs/tags/v1.0&quot;) come from -- they are supplied by git itself when it calls the update hook.</p>
<p>VREFs have two differences with normal refs:</p>
<ul>
<li>gitolite has to generate them somehow</li>
<li>fallthru is success, not failure</li>
</ul>
<p>Here's some more detail on how it works.</p>
<ul>
<li><p>first, the normal (&quot;real&quot;) ref is checked.</p>
<p>As you already know, the push dies if the ref hits a deny rule <strong>or</strong> it falls through without hitting an allow rule.</p></li>
<li><p>next, VREFs are generated and checked one by one.</p>
<p>We'll talk about the generaton later, but for the check, a VREF dies (and kills the push) <em>only</em> if it meets an explicit deny rule (&quot;-&quot;). Fallthru does <em>not</em> cause failure of a VREF.</p>
<p><a href="#refex">refex</a> and <a href="#rules">rules</a> still apply, but several parts of the latter are just not relevant to VREFs (since VREFs only run from the update hook). Plus of course, as we said, fallthru is not a failure now.</p></li>
</ul>
<h4 id="generating-virtual-refs"><span class="header-section-number">6.4.2.2</span> generating virtual refs</h4>
<p>Gitolite uses the VREF rules themselves to help it generate the virtual refs.</p>
<p>Specifically, it looks at each rule that contains a VREF (there are 2 in the above example) and calls a VREF-maker for each of them.</p>
<p>We'll take the COUNT example rule above.</p>
<p>When gitolite sees that rule, it calls the &quot;COUNT&quot; VREF-maker. Specifically, this is the <code>VREF/COUNT</code> program (See <a href="#cust">here</a> for actual locations on disk).</p>
<p>Gitolite passes it the string &quot;5&quot; as an argument (actually, as the <em>eighth</em> argument; details later).</p>
<p>The program (which can be written in any language) is expected to do one of two things:</p>
<ul>
<li><p>if the condition is satisfied (i.e., there <em>are</em> more than 5 files in this push), it should print <code>VREF/COUNT/5</code> to STDOUT.</p></li>
<li><p>otherwise it should print nothing.</p></li>
</ul>
<p>It should exit with an exit code of zero in either case.</p>
<p>If it exits with a non-zero, the push dies regardless of what is printed (see &quot;mimicking a plain old update hook&quot; for why this is useful).</p>
<h3 id="more-details-and-nuances"><span class="header-section-number">6.4.3</span> more details and nuances</h3>
<h4 id="mimicking-a-plain-old-update-hook"><span class="header-section-number">6.4.3.1</span> mimicking a plain old update hook</h4>
<p>If the VREF maker exists with a non-zero exit code, then regardless of what it prints or does not, the push dies.</p>
<p>This is just like a plain 'update' hook. Since the first 3 arguments (see later) are also the same that a plain 'update' hook receives, you can actually use any existing update hook as a VREF-maker.</p>
<p>To repurpose an existing update hook as a VREF-maker, just copy it to the VREF directory (again, see <a href="#cust">here</a> for actual locations on disk). Then add this rule to your repos:</p>
<pre><code>repo foo    # or maybe even 'repo @all'
    -   VREF/my-update-hook     =   @all</code></pre>
<p>That's it.</p>
<h4 id="what-if-the-vref-maker-prints-a-different-vref"><span class="header-section-number">6.4.3.2</span> what if the VREF-maker prints a different VREF?</h4>
<p>Unless you know what you're upto, don't do that.</p>
<p>But it's allowed and the behaviour is defined. The VREF-maker for the NAME VREF is a good example. It ignores the arguments and just makes VREFs out of the name of every file that was changed in the push.</p>
<p>Here's another example. Consider the problem of not allowing pushes at specific times. Let's say repo 'foo' cannot be pushed between 4 and 7pm, and repo 'bar' can only be pushed before 9am. And of course all this only applies to the junior developers, the poor guys!</p>
<pre><code>repo foo
    RW+                         =   @all
    -   VREF/Hour/16            =   @junior-devs
    -   VREF/Hour/17            =   @junior-devs
    -   VREF/Hour/18            =   @junior-devs

repo bar
    RW+                         =   @all
    -   VREF/Hour/09            =   @junior-devs
    -   VREF/Hour/1[0-9]        =   @junior-devs
    -   VREF/Hour/2[0-9]        =   @junior-devs</code></pre>
<p>In this example, we write the &quot;Hour&quot; VREF-maker to <em>ignore the argument passed</em> and just print <code>VREF/Hour/NN</code> where NN can be between 00 to 23 inclusive and of course represents the current hour.</p>
<p>if foo is pushed at 6:30pm, the VREF-maker prints VREF/Hour/18, which satisfies the third rule and is rejected.</p>
<p>If bar is pushed at, say, 7:20am, the vref printed is VREF/Hour/07, which does not match any of the rules. And fallthru is success so it passes.</p>
<h4 id="vref-fallthru"><span class="header-section-number">6.4.3.3</span> why is fallthru considered success with VREFs</h4>
<p>Virtual refs are <strong>best used</strong> (1) as additional &quot;deny&quot; rules, performing extra checks that core gitolite cannot. You usually want such extra checks only for some people.</p>
<p>When fallthru is success, you can simply <em>ignore</em> all the other users (for whom such additional checks are not needed).</p>
<p>If fallthru were to be considered 'failure', you'd be forced to add a &quot;success rule&quot; like this for <em>every</em> vref you used in this repo, in each case listing every user who was not already mentioned in the context of that vref:</p>
<pre><code>RW+ VREF/VREFNAME   =   @userlist   # uggh! what a pain!</code></pre>
<p>Worse, since every virtual ref involves calling an external program, many of these calls may be wasted.</p>
<p><font color="gray">(1) &quot;best used as...&quot; does not mean &quot;only used as...&quot;. For example it's perfectly easy to turn this around if, instead of having a list of people who <em>do</em> need extra checks, all you have is the complementary list:</p>
<pre><code>RW+ VREF/NAME/Makefile      =   @senior-devs
-   VREF/NAME/Makefile      =   @all</code></pre>
<p></font></p>
<h4 id="what-if-the-vref-maker-prints-something-thats-not-even-a-vref"><span class="header-section-number">6.4.3.4</span> what if the VREF-maker prints something that's not even a VREF?</h4>
<p>The VREF-maker can print anything it wants to STDOUT. Lines not starting with <code>VREF/</code> are printed as is (so your VREF-maker can do mostly-normal printing to STDOUT). This is especially useful if you've turned an existing update hook into a VREF-maker, and it prints stuff but you don't want to touch the code.</p>
<p>For lines starting with <code>VREF/</code>, the first word in each such line will be treated as a virtual ref, while the rest, if any, is a message to be added to the standard &quot;...DENIED...&quot; message that gitolite will print if that refex matches and the rule is a deny rule.</p>
<h4 id="in-what-order-are-vref-makers-called"><span class="header-section-number">6.4.3.5</span> in what order are VREF-makers called?</h4>
<p>VREF-makers are called in the sequence in which they appear in the conf file.</p>
<p>There are some optimisations to prevent calling the same VREF-maker with the same arguments more than once, and the VREF-maker code for the NAME VREF (which is special) is called only once regardless of how many times it appears but these details should not concern anyone but a developer.</p>
<h4 id="vref-args"><span class="header-section-number">6.4.3.6</span> what arguments are passed to the vref-maker?</h4>
<ul>
<li><p>Arguments <strong>1, 2, 3</strong>: the 'ref', 'oldsha', and 'newsha' that git passed to the update hook (see 'man githooks').</p>
<p>This, combined with the fact that non-zero exits are detected, mean that you can simply use an existing update.secondary as a VREF-maker as-is, no changes needed.</p></li>
<li><p>Arguments <strong>4 and 5</strong>: the 'oldtree' and 'newtree' SHAs. These are the same as the oldsha and newsha values, except if one of them is all-0. (indicating a ref creation or deletion). In that case the corresponding 'tree' SHA is set (by gitolite, as a courtesy) to the special SHA <code>4b825dc642cb6eb9a060e54bf8d69288fbee4904</code>, which is the hash of an empty tree.</p>
<p>(None of these shenanigans would have been needed if <code>git diff $oldsha $newsha</code> would not error out when passed an all-0 SHA.)</p></li>
<li><p>Argument <strong>6</strong>: the attempted access flag. Typically <code>W</code> or <code>+</code>, but could also be <code>C</code>, <code>D</code>, or any of these 4 followed by <code>M</code>. If you have to ask what they mean, you haven't read enough gitolite documentation to be able to make virtual refs work.</p></li>
<li><p>Argument <strong>7</strong>: is the entire refex; say <code>VREF/COUNT/3/NEWFILES</code>.</p></li>
<li><p>Arguments <strong>8 onward</strong>: are the split out (by <code>/</code>) portions of the refex, excluding the first two components. In our example they would be <code>3</code> followed by <code>NEWFILES</code>.</p></li>
</ul>
<p>Yes, argument 7 is redundant if you have 8 and 9. It's meant to make it easy to write vref-maker scripts in any language. See script examples in source.</p>
<h3 id="vref-makers-shipped-with-gitolite"><span class="header-section-number">6.4.4</span> VREF-makers shipped with gitolite</h3>
<h4 id="NAME"><span class="header-section-number">6.4.4.1</span> restricting pushes by dir/file name</h4>
<p>The &quot;NAME&quot; VREF allows you to restrict pushes by the names of dirs and files changed. (Side note: the NAME VREF is the only one directly implemented within the update hook, so you won't find it in the VREF directory).</p>
<p>Here's an example. Say you don't want junior developers pushing changes to the Makefile, because it's quite complex:</p>
<pre><code>repo foo
        RW+                             =   @senior_devs
        RW                              =   @junior_devs

        -   VREF/NAME/Makefile          =   @junior_devs</code></pre>
<p>When a senior dev pushes, the VREF is not invoked at all. But when a junior dev pushes, the VREF is invoked, and it returns a list of files changed <strong>as refs</strong>, looking like this:</p>
<pre><code>VREF/NAME/file-1
VREF/NAME/dir-2/file-3
...etc...</code></pre>
<p>Each of these refs is matched against the access rules. If one of them happens to be the Makefile, then the ref returned (VREF/NAME/Makefile) will match the deny rule and kill the push.</p>
<p>Another way to use this is when you know what is allowed instead of what is not allowed. Let's say the QA person is only allowed to touch a file called CHANGELOG and any files in a directory called ReleaseNotes:</p>
<pre><code>repo foo
        RW+                             =   @senior_devs
        RW                              =   @junior_devs
        RW+                             =   QA-guy

        RW+ VREF/NAME/CHANGELOG         =   QA-guy
        RW+ VREF/NAME/ReleaseNotes/     =   QA-guy
        -   VREF/NAME/                  =   QA-guy</code></pre>
<h4 id="COUNT"><span class="header-section-number">6.4.4.2</span> number of changed or new files</h4>
<p>The COUNT VREF is used like this:</p>
<pre><code>-   VREF/COUNT/9                    =   @junior-developers</code></pre>
<p>In response, if anyone in the user list pushes a commit series that changes more than 9 files, a vref of &quot;VREF/COUNT/9&quot; is returned. Gitolite uses that as a &quot;ref&quot; to match against all the rules, hits the same rule that invoked it, and denies the request.</p>
<p>If the user did not push more than 9 files, the VREF code returns nothing, and nothing happens.</p>
<p>COUNT can take one more argument:</p>
<pre><code>-   VREF/COUNT/9/NEWFILES           =   @junior-developers</code></pre>
<p>This is the same as before, but have to be more than 9 <em>new</em> files not just changed files.</p>
<h4 id="advanced-filetype-detection"><span class="header-section-number">6.4.4.3</span> advanced filetype detection</h4>
<p>Note: this is more for illustration than use; it's rather specific to one of the projects I manage but the idea is the important thing.</p>
<p>Sometimes a file has a standard extension (that cannot be 'gitignore'd), but it is actually automatically generated. Here's one way to catch it:</p>
<pre><code> -   VREF/FILETYPE/AUTOGENERATED     =   @all</code></pre>
<p>You can look at <code>src/VREF/FILETYPE</code> to see how it handles the 'AUTOGENERATED' option. You could also have a more generic option, like perhaps BINARY, and handle that in the FILETYPE vref too.</p>
<h4 id="checking-author-email"><span class="header-section-number">6.4.4.4</span> checking author email</h4>
<p>Some people want to ensure that &quot;you can only push your own commits&quot;.</p>
<p>If you force it on everyone, this is a very silly idea (see &quot;Philosophical Notes&quot; section of <code>src/VREF/EMAIL-CHECK</code>).</p>
<p>But there may be value in enforcing it just for the junior developers.</p>
<p>The neat thing is that the existing <code>contrib/update.email-check</code> was just copied to <code>src/VREF/EMAIL-CHECK</code> and it works, because VREFs get the same first 3 arguments and those are all that it cares about. (Note: you have to change one subroutine in that script if you want to use it)</p>
<h4 id="votes"><span class="header-section-number">6.4.4.5</span> voting on commits</h4>
<p>Although gitolite can't/won't do the whole &quot;code review + workflow enforcement&quot; thing that Gerrit Code Review does, a basic implementation of voting on a commit is surprisingly easy. See src/VREF/VOTES for details (and note that the actual <em>code</em> is just 2-3 lines; the rest is inline documentation).</p>
<h3 id="other-ideas----code-welcome"><span class="header-section-number">6.4.5</span> other ideas -- code welcome!</h3>
<h4 id="no-non-merge-first-parents"><span class="header-section-number">6.4.5.1</span> &quot;no non-merge first-parents&quot;</h4>
<p>Shruggar on #gitolite wanted this. Possible code to implement it would be something like this (untested)</p>
<pre><code>[ -z &quot;$(git rev-list --first-parent --no-merges $2..$3)&quot; ]</code></pre>
<p>This can be implemented using <code>src/VREF/MERGE-CHECK</code> as a model. That script does what the 'M' qualifier does in access rules (see last part of <a href="#write-types">this</a>), although the syntax to be used in conf/gitolite will be quite different.</p>
<h4 id="other-ideas-for-vrefs"><span class="header-section-number">6.4.5.2</span> other ideas for VREFs</h4>
<p>Here are some more ideas:</p>
<ul>
<li>Number of commits (<code>git rev-list --count $old $new</code>).</li>
<li>Number of binary files in commit (currently I only know to count occurrences of <code>Bin</code> in the output of <code>git diff --stat</code>.</li>
<li>Number of <em>new</em> binary files (count <code>Bin 0 -&gt;</code> in <code>git diff --stat</code> output).</li>
<li>Time of day/day of week (see example snippet somewhere above).</li>
<li>IP address.</li>
<li>Phase of the moon.</li>
</ul>
<p>Note that pretty much anything that involves <code>$oldsha..$newsha</code> will have to deal with the issue that when you push a new tag or branch, the &quot;old&quot; part is all 0's, and unless you consider <code>--all</code> existing branches and tags it becomes meaningless in terms of &quot;number of new files&quot; etc.</p>
<h2 id="triggers"><span class="header-section-number">6.5</span> gitolite triggers</h2>
<!-- pandoc: toc -->

<h3 id="intro-and-sample-rc-excerpt"><span class="header-section-number">6.5.1</span> intro and sample rc excerpt</h3>
<p>Gitolite fires off external commands at several different times. The <a href="#rc">rc</a> file specifies what commands to run at each trigger point, but for illustration, here's an excerpt. <strong>Note that as of v3.4, this is <em>not</em> how the rc file looks like externally. Please see <a href="#addtrig">this</a> for more</strong>.</p>
<pre><code>%RC = (

    &lt;...several lines later...&gt;

    # comment out or uncomment as needed
    # these will run in sequence after post-update
    POST_COMPILE                =&gt;
        [
            'post-compile/ssh-authkeys',
            'post-compile/update-git-configs',
            'post-compile/update-gitweb-access-list',
            'post-compile/update-git-daemon-access-list',
        ],

    # comment out or uncomment as needed
    # these will run in sequence after a new wild repo is created
    POST_CREATE                 =&gt;
        [
            'post-compile/update-git-configs',
            'post-compile/update-gitweb-access-list',
            'post-compile/update-git-daemon-access-list',
        ],</code></pre>
<p>(As you can see, post-create runs 3 programs that also run from post-compile. This is perfectly fine, by the way)</p>
<h3 id="types-of-trigger-programs"><span class="header-section-number">6.5.2</span> types of trigger programs</h3>
<p>There are two types of trigger programs. Standalone scripts are placed in src/triggers or its subdirectories. They are invoked by being added to a trigger list (using the path after &quot;src/triggers/&quot;, as you can see). Such scripts are quick and easy to write in any language of your choice.</p>
<p>Triggers written as perl modules are placed in src/lib/Gitolite/Triggers. They are invoked by being listed with the package+function name, although even here the 'Gitolite::Triggers' part is skipped. Perl modules have to follow some conventions (see some of the shipped modules to ideas) but the advantage is that they can set environment variables and change the argument list of the gitolite-shell program that invokes them.</p>
<p>If this does not make sense, please examine a default install of gitolite, paying attention to:</p>
<ul>
<li>the path names in various trigger lists in the rc file</li>
<li>corresponding path names in the src/ directory in gitolite source</li>
<li>and for perl modules, the package names and function names within.</li>
</ul>
<h3 id="manually-firing-triggers"><span class="header-section-number">6.5.3</span> manually firing triggers</h3>
<p>...from the server command line is easy. For example:</p>
<pre><code>gitolite trigger POST_COMPILE</code></pre>
<p>However if the triggered code depends on arguments (see next section) this won't work. (The <code>POST_COMPILE</code> trigger programs all just happen to not require any arguments, so it works).</p>
<h3 id="common-arguments"><span class="header-section-number">6.5.4</span> common arguments</h3>
<p>Triggers receive the following arguments:</p>
<ol style="list-style-type: decimal">
<li><p>any arguments mentioned in the rc file (for an example, see the renice command)</p></li>
<li><p>the name of the trigger as a string (example, <code>&quot;POST_COMPILE&quot;</code>), so you can call the same program from multiple triggers and it can know where it was called from,</p></li>
<li><p>followed by zero or more arguments specific to the trigger, as given in the next section.</p></li>
</ol>
<h3 id="trigger-specific-arguments-and-other-details"><span class="header-section-number">6.5.5</span> trigger-specific arguments and other details</h3>
<p>Here are the <strong>rest of</strong> the arguments for each trigger, plus a brief description of when the trigger runs:</p>
<ul>
<li><p><code>INPUT</code> runs before pretty much anything else. INPUT trigger scripts <em>must</em> be in perl, since they manipulate the arguments to and the environment of the 'gitolite-shell' program itself. Most commonly they will read/change <code>@ARGV</code>, and/or <code>$ENV{SSH_ORIGINAL_COMMAND}</code>.</p>
<p>There are certain conventions to adhere to; please see some of the shipped samples or ask me if you need help writing your own.</p></li>
<li><code>ACCESS_1</code> runs after the first access check. Extra arguments:
<ul>
<li>repo</li>
<li>user</li>
<li>'R' or 'W'</li>
<li>'any'</li>
<li>result (see notes below)</li>
</ul>
<p>'result' is the return value of the access() function. If it contains the uppercase word &quot;DENIED&quot;, the access was rejected. Otherwise it is the refex that caused the access to succeed.</p>
<p><em>Please note that if access is rejected, gitolite-shell will die as soon as it returns from the trigger</em>.</p></li>
<li><code>ACCESS_2</code> runs after the second access check, which is invoked by the update hook to check the ref. Extra arguments:
<ul>
<li>repo</li>
<li>user</li>
<li>any of W, +, C, D, WM, +M, CM, DM</li>
<li>the ref being updated (e.g., 'refs/heads/master')</li>
<li>result</li>
<li>old SHA</li>
<li>new SHA</li>
</ul>
<p><code>ACCESS_2</code> also runs on each <a href="#vref">VREF</a> that gets checked. In this case the &quot;ref&quot; argument will start with &quot;VREF/&quot;, and the last two arguments won't be passed.</p>
<p>'result' is similar to <code>ACCESS_1</code>, except that it is the <em>update hook</em> which dies as soon as access is rejected for the ref or any of the VREFs. Control then returns to git, and then to gitolite-shell, so the <code>POST_GIT</code> trigger <em>will</em> run.</p></li>
<li><code>PRE_GIT</code> and <code>POST_GIT</code> run just before and after the git command. Extra arguments:
<ul>
<li>repo</li>
<li>user</li>
<li>'R' or 'W'</li>
<li>'any'</li>
<li>the git command ('git-receive-pack', 'git-upload-pack', or 'git-upload-archive') being invoked.</li>
</ul>
<p><strong>NOTE</strong> that the <code>POST_GIT</code> trigger has no way of knowing if the push succeeded, because 'git-shell' (or maybe 'git-receive-pack', I don't know) exits cleanly even if the update hook died.</p></li>
<li><code>PRE_CREATE</code> and <code>POST_CREATE</code> run just before and after a new &quot;<a href="#wild">wild</a>&quot; repo is created by user action. In addition, any command that creates a repo (like 'fork') or potentially changes permissions (like 'perms') may choose to run <code>POST_CREATE</code>. Extra arguments:
<ul>
<li>repo</li>
<li>user</li>
<li>invoking operation
<ul>
<li>'R' for fetch/clone/ls-remote, 'W' for push</li>
<li>can also be anything set by the external command running the trigger (e.g., see the perms and fork commands). This lets the trigger code know how it was invoked.</li>
</ul></li>
</ul>
They are also run when a <em>normal</em> repo is created (say by adding a &quot;repo foo&quot; line to the conf file). This case has only one extra argument:
<ul>
<li>repo</li>
</ul></li>
<li><p><code>POST_COMPILE</code> runs after an admin push has successfully &quot;compiled&quot; the config file. By default, the next thing is to update the ssh authkeys file, then all the 'git-config's, gitweb access, and daemon access.</p>
<p>No extra arguments.</p></li>
</ul>
<h3 id="addtrig"><span class="header-section-number">6.5.6</span> adding your own scripts to a trigger</h3>
<p>For gitolite v3.3 or less, adding your own scripts to a trigger list was simply a matter of finding the trigger name in the rc file and adding an entry to it. Even for gitolite v3.4 or higher, if your rc file was created before v3.4, <em>it will continue to work, and you can continue to add triggers to it the same way as before</em>.</p>
<p>However, if you installed gitolite v3.4 or higher, you will see a different rc file syntax. This new rc file does not have trigger lists, but a simple list of &quot;features&quot; within a list called &quot;ENABLE&quot; in the rc file; you simply comment out or uncomment appropriate entries, and gitolite will <em>internally</em> create the trigger lists correctly.</p>
<p>...which is fine for triggers that are shipped with gitolite, but now you're wondering how to add your own.</p>
<p>The answer is: same as before.</p>
<p>Here's an example. Let's say you wrote yourself a trigger script called 'foo', to be invoked from the <code>POST_CREATE</code> trigger list. With the old format, you'd find the following lines in the rc file:</p>
<pre><code>POST_CREATE                 =&gt;
    [
        'post-compile/update-git-configs',
        'post-compile/update-gitweb-access-list',
        'post-compile/update-git-daemon-access-list',
    ],</code></pre>
<p>and you'd simply add a line for 'foo' in that list.</p>
<p>With the new format, since there is no <code>POST_CREATE</code> trigger list defined in the rc file, you'll need to add all this:</p>
<pre><code>POST_CREATE                 =&gt;
    [
        'foo'
    ],</code></pre>
<p>instead of just the 'foo' line.</p>
<p>Since the ENABLE list pulls in the rest of the trigger entries, this will be <em>effectively</em> as if you had done this in a v3.3 rc file:</p>
<pre><code>POST_CREATE                 =&gt;
    [
        'foo',
        'post-compile/update-git-configs',
        'post-compile/update-gitweb-access-list',
        'post-compile/update-git-daemon-access-list',
    ],</code></pre>
<p>As you can see, the 'foo' gets added to the top of the list.</p>
<h4 id="displaying-the-resulting-trigger-list"><span class="header-section-number">6.5.6.1</span> displaying the resulting trigger list</h4>
<p>You can use the 'gitolite query-rc' command to see what the trigger list actually looks like. For example:</p>
<pre><code>gitolite query-rc POST_CREATE</code></pre>
<h3 id="tips-1"><span class="header-section-number">6.5.7</span> tips</h3>
<p>If you have code that latches onto more than one trigger, collecting data (such as for logging), then the outputs may be intermixed. You can record the value of the environment variable <code>GL_TID</code> to tie together related entries.</p>
<h1 id="s7"><span class="header-section-number">7</span> ssh</h1>
<h2 id="ssh"><span class="header-section-number">7.1</span> ssh</h2>
<p>If you're installing gitolite, you're a &quot;system admin&quot;, like it or not. If you're using the default ssh mode (i.e., not <a href="#http">http</a> mode), ssh is a necessary skill. Please take the time to learn at least enough to get passwordless access working.</p>
<p>You <strong>must</strong> read both these documents before asking for help:</p>
<ul>
<li><p><a href="#glssh">Gitolite and ssh</a> explains how gitolite uses openssh features to create any number of virtual users over just one actual (unix) user, and distinguish between them by their public keys.</p></li>
<li><p><a href="#sts">Ssh troubleshooting</a> is a rather long document that, as far as I know, covers almost every known ssh related issue. If you find something missing, send me an email with details so I can update it.</p></li>
</ul>
<h2 id="auth"><span class="header-section-number">7.2</span> authentication versus authorisation</h2>
<p>This document will explain why an &quot;ssh issue&quot; is almost never a &quot;gitolite issue&quot;, and, indirectly, why I dont get too excited about the former.</p>
<p>Note: for actual ssh troubleshooting see <a href="#sts">this</a>.</p>
<p>Here is a fundamental point: <font color="red"><strong>Gitolite does not do authentication. It only does authorisation</strong>.</font></p>
<p>So first, let's loosely define these words:</p>
<blockquote>
<p><strong>Authentication</strong> is the process of verifying that you are who you claim to be. An authentication system will establish that I am the user &quot;sitaram&quot; on my work system. The one behind gmail will similarly establish that I am &quot;sitaramc&quot;. And so on...</p>
</blockquote>
<blockquote>
<p><strong>Authorisation</strong> is the process of asking what you want to do and deciding if you're allowed to do it or not.</p>
</blockquote>
<p>Now, if you managed to read about <a href="#glssh">gitolite and ssh</a>, you know that gitolite is meant to be invoked as:</p>
<pre><code>/full/path/to/gitolite-shell some-authenticated-gitolite-username</code></pre>
<p>(where the &quot;gitolite username&quot; is a &quot;virtual&quot; username; it does not have to be, and usually <em>isn't</em>, an actual <em>unix</em> username).</p>
<p>As you can see, authentication happens before gitolite is called.</p>
<h3 id="but...-but...-you-have-all-that-ssh-stuff-in-gitolite"><span class="header-section-number">7.2.1</span> but... but... you have all that ssh stuff in gitolite!</h3>
<p>No I don't. Not in &quot;core&quot; gitolite from g3 onwards :-)</p>
<p>The default setup does use ssh keys, but it's only helping you <strong>setup</strong> ssh-based authentication <strong>as a convenience to you</strong>. But in fact it is a <em>completely</em> separate program that you can disable (in the rc file) or replace with something else of your choice.</p>
<p>For example, in both <a href="#http">smart http</a> and ldap-backed sshd, gitolite has no role to play in creating users, setting up their passwords/keys, etc.</p>
<h3 id="so-youre-basically-saying-you-wont-support-x"><span class="header-section-number">7.2.2</span> so you're basically saying you won't support &quot;X&quot;</h3>
<p>(where &quot;X&quot; is some ssh related behaviour change or feature)</p>
<p>Well, if it's not a security issue I won't. But since it's no longer part of &quot;core&quot; gitolite, I can be much more relaxed about taking patches, or even alternative implementations.</p>
<p>While we're on the subject, locking someone out is <em>not</em> a security issue. Even if you <a href="#lost-key">lost the admin key</a>, the docs tell you how to recover from such errors. You do need some password based method to get a shell command line on the server, of course.</p>
<h3 id="otherauth"><span class="header-section-number">7.2.3</span> how to use other authentication systems with gitolite</h3>
<p>The bottom line in terms of how to invoke gitolite has been described above, and as long as you manage to do that gitolite won't even know how the authentication was done. Which in turn means you can use whatever authentication scheme you want.</p>
<p>It also expects the <code>SSH_ORIGINAL_COMMAND</code> environment variable to contain the full command (typically starting with git-receive-pack or git-upload-pack) that the client sent. Also, when using <a href="#http">smart http</a>, things are somewhat different: gitolite uses certain environment variables that it expects httpd to have set up. Even the user name comes from the <code>REMOTE_USER</code> environment variable instead of as a command line argument in this case.</p>
<p>However, it has to be an authentication system that is compatible with sshd or httpd in some form. Why? Because the git <em>client</em> accessing the server only knows those 2 protocols to &quot;speak git&quot;. (Well, the <code>git://</code> protocol is unauthenticated, and <code>file://</code> doesn't really apply to this discussion, so we're ignoring those).</p>
<p>For example, let's say you have an LDAP-based authentication system somewhere. It is possible to make apache use that to authenticate users, so when a user accesses a git url using <code>http://sitaram:password@git.example.com/repo</code>, it is LDAP that does the actual authentication. [I wouldn't know how to do it but I know it is possible. Patches to this doc explaining how are welcome!]</p>
<p>There are also ssh daemons that use LDAP to store the authorised keys (instead of putting them all in <code>~/.ssh/authorized_keys</code>). The clients will still need to generate keypairs and send them to the admin, but they can be more centrally stored and perhaps used by other programs or tools simultaneously, which can be useful.</p>
<h3 id="ldap"><span class="header-section-number">7.2.4</span> getting user group info from LDAP</h3>
<p>Gitolite's <a href="#groups">groups</a> are pretty convenient, but some organisations already have similar (or sufficient) information in their LDAP store.</p>
<p>Gitolite can tap into that information, with a little help. Write a program which, given a username, queries your LDAP store and returns a space-separated list of groups that the user is a member of. Then put the full path to this program in an <a href="#rc">rc</a> variable called <code>GROUPLIST_PGM</code>, like so:</p>
<pre><code>GROUPLIST_PGM           =&gt;  '/home/git/bin/ldap-query-groups',</code></pre>
<p>Now you can use those groupnames in access rules in gitolite, because the user is a member of those groups as well as any normal gitolite groups you may have added him to in the conf file.</p>
<p>Caution: your program must do its own logging if you want the audit trail of &quot;why/how did this user get access to this repo at this time?&quot; to resolve properly. Gitolite does not do any logging of the results of the queries because for people who don't need it that would be a huge waste.</p>
<h2 id="glssh"><span class="header-section-number">7.3</span> how gitolite uses ssh</h2>
<!-- pandoc: toc -->

<p>Although other forms of authentications exist (see the document on <a href="#auth">authentication versus authorisation</a>), ssh is the one that most git users use.</p>
<p><strong><em>Therefore, gitolite is (usually) heavily dependent on ssh</em></strong>.</p>
<p>Most people didn't realise this, and even if they did they don't know ssh well enough to help themselves. If you don't understand how ssh public key authentication works, or how the <code>~/.ssh/authorized_keys</code> file can be used to restrict users, etc., you will have endless amounts of trouble getting gitolite to work, because you'll be attacking the wrong problem.</p>
<p>So please please please understand this before tearing your hair out and blaming <strong><em>git/gitolite</em></strong> for whatever is going wrong with your setup :-)</p>
<h3 id="ssh-basics"><span class="header-section-number">7.3.1</span> ssh basics</h3>
<p>Let's start with some basics, focusing <em>only</em> on the pieces relevant to <code>gitolite</code>. If this is not detailed enough, please use google and learn more from somewhere, or maybe buy the OReilly ssh book.</p>
<ul>
<li><p>You can login to an ssh server by typing a password, but ssh can also use <strong><em>public-private keys</em></strong> (also called &quot;key pairs&quot;) for authentication. <code>gitolite</code> <em>requires</em> you to use this mechanism for your users -- they cannot log in using passwords. Hopefully by the time you finish reading this document you will understand why :-)</p>
<p>The way you set this up is you generate a key pair on your workstation, and give the server the public key. (I need not add that the &quot;private&quot; key must be, well, kept <em>private</em>!)</p></li>
<li><p><strong>Generating a key pair on your workstation</strong> is done by running the command <code>ssh-keygen -t rsa</code>. This produces two files in <code>~/.ssh</code>. One is <code>id_rsa</code>; this is the <strong>private</strong> key -- <strong><em>never</em></strong> let it out of your machine. The other is <code>id_rsa.pub</code>, which is the corresponding public key. This public key is usually just one long line of text.</p>
<ul>
<li>On Windows machines with msysgit installed, you should do this from within a &quot;git bash&quot; window. The command will report the full path where the files have been written; make a note of this, and use those files in any of the description that follows.</li>
</ul></li>
<li><p><strong>Adding your public key to the server</strong>'s <code>~/.ssh/authorized_keys</code> file is how ssh uses pubkeys to authenticate users. Let's say sita@work.station is trying to log in as git@serv.er. What you have to do is take the <code>~/.ssh/id_rsa.pub</code> file for user sita on work.station and append its contents (remember it's only one line) to <code>~/.ssh/authorized_keys</code> for user git on serv.er.</p>
<p>The <code>authorized_keys</code> file can have multiple public keys (from many different people) added to it so any of them can log in to git@serv.er.</p>
<p>In the normal case (not gitolite, but your normal everyday shell access), there's a command that does this, <code>ssh-copy-id</code>, which also fixes up permissions etc., as needed, since sshd is a little picky about allowing pubkey access if permissions on the server are loose. Or you can do it manually, as long as you know what you're doing and you're careful not to erase or overwrite the existing contents of <code>~/.ssh/authorized_keys</code> on the server!</p>
<p>But with gitolite, it does this for you; see <a href="#users">adding and removing users</a> for more.</p>
<ul>
<li><strong>Troubleshooting pubkey authentication failures</strong>: if you are unable to get ssh access to the server after doing all this, you'll have to look in <code>/var/log/secure</code> or <code>/var/log/auth.log</code> or some such file on the server to see what specific error <code>sshd</code> is complaining about.</li>
</ul></li>
<li><p><strong>Restricting users to specific commands</strong> is very important for gitolite. If you read <code>man sshd</code> and look for <code>authorized_keys file format</code>, you'll see a lot of options you can add to the public key line, which restrict the incoming user in various ways. In particular, note the <code>command=</code> option, which means &quot;regardless of what the incoming user is asking to do, forcibly run this command instead&quot;.</p>
<p>Also note that when there are many public keys (i.e., lines) in the <code>authorized_keys</code> file, each line can have a <em>different</em> set of options and <code>command=</code> values.</p>
<p>Without this <code>command=</code> option, the ssh daemon will simply give you a shell, which is not what we want for our gitolite keys (although we may well have other keys which we use to get a shell).</p>
<p><strong>This is the backbone of what makes gitolite work; please make sure you understand this</strong>.</p></li>
</ul>
<h3 id="how-does-gitolite-use-all-this-ssh-magic"><span class="header-section-number">7.3.2</span> how does gitolite use all this ssh magic?</h3>
<p>These are two different questions you ought to be having by now:</p>
<ul>
<li>How does it distinguish between me and someone else, since we're all logging in as the same remote user &quot;git&quot;.</li>
<li>How does it restrict what I can do within a repository.</li>
</ul>
<h4 id="restricting-shell-accessdistinguishing-one-user-from-another"><span class="header-section-number">7.3.2.1</span> restricting shell access/distinguishing one user from another</h4>
<p>The answer to the first question is the <code>command=</code> we talked about before. If you look in the <code>authorized_keys</code> file, you'll see entries like this (I chopped off the ends of course; they're pretty long lines):</p>
<pre><code>command=&quot;[path]/gitolite-shell sitaram&quot;,[more options] ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA18S2t...
command=&quot;[path]/gitolite-shell usertwo&quot;,[more options] ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEArXtCT...</code></pre>
<p>First, it finds out which of the public keys in this file match the incoming login. That's crypto stuff, and I won't go into it. Once the match has been found, it will run the command given on that line; e.g., if I logged in, it would run <code>[path]/gitolite-shell sitaram</code>. So the first thing to note is that such users do not get &quot;shell access&quot;, which is good!</p>
<p>Before running the command, however, sshd sets up an environment variable called <code>SSH_ORIGINAL_COMMAND</code> which contains the actual git command that your workstation sent out. This is the command that <em>would have run</em> if you did not have the <code>command=</code> part in the authorised keys file.</p>
<p>When <code>gitolite-shell</code> gets control, it looks at the first argument (&quot;sitaram&quot;, &quot;usertwo&quot;, etc) to determine who you are. It then looks at the <code>SSH_ORIGINAL_COMMAND</code> variable to find out which repository you want to access, and whether you're reading or writing.</p>
<p>Now that it has a user, repository, and access requested (read/write), gitolite looks at its config file, and either allows or rejects the request.</p>
<p>But this cannot differentiate between different branches within a repo; that has to be done separately.</p>
<h4 id="restricting-branch-level-actions"><span class="header-section-number">7.3.2.2</span> restricting branch level actions</h4>
<p>[If you look inside the git source tree, there's a file among the &quot;howto&quot;s in there called <code>update-hook-example.txt</code>, which was the inspiration for this part of gitolite.]</p>
<p>Git allows you to specify many &quot;hooks&quot;, which get control as various events happen -- see <code>git help hooks</code> for details. One of those hooks is the <code>update</code> hook, which, if it is present, is invoked just before a branch or a tag is about to be updated. The hook is passed the name of the branch or tag, the old SHA1 value, and the new SHA1 value, as arguments. Hooks that are called <em>before</em> an action happens are allowed to prevent that action from happening by returning an error code.</p>
<p>When gitolite is told to create a new repository (by the admin), it installs a special update hook. This hook takes all the information presented, looks at the config file, and decides to allow or reject the update.</p>
<p>And that's basically it.</p>
<h2 id="sts"><span class="header-section-number">7.4</span> ssh troubleshooting and tips</h2>
<!-- pandoc: toc -->

<p><strong>This document must be read in full the first time. If you start from some nice looking section in the middle it may not help you unless you're already an expert at ssh</strong>.</p>
<p>This document should help you troubleshoot ssh-related problems in installing and accessing gitolite. It also has a section of random ssh-related tips and tricks that gitolite can do.</p>
<hr />
<h3 id="important----read-this-first"><span class="header-section-number">7.4.1</span> IMPORTANT -- READ THIS FIRST</h3>
<h4 id="caveats-1"><span class="header-section-number">7.4.1.1</span> caveats</h4>
<ul>
<li><p>Before reading this document, it is <strong>mandatory</strong> to read and <strong>completely understand</strong> <a href="#ssh">this</a>, which is a very detailed look at how gitolite uses ssh's features on the server side. Don't assume you know all that; if you did, you wouldn't be needing <em>this</em> document either!</p></li>
<li><p>This document, and others linked from this, together comprise all the help I can give you in terms of the ssh aspect of using gitolite. If you're installing gitolite, you're a &quot;system admin&quot;, like it or not. Ssh is therefore a necessary skill. Please take the time to learn at least enough to get passwordless access working.</p></li>
<li><p>Please note that authentication is not really gitolite's job at all. I'd rather spend time on actual gitolite features, code, and documentation than authentication (i.e., ssh, in the common case).</p>
<p>Surprised? <a href="#auth">This</a> might help explain better.</p></li>
</ul>
<h4 id="naming-conventions-used"><span class="header-section-number">7.4.1.2</span> naming conventions used</h4>
<ul>
<li><p>Your workstation is the <strong>client</strong>. Your userid on the client does not matter, and it has no relation to your gitolite username.</p></li>
<li><p>The server is called <strong>server</strong> and the &quot;hosting user&quot; is <strong>git</strong>. If this is an RPM/DEB install, the hosting user is probably called &quot;gitolite&quot;, however we will use &quot;git&quot; in this document.</p></li>
</ul>
<h4 id="taking-stock----relevant-files-and-directories"><span class="header-section-number">7.4.1.3</span> taking stock -- relevant files and directories</h4>
<ul>
<li><p>The client has a <code>~/.ssh</code> containing a few keypairs. It may also have a <code>config</code> file.</p></li>
<li><p>The client also has a clone of the &quot;gitolite-admin&quot; repo, which contains a bunch of <code>*.pub</code> files in <code>keydir</code>. We assume this clone is in <code>$HOME</code>; if it is not, adjust instructions accordingly when needed.</p></li>
<li><p>The git user on the server has a <code>~/.ssh/authorized_keys</code> file that the ssh daemon uses to authenticate incoming users. We often call this file <strong>authkeys</strong> to save typing, and it always means the one on the server (we're not interested in this file on the client side).</p></li>
<li><p>The server also has a <code>~/.gitolite/keydir</code> which contains a bunch of <code>*.pub</code> files.</p></li>
</ul>
<h4 id="normal-gitolite-key-handling"><span class="header-section-number">7.4.1.4</span> normal gitolite key handling</h4>
<p>Here's how normal gitolite key handling works:</p>
<ul>
<li><p>(On client) pub key changes like adding new ones, deleting old ones, etc., are done in the <code>keydir</code> directory in the gitolite-admin repo clone. Then the admin <code>git add</code>s and <code>git commit</code>s those changes, then <code>git push</code>es them to the server.</p></li>
<li><p>(On server) a successful push from the client makes git invoke the post-update hook in the gitolite-admin repo. This hook is installed by gitolite, and it does a bunch of things which are quite transparent to the admin, but we'll describe briefly here:</p>
<ul>
<li><p>The pubkey files from this push are checked-out into <code>~/.gitolite/keydir</code> (and similarly the config files into <code>~/.gitolite/conf</code>).</p></li>
<li><p>The &quot;compile&quot; script then runs, which uses these files to populate <code>~/.ssh/authorized_keys</code> on the server.</p>
<p>The authkeys file may have other, (non-gitolite) keys also. Those lines are preserved. Gitolite only touches lines that are found between gitolite's &quot;marker&quot; lines (<code># gitolite start</code> and <code># gitolite end</code>).</p></li>
</ul></li>
</ul>
<h3 id="common-ssh-problems"><span class="header-section-number">7.4.2</span> common ssh problems</h3>
<p>Since I'm pretty sure at least some of you didn't bother to read the &quot;IMPORTANT: PLEASE READ FIRST&quot; section above, let me take a minute to point you there again. Especially the first bullet.</p>
<p>Done? OK, read on...</p>
<p>The following problem(s) indicate that pubkey access is not working at all, so you should start with <a href="#stsapp1">appendix 1</a>. If that doesn't fix the problem, continue with the other appendices in sequence.</p>
<ul>
<li>Running any git clone/fetch/ls-remote or just <code>ssh git@server info</code> asks you for a password. (Or, if your sshd is set to use keys only, it just disconnects without doing anything).</li>
</ul>
<p>The following problem(s) indicate that your pubkey is bypassing gitolite and going straight to a shell. You should start with <a href="#sshkeys-lint">appendix 2</a> and continue with the rest in sequence. <a href="#ybpfail">Appendix 5</a> has some background info.</p>
<ul>
<li><p>Running <code>ssh git@server info</code> gets you the output of the GNU 'info' command instead of gitolite's version and access info.</p></li>
<li><p>Running <code>git clone git@server:repositories/reponame</code> (note presence of <code>repositories/</code> in URL) works.</p>
<p>[A proper gitolite key will only let you <code>git clone git@server:reponame</code> (note absence of <code>repositories/</code>)]</p></li>
<li><p>You are able to clone repositories but are unable to push changes back (the error complains about the <code>GL_BINDIR</code> environment variable not being set or about not being able to locate <code>Gitolite/Hooks/Update.pm</code>, and the <code>hooks/update</code> failing in some way).</p>
<p>[If you run <code>git remote -v</code> you will find that your clone URL included the <code>repositories/</code> described above!]</p></li>
<li><p>Conversely, using the correct syntax, <code>git clone git@server:reponame</code> (note absence of <code>repositories/</code> in the URL), gets you <code>fatal: 'reponame'     does not appear to be a git repository</code>, and yet you are sure 'reponame' exists, you haven't mis-spelled it, etc.</p></li>
</ul>
<h3 id="step-by-step"><span class="header-section-number">7.4.3</span> step by step</h3>
<p>Since I'm pretty sure at least some of you didn't bother to read the &quot;IMPORTANT: PLEASE READ FIRST&quot; section above, let me take a minute to point you there again. Especially the first bullet.</p>
<p>Done? OK, now the general outline for ssh troubleshooting is this:</p>
<ul>
<li><p>Make sure the server's overall setup even <em>allows</em> pubkey based login. I.e., check that git fetch/clone/ls-remote commands or a plain <code>ssh     git@server info</code> do NOT ask for a password. If you do get asked for a password, see <a href="#stsapp1">appendix 1</a>.</p></li>
<li><p>Match client-side pubkeys (<code>~/.ssh/*.pub</code>) with the server's authkeys file. To do this, run <code>sshkeys-lint</code>, which tells you in detail what key has what access. See <a href="#sshkeys-lint">appendix 2</a>.</p></li>
<li><p>At this point, we know that we have the right key, and that if sshd receives that key, things will work. But we're not done yet. We still need to make sure that this specific key is being offered/sent by the client, instead of the default key. See <a href="#stsapp3">appendix 3</a> and <a href="#ssh-ha">appendix 4</a>.</p></li>
</ul>
<h3 id="random-tips-tricks-and-notes"><span class="header-section-number">7.4.4</span> random tips, tricks, and notes</h3>
<h4 id="giving-shell"><span class="header-section-number">7.4.4.1</span> giving shell access to gitolite users</h4>
<p>Thanks to an idea from Jesse Keating, a single key can allow both gitolite access <em>and</em> shell access.</p>
<p>To do this:</p>
<ul>
<li><p>add the list of users who will have shell access -- one username per line, no extra whitespace -- to a plain text file of your choice.</p></li>
<li><p>put the name of this file in a new rc variable <code>SHELL_USERS_LIST</code>. For example it could be</p>
<pre><code>SHELL_USERS_LIST        =&gt;  &quot;$ENV{HOME}/.gitolite.shell-users&quot;,</code></pre></li>
<li><p>enable the trigger by uncommenting the 'Shell' line in the ENABLE list.</p></li>
</ul>
<p>Then run <code>gitolite compile; gitolite trigger POST_COMPILE</code> or push a dummy change to the admin repo.</p>
<h4 id="kfn"><span class="header-section-number">7.4.4.2</span> distinguishing one key from another</h4>
<p>Since a user can have <a href="#multi-key">more than one key</a>, it is sometimes useful to distinguish one key from another. Sshd does not tell you even the fingerprint of the key that finally matched, so normally all you have is the <code>GL_USER</code> env var.</p>
<p>However, if you replace</p>
<pre><code>'ssh-authkeys',</code></pre>
<p>in the ENABLE list with</p>
<pre><code>'ssh-authkeys --key-file-name',</code></pre>
<p>then an extra argument is added after the username in the &quot;command&quot; variable of the authkeys file. That is, instead of this:</p>
<pre><code>command=&quot;/home/g3/gitolite/src/gitolite-shell u3&quot;,no-port-forwarding,...</code></pre>
<p>you get this:</p>
<pre><code>command=&quot;/home/g3/gitolite/src/gitolite-shell u3 keydir/u3.pub&quot;,no-port-forwarding,...</code></pre>
<p>You can then write an INPUT trigger to do whatever you need with the file name, which is in <code>$ARGV[1]</code> (the second argument). The actual file is available at <code>$ENV{GL_ADMIN_BASE}/$ARGV[1]</code> if you need its contents.</p>
<h4 id="simulating-ssh-copy-id"><span class="header-section-number">7.4.4.3</span> simulating ssh-copy-id</h4>
<p>don't have <code>ssh-copy-id</code>? This is broadly what that command does, if you want to replicate it manually. The input is your pubkey, typically <code>~/.ssh/id_rsa.pub</code> from your client/workstation.</p>
<ul>
<li><p>It copies it to the server as some file.</p></li>
<li><p>It appends that file to <code>~/.ssh/authorized_keys</code> on the server (creating it if it doesn't already exist).</p></li>
<li><p>It then makes sure that all these files/directories have go-w perms set (assuming user is &quot;git&quot;):</p>
<pre><code>/home/git/.ssh/authorized_keys
/home/git/.ssh
/home/git</code></pre></li>
</ul>
<p>[Actually, <code>sshd</code> requires that even directories <em>above</em> <code>~</code> (<code>/</code>, <code>/home</code>, typically) also must be <code>go-w</code>, but that needs root. And typically they're already set that way anyway. (Or if they're not, you've got bigger problems than gitolite install not working!)]</p>
<h4 id="problems-with-using-non-openssh-public-keys"><span class="header-section-number">7.4.4.4</span> problems with using non-openssh public keys</h4>
<p>Gitolite accepts public keys only in openssh format. Trying to use an &quot;ssh2&quot; key (used by proprietary SSH software) will not be a happy experience. src/triggers/post-compile/ssh-authkeys can be made to detect non-openssh formats and automatically convert them; patches welcome!</p>
<p>The actual conversion command, if you want to just do it manually for now and be done with it, is:</p>
<pre><code>ssh-keygen -i -f /tmp/ssh2/YourName.pub &gt; /tmp/openssh/YourName.pub</code></pre>
<p>then use the resulting pubkey as you normally would in gitolite.</p>
<h4 id="windows-issues"><span class="header-section-number">7.4.4.5</span> windows issues</h4>
<p>On windows, I have only used msysgit, and the openssh that comes with it. Over time, I have grown to distrust putty/plink due to the number of people who seem to have trouble when those beasts are involved (I myself have never used them for any kind of git access). If you have unusual ssh problems that just don't seem to have any explanation, try removing all traces of putty/plink, including environment variables, etc., and then try again.</p>
<p>Thankfully, someone contributed <a href="#putty">this</a>.</p>
<h3 id="stsapp1"><span class="header-section-number">7.4.5</span> appendix 1: ssh daemon asks for a password</h3>
<blockquote>
<p><strong>NOTE</strong>: This section should be useful to anyone trying to get password-less access working. It is not necessarily specific to gitolite, so keep that in mind if the wording feels a little more general than you were expecting.</p>
</blockquote>
<p>You have generated a keypair on your workstation (<code>ssh-keygen</code>) and copied the public part of it (<code>~/.ssh/id_rsa.pub</code>, by default) to the server.</p>
<p>On the server you have appended this file to <code>~/.ssh/authorized_keys</code>. Or you ran something, like the <code>gitolite setup</code> step during a gitolite install, which should have done that for you.</p>
<p>You now expect to log in without having to type in a password, but when you try, you are being asked for a password.</p>
<p>This is a quick checklist:</p>
<ul>
<li><p>Make sure you're being asked for a password and not a pass<em>phrase</em>. Do not confuse or mistake a prompt saying <code>Enter passphrase for key     '/home/sitaram/.ssh/id_rsa':</code> for a password prompt from the remote server!</p>
<p>When you create an ssh keypair using <code>ssh-keygen</code>, you have the option of protecting it with a passphrase. When you subsequently use that keypair to access a remote host, your <em>local</em> ssh client needs to unlock the corresponding private key, and ssh will probably ask for the passphrase you set when you created the keypair.</p>
<p>You have two choices to avoid this prompt every time you try to use the private key. The first is to create keypairs <em>without</em> a passphrase (just hit enter when prompted for one). <strong>Be sure to add a passphrase later, once everything is working, using <code>ssh-keygen -p</code></strong>.</p>
<p>The second is to use <code>ssh-agent</code> (or <code>keychain</code>, which in turn uses <code>ssh-agent</code>) or something like that to manage your keys. Other than discussing one more potential trouble-spot with ssh-agent (see below), further discussion of ssh-agent/keychain is out of scope of this document.</p></li>
<li><p>Ssh is very sensitive to permissions. An extremely conservative setup is given below, but be sure to do this on <strong>both the client and the server</strong>:</p>
<pre><code>cd $HOME
chmod go-rwx .
chmod -R go-rwx .ssh</code></pre></li>
<li><p>Actually, every component of the path to <code>~/.ssh/authorized_keys</code> all the way upto the root directory must be at least <code>chmod go-w</code>. So be sure to check <code>/</code> and <code>/home</code> also.</p></li>
<li><p>While you're doing this, make sure the owner and group info for each of these components are correct. <code>ls -ald ~ ~/.ssh ~/.ssh/authorized_keys</code> will tell you what they are.</p></li>
<li><p>You may also want to check <code>/etc/ssh/sshd_config</code> to see if the &quot;git&quot; user is allowed to login at all. For example, if that file contains an <code>AllowUsers</code> config entry, then only users mentioned in that line are allowed to log in!</p></li>
<li><p>While you're in there, check that file does NOT have a setting for <code>AuthorizedKeysFile</code>. See <code>man sshd_config</code> for details. This setting is a show stopper for gitolite to use ssh.</p></li>
<li><p>Some OSs/distributions require that the &quot;git&quot; user should have a password and/or not be a locked account. You may want to check that as well.</p></li>
<li><p>If your server is running SELinux, and you install gitolite to <code>/var/gitolite</code> or another location unsupported by default SELinux policies, then SELinux will prevent sshd from reading <code>.ssh/authorized_keys</code>. Consider installing gitolite to <code>/var/lib/gitolite</code>, which is a supported location by default SELinux policies.</p></li>
<li><p>If all that fails, log onto the server as root, <code>cd /var/log</code>, and look for a file called <code>auth.log</code> or <code>secure</code> or some such name. Look inside this file for messages matching the approximate time of your last attempt to login, to see if they tell you what is the problem.</p></li>
</ul>
<h3 id="sshkeys-lint"><span class="header-section-number">7.4.6</span> appendix 2: which key is which -- running sshkeys-lint</h3>
<p>The sshkeys-lint program can be run on the server or the client. Run it with '-h' to get a help message.</p>
<p>On the server you can run <code>gitolite sshkeys-lint</code> and it will tell you, for each key in the admin directory's keydir, what access is available. This is especially good at finding duplicate keys and such.</p>
<p>To run it on the client you have to copy the file src/commands/sshkeys-lint from some gitolite clone, then follow these steps:</p>
<ul>
<li><p>Get a copy of <code>~/.ssh/authorized_keys</code> from the server and put it in <code>/tmp/foo</code> or something.</p></li>
<li><p>cd to <code>~/.ssh</code>.</p></li>
<li><p>Run <code>/path/to/sshkeys-lint *.pub &lt; /tmp/foo</code>.</p></li>
</ul>
<p>Note that it is not trying to log in or anything -- it's just comparing fingerprints as computed by <code>ssh-keygen -l</code>.</p>
<p>If the pubkey file you're interested in appears to have the correct access to the server, you're done with this step.</p>
<p>Otherwise you have to rename some keypairs and try again to get the effect you need. Be careful:</p>
<ul>
<li><p>Do not just rename the &quot;.pub&quot; file; you will have to rename the corresponding private key also (the one with the same basename but without an extension).</p></li>
<li><p>If you're running ssh-agent, you may have to delete (using <code>ssh-add -D</code>) and re-add identities for it to pick up the renamed ones correctly.</p></li>
</ul>
<h4 id="typical-causes"><span class="header-section-number">7.4.6.1</span> typical cause(s)</h4>
<p>The admin often has passwordless shell access to <code>git@server</code> already, and then used that same key to get access to gitolite (i.e., copied that same pubkey as YourName.pub and ran <code>gitolite setup</code> on it).</p>
<p>As a result, the same key appears twice in the authkeys file now, and since the ssh server will always use the first match, the second occurrence (which invokes gitolite) is ignored.</p>
<p>To fix this, you have to use a different keypair for gitolite access. The best way to do this is to create a new keypair, copy the pubkey to the server as YourName.pub, then run <code>gitolite setup -pk YourName.pub</code> on the server. Remember to adjust your agent identities using ssh-add -D and ssh-add if you're using ssh-agent, otherwise these new keys may not work.</p>
<h3 id="stsapp3"><span class="header-section-number">7.4.7</span> appendix 3: ssh client may not be offering the right key</h3>
<ul>
<li><p>Make sure the right private key is being offered. Run ssh in very verbose mode and look for the word &quot;Offering&quot;, like so:</p>
<pre><code>ssh -vvv user@host pwd 2&gt; &gt;(grep -i offer)</code></pre>
<p>If some keys <em>are</em> being offered, but not the key that was supposed to be used, you may be using ssh-agent (next bullet). You may also need to create some host aliases in <code>~/.ssh/config</code> (<a href="#ssh-ha">appendix 4</a>).</p></li>
<li><p>(ssh-agent issues) If <code>ssh-add -l</code> responds with either &quot;The agent has no identities.&quot; or &quot;Could not open a connection to your authentication agent.&quot;, then you can skip this bullet.</p>
<p>However, if <code>ssh-add -l</code> lists <em>any</em> keys at all, then something weird happens. Due to a quirk in ssh-agent, ssh will now <em>only</em> use one of those keys, <em>even if you explicitly ask</em> for some other key to be used.</p>
<p>In that case, add the key you want using <code>ssh-add ~/.ssh/YourName</code> and try the access again.</p></li>
</ul>
<h3 id="ssh-ha"><span class="header-section-number">7.4.8</span> appendix 4: ssh host aliases</h3>
<p>(or &quot;making git use the right options for ssh&quot;)</p>
<p>The ssh command has several options for non-default items to be specified. Two common examples are <code>-p</code> for the port number if it is not 22, and <code>-i</code> for the public key file if you do not want to use just <code>~/.ssh/id_rsa</code> or such.</p>
<p>Git has two ssh-based URL syntaxes, but neither allows specifying a non-default public key file. And a port number is only allowed in one of them. (See <code>man git-clone</code> for details). Finally, hosts often have to be referred with IP addresses (such is life), or the name is very long, or hard to remember.</p>
<p>Using a &quot;host&quot; para in <code>~/.ssh/config</code> lets you nicely encapsulate all this within ssh and give it a short, easy-to-remember, name. Example:</p>
<pre><code>host gitolite
    user git
    hostname a.long.server.name.or.annoying.IP.address
    port 22
    identityfile ~/.ssh/id_rsa</code></pre>
<p>Now you can simply use the one word <code>gitolite</code> (which is the host alias we defined here) and ssh will infer all those details defined under it -- just say <code>ssh gitolite</code> and <code>git clone gitolite:reponame</code> and things will work.</p>
<p>(By the way, the 'port' and 'identityfile' lines are needed only if you have non-default values, although I put them in anyway just to be complete).</p>
<p>If you have <em>more than one</em> pubkey with access to the <em>same</em> server, you <strong>must</strong> use this method to make git pick up the right key. There is no other way to do this, as far as I know.</p>
<h3 id="ybpfail"><span class="header-section-number">7.4.9</span> appendix 5: why bypassing gitolite causes a problem</h3>
<p>When you bypass gitolite, you end up running your normal shell instead of the special gitolite entry point script <code>gitolite-shell</code>.</p>
<p>This means commands (like 'info') are interpreted by the shell instead of gitolite.</p>
<p>It also means git operations look for repos in <code>$HOME</code>.</p>
<p>However, gitolite places all your repos in a subdirectory pointed to by <code>$REPO_BASE</code> in the rc file (default: <code>repositories</code>), and internally prefixes this before calling the actual git command you invoked. Thus, the pathname of the repo that you use on the client is almost never the correct pathname on the server. (This is by design. Don't argue...)</p>
<p>This means that, you get 2 kinds of errors if you bypass gitolite</p>
<ul>
<li><p>When you use <code>git@server:reponame</code> with a key that bypasses gitolite (i.e., gets you a shell), this prefixing does not happen, and so the repo is not found. Neither a clone/fetch nor a push will work.</p></li>
<li><p>Conversely, consider <code>git@server:repositories/reponame.git</code>. The clone operation will work -- you're using the full Unix path, (assuming default <code>$REPO_BASE</code> setting), and so the shell finds the repo where you said it would be. However, when you push, gitolite's <strong>update hook</strong> kicks in, and fails to run because some of the environment variables it is expecting are not present.</p></li>
</ul>
<h2 id="putty"><span class="header-section-number">7.5</span> putty and msysgit</h2>
<p>Copyright: Thomas Berezansky (tsbere (at) mvlc (dot) org). Licensed under CC-BY-SA unported 3.0, http://creativecommons.org/licenses/by-sa/3.0/</p>
<p>This document is intended for those who wish to use Putty/Plink with msysgit.</p>
<p>If you need more help with putty or component programs I suggest looking at <a href="http://the.earth.li/~sgtatham/putty/latest/htmldoc/">the official putty documentation</a>.</p>
<p><strong>If you are not already using Putty for SSH it is recommended you do <em>NOT</em> use it with msysgit.</strong></p>
<p><strong>Please note that this only covers the client side of things, and does not involve server side components to troubleshooting. For that, please see the <a href="#sts">ssh-troubleshooting document</a>.</strong></p>
<p><a name="msysgit_setup"></a></p>
<h3 id="msysgit-setup"><span class="header-section-number">7.5.1</span> msysgit setup</h3>
<p>Provided you have putty sessions msysgit should give you the option of specifying a location to plink. If it did not then you will need to add an environment variable named &quot;GIT_SSH&quot; to point at plink.exe, wherever you have that sitting.</p>
<p>How to do that on your version of windows will likely vary, and is not covered here. For purposes of example, on a 64 bit Windows Vista machine the GIT_SSH value could be:</p>
<pre><code>C:\Program Files (x86)\PuTTY\plink.exe</code></pre>
<p>Note the lack of quotes.</p>
<p>Testing that msysgit is properly configured can be done from the git bash shell. Simply type (case sensitive, include the quotes):</p>
<pre><code>&quot;$GIT_SSH&quot; -V</code></pre>
<p>You should get a response similar to this:</p>
<pre><code>plink: Release 0.60</code></pre>
<p>If instead you get a &quot;command not found&quot; type error you likely have a typo in your environment variable.</p>
<p><a name="Going_back_to_OpenSSH"></a></p>
<h3 id="going-back-to-openssh"><span class="header-section-number">7.5.2</span> Going back to OpenSSH</h3>
<p>If you wish to go back to OpenSSH all you need to do is delete the GIT_SSH environment variable. This will vary by your version of windows and thus is not covered here.</p>
<p><a name="Putty_keys"></a></p>
<h3 id="putty-keys"><span class="header-section-number">7.5.3</span> Putty keys</h3>
<p>If you do not already have putty private key files (.ppk) you will need to make at least one. You can either make a new one or convert an existing key to putty private key format.</p>
<p>Either way, you will want to use puttygen. Note that you can go the other way if you want to stop using putty but keep the key by exporting the key to OpenSSH format.</p>
<p><a name="Creating_a_new_key"></a></p>
<h4 id="creating-a-new-key"><span class="header-section-number">7.5.3.1</span> Creating a new key</h4>
<p>To make it simple, I suggest SSH-2 RSA and a bit size of at least 1024. Larger keys will take longer to generate and will take longer to authenticate you on most systems. Making the key is as simple at hitting &quot;Generate&quot;.</p>
<p>It is recommended to give the key a meaningful comment.</p>
<p><a name="Importing_an_existing_key"></a></p>
<h4 id="importing-an-existing-key"><span class="header-section-number">7.5.3.2</span> Importing an existing key</h4>
<p>If you already have an OpenSSH or ssh.com key you can import it using the &quot;Import&quot; option on the &quot;Conversions&quot; menu.</p>
<p>If the key does not have a meaningful comment I would suggest adding one at this point.</p>
<p><a name="Loading_an_existing_key"></a></p>
<h4 id="loading-an-existing-key"><span class="header-section-number">7.5.3.3</span> Loading an existing key</h4>
<p>If you need to load an existing key to edit or view it you can do so from the File menu.</p>
<p><a name="Public_key"></a></p>
<h4 id="public-key"><span class="header-section-number">7.5.3.4</span> Public key</h4>
<p>To get your public key for use with gitolite, load (or generate, or import) your key into puttygen. There is a box labeled &quot;Public key for pasting into OpenSSH <code>authorized_keys</code> file&quot; there. Copy the text into your preferred text editor and save.</p>
<p><a name="Putty_ageant"></a></p>
<h4 id="putty-ageant"><span class="header-section-number">7.5.3.5</span> Putty ageant</h4>
<p>Though not required in all cases you may wish to use the putty ageant, pageant, to load your key(s). This will allow for your key(s) to be passphrase protected but not have to enter the passphrase when you go to use them, provided you have already loaded the key into the ageant.</p>
<p><a name="Sessionless_or_raw_hostname_usage"></a></p>
<h3 id="sessionless-or-raw-hostname-usage"><span class="header-section-number">7.5.4</span> Sessionless or raw hostname usage</h3>
<p>When using plink without a putty session you pretty much have to load your keys with putty ageant, if only so that plink can find them.</p>
<p><a name="Putty_sessions"></a></p>
<h3 id="putty-sessions"><span class="header-section-number">7.5.5</span> Putty sessions</h3>
<p>In addition to hostnames msysgit can, when using putty, use putty sessions. This works in a manner similar to definitions in OpenSSH's <code>ssh_config</code> file. All settings in the session that apply to plink usage will be loaded, including the key file to use and even the username to connect to. Thus, instead of:</p>
<pre><code>ssh://user@host.example.ext:port/repo</code></pre>
<p>You can use:</p>
<pre><code>ssh://session_name/repo</code></pre>
<p><a name="Host_key_authentication"></a></p>
<h3 id="host-key-authentication"><span class="header-section-number">7.5.6</span> Host key authentication</h3>
<p>Whether you are using hostnames or sessions you still run into one potential problem. Plink currently wants to validate the server's SSH host key before allowing you to connect, and when git calls plink there is no way to tell it yes. Thus, you may get something like this:</p>
<pre><code>The server's host key is not cached in the registry. You
have no guarantee that the server is the computer you
think it is.
The server's rsa2 key fingerprint is:
ssh-rsa 2048 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
Connection abandoned.
fatal: The remote end hung up unexpectedly</code></pre>
<p>Or, in the case of the host key changing, something like this:</p>
<pre><code>WARNING - POTENTIAL SECURITY BREACH!
The server's host key does not match the one PuTTY has
cached in the registry. This means that either the
server administrator has changed the host key, or you
have actually connected to another computer pretending
to be the server.
The new rsa2 key fingerprint is:
ssh-rsa 2048 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
Connection abandoned.
fatal: The remote end hung up unexpectedly</code></pre>
<p>The solution is to call plink directly, or start putty and connect with it first. To use plink, open the Git Bash shell and enter:</p>
<pre><code>&quot;$GIT_SSH&quot; hostname_or_session_name</code></pre>
<p>When you do you will see something like this:</p>
<pre><code>The server's host key is not cached in the registry. You
have no guarantee that the server is the computer you
think it is.
The server's rsa2 key fingerprint is:
ssh-rsa 2048 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
If you trust this host, enter &quot;y&quot; to add the key to
PuTTY's cache and carry on connecting.
If you want to carry on connecting just once, without
adding the key to the cache, enter &quot;n&quot;.
If you do not trust this host, press Return to abandon the
connection.
Store key in cache? (y/n)</code></pre>
<p>Or, in the case of a changed key, a response like this:</p>
<pre><code>WARNING - POTENTIAL SECURITY BREACH!
The server's host key does not match the one PuTTY has
cached in the registry. This means that either the
server administrator has changed the host key, or you
have actually connected to another computer pretending
to be the server.
The new rsa2 key fingerprint is:
ssh-rsa 2048 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
If you were expecting this change and trust the new key,
enter &quot;y&quot; to update PuTTY's cache and continue connecting.
If you want to carry on connecting but without updating
the cache, enter &quot;n&quot;.
If you want to abandon the connection completely, press
Return to cancel. Pressing Return is the ONLY guaranteed
safe choice.
Update cached key? (y/n, Return cancels connection)</code></pre>
<p>In either case hit y and the key will be stored.</p>
<p><a name="Debugging_multiple_putty_ageant_keys"></a></p>
<h3 id="debugging-multiple-putty-ageant-keys"><span class="header-section-number">7.5.7</span> Debugging multiple putty ageant keys</h3>
<p>In the event you are using putty ageant with multiple keys loaded you may see the wrong key being used. In general, pageant keys are tried in the order they were loaded into the ageant. If you have descriptive comment on each of your keys you can try connecting with plink in verbose mode to see what keys are being tried. Simply open the Git bash shell and run:</p>
<pre><code>&quot;$GIT_SSH&quot; -v user@hostname</code></pre>
<p>Or, if using sessions with a pre-entered username:</p>
<pre><code>&quot;$GIT_SSH&quot; -v session_name</code></pre>
<p>In either case, you should look for lines like:</p>
<pre><code>Trying Pageant key #0
Authenticating with public key &quot;My Key&quot; from agent</code></pre>
<p>The first says which (numerical) key the ageant is trying. The second tells you the key comment for the authenticating key. To my knowledge the second line should only show up once, for the valid key.</p>
<p><a name="Setperms_and_other_commands"></a></p>
<h3 id="setperms-and-other-commands"><span class="header-section-number">7.5.8</span> Setperms and other commands</h3>
<p>When using wildcard repos the setperms command is very important, and other commands can come in handy as well. See their documentation for how to use them, but where they use:</p>
<pre><code>ssh user@host command etc etc</code></pre>
<p>You will want to use:</p>
<pre><code>&quot;$GIT_SSH&quot; user@host command etc etc</code></pre>
<p>Otherwise everything should be identical.</p>
<p><a name="About_this_document"></a></p>
<h3 id="about-this-document"><span class="header-section-number">7.5.9</span> About this document</h3>
<p>This document was written by Thomas Berezansky (tsbere (at) mvlc (dot) org) in the hopes that it would be useful to those using putty on windows and wishing to use git/gitolite with their putty keys and sessions.</p>
<h1 id="s8"><span class="header-section-number">8</span> odds and ends</h1>
<h2 id="how"><span class="header-section-number">8.1</span> how does gitolite work</h2>
<p>You'll appreciate this more if you first read the <a href="http://gitolite.com/tias.html">try it and see</a> page (don't worry, it's very short and quick).</p>
<h3 id="what-does-a-gitolite-repo-look-like"><span class="header-section-number">8.1.1</span> what does a &quot;gitolite repo&quot; look like?</h3>
<p>A gitolite repo looks just like a normal bare repo on any normal git server. There are a few extra files placed in the repo directory whose names start with &quot;gl-&quot;, and there is also an update hook placed in the hooks subdirectory, but that's about it, for the most part.</p>
<p>In other words, you can treat a gitolite-managed repo just like any other bare repo as long as you leave those files alone.</p>
<h3 id="conventions-used"><span class="header-section-number">8.1.2</span> conventions used</h3>
<pre><code>--//--&gt;     network connection
------&gt;     exec() or system() call
--??--&gt;     conditional exec() or system() call</code></pre>
<p>&quot;Conditional&quot; means some checks done by the caller may result in caller deciding not to make the call and abort instead.</p>
<h3 id="git-over-plain-ssh"><span class="header-section-number">8.1.3</span> git over plain ssh</h3>
<p>If you have used rsync or any similar program with a remote host using ssh, then you already understand the basics of git over ssh.</p>
<p>Here is a little more detail on what is happening:</p>
<pre><code># for read operations
git clone ------&gt; ssh --//--&gt; sshd ------&gt; git-upload-pack
git fetch ------&gt; ssh --//--&gt; sshd ------&gt; git-upload-pack

# for write operations
git push  ------&gt; ssh --//--&gt; sshd ------&gt; git-receive-pack</code></pre>
<p>The local git client just runs something like <code>ssh git@host git-receive-pack 'path/to/reponame.git'</code> (using the push example), and when that connection is established the local git-push and the remote git-receive-pack communicate over this connection.</p>
<h3 id="git-over-gitolite"><span class="header-section-number">8.1.4</span> git over gitolite</h3>
<p>Installing gitolite only adds an extra layer in between the sshd and the git-receive-pack (or git-upload-pack, for read operations), to check if the access is allowed and abort if needed.</p>
<p>Using the push as an example, this is what it looks like:</p>
<pre><code>git push  ------&gt; ssh --//--&gt; sshd ------&gt; gitolite-shell --??--&gt; git-receive-pack</code></pre>
<p>Note that the git <em>client</em> does not change at all; in fact it doesn't even know that something called gitolite exists!</p>
<p>Here's how we get the server side behaviour shown above:</p>
<ul>
<li><p>we make sshd invoke 'gitolite-shell', even though the git client asked it to invoke 'git-receive-pack' (or 'git-upload-pack' for reads).</p></li>
<li><p>we also make sshd supply an argument to 'gitolite-shell'. This is the name of the gitolite user. (Remember this is a virtual user, not a real &quot;unix&quot; userid).</p></li>
<li><p>finally, sshd itself supplies the original command that the git <em>client</em> wanted to run (<code>git-receive-pack 'path/to/reponame.git'</code>) in a special environment variable called <code>SSH_ORIGINAL_COMMAND</code>.</p></li>
</ul>
<p>(<font color="gray">All this is done using various ssh features; see the <a href="#glssh">gitolite and ssh</a> page for details</font>).</p>
<h4 id="gitolite-shell"><span class="header-section-number">8.1.4.1</span> gitolite-shell</h4>
<p>So gitolite-shell has two pieces of information. From argument-1 it knows the username, and from that env var it knows what repo and what operation (i.e., is it a read or a write) is requested.</p>
<p>At this point, it checks the user's access and decides if the access is allowed or not.</p>
<p>(<font color="gray">For details see the <a href="#rules">rules</a> page, especially the sections &quot;when are the rules checked&quot; and &quot;how are the rules matched&quot;</font>).</p>
<p>For read operations this is the end of gitolite's interference. If the access is allowed, git-upload-pack runs, does its job, and exits.</p>
<h4 id="update-hook-1"><span class="header-section-number">8.1.4.2</span> update hook</h4>
<p>For write operations, git itself runs an update hook, if one is available, before allowing the ref to be updated. All of gitolite's &quot;fine-grained access control&quot; happens via this hook, which gitolite installs on every repo that it is managing.</p>
<p>When git calls the update hook, it supplies 3 critical pieces of information as arguments. Together with what we already know (user, repo), these 3 pieces of information (refname being updated, the old SHA, and the new SHA) tell us all we need to implement whatever access control you want to, like &quot;only alice and dilbert can push the master branch&quot;, &quot;wally can only push branches starting with 'wally/'&quot;, or &quot;only dilbert can push changes to 'license.txt', etc.</p>
<p>(<font color="gray">Again, details are in the <a href="#rules">rules</a> page</font>).</p>
<h2 id="why"><span class="header-section-number">8.2</span> why might you need gitolite</h2>
<!-- pandoc: toc -->

<p>Git by itself does not do any access control -- it relies on the transport medium to do authentication (&quot;who are you?&quot;), and on OS file permissions to do authorisation (&quot;what are you allowed to do?&quot;).</p>
<p>Git also comes with a program called &quot;git-shell&quot; which can act as a restricted login shell if you don't want users getting a proper shell. Using this and judicious use of Unix groups, you can allow some people read-only access while others get read-write access, etc. This is probably sufficient if your needs are simple and don't change too often.</p>
<p>However, gitolite does this much better, and offers many more features.</p>
<h3 id="basic-use-case"><span class="header-section-number">8.2.1</span> basic use case</h3>
<p>Gitolite is useful in any server that is going to host multiple git repositories, each with many developers, where &quot;anyone can do anything to any repo&quot; is not a good idea. Here're two examples to illustrate.</p>
<p>Example 1, 3 repos, 3 developers with different levels of access to each repo:</p>
<pre><code>repo foo
    RW+     =   alice
    R       =   bob

repo bar
    RW+     =   bob
    R       =   alice

repo baz
    RW+     =   carol
    R       =   alice bob</code></pre>
<p>Example 2, one repo, but different levels of access to different branches and tags for different developers:</p>
<pre><code>repo foo
    RW+ master                  =   alice
    RW+ dev/                    =   bob
    RW  refs/heads/tags/v[0-9]  =   ashok</code></pre>
<h3 id="alt"><span class="header-section-number">8.2.2</span> alternatives</h3>
<h4 id="unix-permissions-and-acls"><span class="header-section-number">8.2.2.1</span> unix permissions and ACLs</h4>
<p>If you're a masochist, you could probably do example 1 with Unix permissions and facls. But you can't do example 2 -- git is not designed to allow that!</p>
<p>Here are some other disadvantages of the Unix ACL method:</p>
<ul>
<li>Every user needs a userid and password on the server.</li>
<li>Changing access rights involves complex <code>usermod -G ...</code> mumblings (I.e., the &quot;pain&quot; mentioned above is not a one-time pain!)</li>
<li><em>Viewing</em> the current set of permissions requires running multiple commands to list directories and their permissions/ownerships, users and their group memberships, and then correlating all these manually.</li>
<li>Auditing historical permissions or permission changes is impossible.</li>
</ul>
<h4 id="gcr"><span class="header-section-number">8.2.2.2</span> Gerrit Code Review</h4>
<p>The best real alternative to gitolite is Gerrit Code Review. If code review is an essential part of your workflow, you should use Gerrit.</p>
<p>Here're some high level differences between gitolite and Gerrit:</p>
<p><strong>Size</strong>: 3000+ lines of perl versus of 56,000+ lines of Java</p>
<p><strong>Architecture</strong>: Gitolite sits on top of &quot;standard&quot; git and openssh, which are assumed to already be installed. Gerrit includes its own git stack (jgit) and sshd (Apache Mina). In Java tradition, they all come bundled together.</p>
<p>(Corollary: As far as I know jgit does not support the same hooks that 'man githooks' talks about).</p>
<p>Gitolite uses a plain text config file; gerrit uses a database.</p>
<p><strong>User view</strong>: Gitolite is invisible to users except when access is denied. I think Gerrit is much more visible to devs.</p>
<p>On a related note, gitolite does not do anything special with signed or annotated tags, nor does it check author/committer identity. However, it is trivial to add your own code to do either (or if someone contributes it, to just &quot;enable&quot; what ships with gitolite in a disabled state).</p>
<h4 id="gitorious-and-others"><span class="header-section-number">8.2.2.3</span> gitorious and others</h4>
<p>Anecdotally, gitorious is very hard to install. Comparison with gitolite may be useless because I believe it doesn't have branch/tag level access control. However, I can't confirm or deny this because I can't find any documentation on the website. In addition, the main website hides the source code very well, so you already have a challenge! [The only link I could find was tucked away at the bottom of the About page, in the License section].</p>
<p>Gitorious has several, much newer, competitors offering web-based management, issue tracker, wiki, and so on; try googling for gitlab, gitblit, and rhodecode.</p>
<p>However, to the best of my knowledge none of them offer branch level access controls (please tell me if you know different), which, since it is the main reason I wrote gitolite, makes them all somewhat moot.</p>
<p>They are also unlikely to be as <a href="#cust">customisable</a> as gitolite is, if you care about that sort of thing.</p>
<h2 id="who"><span class="header-section-number">8.3</span> who uses gitolite</h2>
<p>[Note that most of the users who are listed in this document are still using v2.x, presumably because it's working fine for them and there's no compelling reason to upgrade, and I still support v2 at least for critical issues].</p>
<blockquote>
<blockquote>
<p>If you're using gitolite and find it very useful in some way, I would love to describe your use of it or add a link to your own description of it here. Of course, you can anonymise it as much as you need to.</p>
</blockquote>
</blockquote>
<p>The <strong>Fedora Project</strong> controls access to over 10,000 package management repositories accessed by over 1,000 package maintainers <a href="http://lists.fedoraproject.org/pipermail/devel-announce/2010-July/000647.html">using gitolite</a>. This is probably the largest <em>confirmed</em> gitolite installation anywhere. The whole [big-config][bc] thing was initially done for them (their config file was so big that without the big-config changes gitolite would just run out of memory and die!).</p>
<p>The <strong>KDE project</strong> <a href="http://community.kde.org/Sysadmin/GitKdeOrgManual">uses</a> gitolite (in combination with redmine for issue tracking and reviewboard for code review). Apart from the usual access control, the KDE folks are heavy users of the &quot;ad hoc repo creation&quot; features enabled by wildrepos and the accompanying commands. Several of the changes to the &quot;admin defined commands&quot; were also inspired by KDE's needs. See <a href="http://community.kde.org/Sysadmin/GitKdeOrgManual#Server-side_commands">section 5</a> and <a href="http://community.kde.org/Sysadmin/GitKdeOrgManual#Personal_repositories">section 6</a> of the above linked page for details.</p>
<p><strong>Prof. Hiren Patel</strong> of the University of Waterloo is responsible for the existence of the fairly popular &quot;<a href="#wild">wildrepos</a>&quot; feature. The documentation was pretty much written with his use case in mind, but of course it turns out to be useful for a lot of people, as you can see from the previous para on KDE's use of gitolite.</p>
<p>In fact, he surprised the heck out of me recently by saying that if it hadn't been for this feature, he might not have used git itself -- which is a pretty serious compliment if you think about the magnitude of the git project and my little one-man show!</p>
<p>He explains his use of it <a href="http://caesr.uwaterloo.ca/wildrepos-in-gitolite/">here</a>.</p>
<p><strong>Gentoo Linux</strong> has <a href="http://archives.gentoo.org/gentoo-dev/msg_2812c9b9e768f64b46360ab17b9d0024.xml">just moved</a> their git repositories from gitosis to gitolite. There are about 200 repositories, some of them are the so called <a href="http://www.gentoo.org/proj/en/overlays/">overlays</a>, official and unofficial/user overlays, plus several developer and project repositories, used by more than 1000 people. That number will be increased in the near future, as they are going to migrate some of their CVS/SVN repositories there, plus they are offering overlays hosting for users as well.</p>
<p><strong>kernel.org</strong>, the official distribution point for the Linux kernel, is the latest (as of 2011-10) high-visibility installation. According to <a href="http://lkml.org/lkml/2011/9/23/357">this email</a> to the lkml, kernel.org decided to use gitolite for access controlling their git repos. Their <a href="http://www.kernel.org/faq/#whygitolite">FAQ entry</a> describes at a high level why they chose gitolite.</p>
<p>This move also prompted the first ever security audit of gitolite by an outside party. Gitolite did great; see <a href="http://groups.google.com/group/gitolite/browse_thread/thread/8dc5242052b16d0f">here</a> for details.</p>
<p>In addition, kernel.org was responsible for a serious rethink of a few rough edges in gitolite, and smoothing them out was fun (the &quot;playing with gitolite&quot; stuff, making the test suite simpler, &quot;deny&quot; rules for the entire repo).</p>
<p>The <strong>Mageia Project</strong> is <a href="http://gitweb.mageia.org/">using</a> gitolite 3 to manage its git repositories and access control. The repositories are <a href="http://gitweb.mageia.org/infrastructure/repositories/software/">defined</a> in yaml files. A tool called <a href="http://gitweb.mageia.org/software/infrastructure/mgagit/">mgagit</a> has been created and is repsonsible for the generation of the gitolite configuration from the yaml repos definitions, and the extraction of users' ssh keys from an ldap directory into the gitolite configuration.</p>
<p>Gitolite and mgagit are installed using rpm packages and <a href="http://svnweb.mageia.org/adm/puppet/deployment/mgagit/">a puppet module</a>.</p>
<hr />
<p>A general note: if you see the list of high-profile users above, you will see that gitolite benefits as much as they do; possibly more.</p>
<p>color me happy...</p>
<h2 id="g3why"><span class="header-section-number">8.4</span> why a completely new version?</h2>
<p>Gitolite started life as 400 lines of perl written on a weekend because I was quickly losing control of my projects at work, exacerbated by git newbies doing all the wrong things. I really needed it!</p>
<p>That little 400 line thing is now a huge bunch of programs that do all sorts of things (I mean, rsync access control in a git related program? WTF!), because it kinda just <em>grew</em> while I wasn't looking.</p>
<p>So, briefly, here are the advantages of g3:</p>
<ul>
<li><p>compile versus everything else</p>
<p>g2's &quot;compile&quot; script was doing way, way too much. For example, dealing with gitweb and git-daemon was a good chunk of code in g2. In contrast, here's how g3 generates gitweb's projects.list file:</p>
<pre><code>(
    gitolite list-phy-repos | gitolite access % gitweb R any | grep -v DENIED
    gitolite list-phy-repos | gitolite git-config -r % gitweb\\.
) |
    cut -f1 | sort -u | sed -e 's/$/.git/' &gt; $plf</code></pre></li>
<li><p>core versus non-core</p>
<p>That's just the tip of the iceberg. The commands above run from a script that is itself outside gitolite, and can be enabled and disabled from the rc file. There are six different &quot;events&quot; within gitolite that can trigger external programs, with specific arguments passed to them, much like git's own hooks. The example you saw is called from the &quot;POST_COMPILE&quot; trigger.</p>
<p>And as you can see, these programs be in any language.</p></li>
<li><p>get/set perms/desc, and ADCs</p>
<p>I've always wanted to kick setperms out of core and make it an ADC. Sadly, it couldn't be done because when you update your repo's permissions using setperms, that can affect gitweb/daemon access, which -- you guessed right -- feeds back into the main code in complex ways. It <em>had</em> to be an &quot;inside job&quot;.</p>
<p>But now, the new 'perms' program is quite external to gitolite. And how does it fix up gitweb/daemon permissions after it is done updating the &quot;gl-perms&quot; file?</p>
<pre><code>system(&quot;gitolite&quot;, &quot;trigger&quot;, &quot;POST_CREATE&quot;);</code></pre></li>
<li><p>syntax versus semantics</p>
<p>I got tired of people asking things like &quot;why can't I have backslash-escaped continuation lines?&quot; I designed it differently because I don't like them but perhaps it's reasonable for some people.</p>
<p>Someone else wanted to use subdirectories of 'keydir' as group names. Why not?</p>
<p>G3 comes with a stackable set of &quot;syntactic sugar&quot; helpers. And you can write your own, though they do have to be in perl (because they're not standalone programs).</p>
<p>Once the code is written and placed in the right place, all you have to do to enable it is to uncomment some lines in the ENABLE list in the rc file:</p>
<pre><code># 'continuation-lines',
# 'keysubdirs-as-groups',
&lt;etc&gt;</code></pre></li>
<li><p>roll your own</p>
<p>Having a decent shell API helps enormously. You saw an example above but how about if your boss asks you &quot;I need a list of everyone who <em>currently</em> has read access to the 'foo' repo&quot;?</p>
<p>Sure you could look in conf/gitolite.conf, all its include files (if you have any), and if the repo is user-created, then in its gl-perms.</p>
<p>Or you could do something like this:</p>
<pre><code>gitolite list-users | gitolite access foo % R any | cut -f1</code></pre></li>
<li><p>over-engineered</p>
<p>g2 was, to some extent, over-engineered. One of the best examples is the documentation on hook-propagation in g2, which required even a <em>picture</em> to make clear (always a bad sign). In g3, the <a href="#hooks">hooks</a> section is 4 sentences.</p></li>
</ul>
<p>Anyway you get the idea.</p>
<p>The point is not that you can do all these cool tricks. The point is they are possible because of the redesign. There is no way on God's green earth I could have done this with the old code.</p>
<h2 id="dev-status"><span class="header-section-number">8.5</span> g3 development status</h2>
<p>Not yet done (will be tackled in this order unless someone asks):</p>
<ul>
<li>mechanism for ADCs using unchecked arguments -- this is not just a matter of writing it; I have to think about <em>how</em> it will be done. (AFAIK the only tool affected is git-annexe; if there are more let me know)</li>
</ul>
<p>Help needed:</p>
<ul>
<li>I'd like distro packagers to play with it and help with migration advice for distro-upgrades</li>
<li>rsync</li>
<li>git-annexe support (but this has a pre-requisite in the previous list)</li>
</ul>
<p>Won't be done unless someone asks (saw no evidence that anyone used them in g2 anyway!):</p>
<ul>
<li>mob branches</li>
<li>password access</li>
<li>some of the more arcane rc variables!</li>
<li>specific ADCs -- there are too many for me to bother without applying Pareto somewhere, so I choose to not do any and wait for people to ask :-)</li>
</ul>
<p>Done:</p>
<ul>
<li>core code</li>
<li>test suite</li>
<li>mirroring</li>
<li>documentation</li>
<li>migration documentation</li>
<li>distro packaging instructions</li>
<li>migration advice for common cases</li>
<li>smart http</li>
<li>svnserve</li>
<li>htpasswd</li>
</ul>
<h2 id="files"><span class="header-section-number">8.6</span> files involved in gitolite</h2>
<p>Gitolite creates and uses the following files and directories:</p>
<ul>
<li><code>~/repositories</code> -- the actual (bare) repositories are here</li>
<li><code>~/.gitolite.rc</code> -- configuration parameters that must be done directly on the server</li>
<li><code>~/.gitolite</code> -- gitolite's &quot;working&quot; directory. This contains everything else that gitolite needs. (Warning: you're not supposed to fiddle with the files and directories within; instead, make changes in a clone of the gitolite-admin repository and push, and those appear magically here).</li>
</ul>
<p>Once the install/setup is done, any (or all) of these may be moved elsewhere and replaced by symlinks. The most common reason for locating <code>~/repositories</code> somewhere else is disk space, but FHS compliance could also be a reason.</p>
<p>In addition, the following are of interest:</p>
<ul>
<li><code>~/.ssh</code> -- if you're using ssh (as opposed to http), since this is where the <code>authorized_keys</code> file is kept</li>
</ul>
<h3 id="special-files"><span class="header-section-number">8.6.1</span> special files</h3>
<p>You may want to backup the contents of <code>~/.gitolite/logs</code> if you care about auditability etc.</p>
<h3 id="gitolite-software"><span class="header-section-number">8.6.2</span> gitolite software</h3>
<p>The above list does not include the gitolite software itself.</p>
<p>Gitolite offers you 3 ways to install software. After cloning the gitolite sources, run the install command in it with a <code>-h</code> argument to see what they are. Where the actual software is found depends on that.</p>
<h2 id="regex"><span class="header-section-number">8.7</span> extremely brief regex overview</h2>
<p>Regexes are powerful. Gitolite uses that power as much as it can. If you can't handle that power, hire someone who can and become a manager.</p>
<p>That said, here's a very quick overview of the highlights.</p>
<p><code>^</code> and <code>$</code> are called &quot;anchors&quot;. They anchor the match to the beginning and end of the string respectively.</p>
<pre><code>^foo    matches any string starting with 'foo'
foo$    matches any string ending with 'foo'
^foo$   matches exact string 'foo'.</code></pre>
<p>To be precise, the last one is &quot;any string starting and ending with <em>the same</em> 'foo'&quot;. &quot;foofoo&quot; does not match.</p>
<p><code>[0-9]</code> is an example of a character class; it matches any single digit. <code>[a-z]</code> matches any lower case alpha, and <code>[0-9a-f]</code> is the range of hex characters. You should now guess what <code>[a-zA-Z0-9_]</code> does.</p>
<p><code>.</code> (the period) is special -- it matches any character. If you want to match an actual period, you need to say <code>\.</code>.</p>
<p><code>*</code>, <code>?</code>, and <code>+</code> are quantifiers. They apply to the previous token. <code>a*</code> means &quot;zero or more 'a' characters&quot;. Similarly <code>a+</code> means &quot;one or more&quot;, and <code>a?</code> means &quot;zero or one&quot;.</p>
<p>As a result, <code>.*</code> means &quot;any number (including zero) of any character&quot;.</p>
<p>The previous token need not be a single character; you can use parens to make it longer. <code>(foo)+</code> matches one or more &quot;foo&quot;, (like &quot;foo&quot;, &quot;foofoo&quot;, &quot;foofoofoo&quot;, etc.)</p>
<h2 id="perf"><span class="header-section-number">8.8</span> gitolite performance</h2>
<p>TOP TIP: If you have more than 2000 or so repos, then you should be using v3.2 or later; there was a bit of code that went in there that makes a <em>huge</em> difference for really large sites.</p>
<h3 id="tips-for-performance-worriers"><span class="header-section-number">8.8.1</span> tips for performance worriers</h3>
<p>Gitolite is pretty efficient in most cases, and generally nothing needs to be done. If you think you have a performance problem, let me know on the mailing list. Meanwhile, here are some tips:</p>
<ul>
<li><p>Look in the gitolite log file after any operation that you think ran slowly. In particular, pushing to the admin repo, or a user creating a new wild repo, might be a little slow, and the log file will tell you a bit more detail on what took time.</p></li>
<li><p>If you don't use gitweb or git-daemon, or use them but are perfectly happy to control access to them from outside gitolite, you can comment out the corresponding lines in the ENABLE list the rc file.</p></li>
<li><p>If you can't get rid of those scripts, and they are still taking too long, you can make them run in the background. They'll eventually finish but the user doesn't have to wait. See src/triggers/bg. <em>This should not normally be needed; if you feel you need it, please talk to me so I can understand why and maybe help</em>.</p></li>
<li><p>If you're more concerned about your users' time when they create a new wild repo (and not so much about the admin push taking time), you can fix a couple of scripts and send me a patch :)</p>
<p>Here's the scoop:</p>
<p>Scripts invoked via <code>POST_CREATE</code> <em>do</em> get information about what repo has just been created. However, the gitweb and daemon scripts are not set to take advantage of this, only the git-config one is. So use the git-config script as an example, and/or read the <a href="#triggers">triggers</a> documentation, and fix the other two programs.</p>
<p>(This should be easy enough for the daemon update, but the gitweb update may be a little more tricky, since it may involve <em>deleting</em> lines from the &quot;projects.list&quot; file.)</p></li>
</ul>
<h3 id="why-theres-really-no-need-to-worry"><span class="header-section-number">8.8.2</span> why there's really no need to worry!</h3>
<p>In general, gitolite has a constant overhead of about 0.2 seconds on my laptop. There really is nothing to optimise, but you can comment out some triggers as the previous section said.</p>
<p>Here's the big-O stuff:</p>
<ul>
<li>N = number of normal repos, each with its own set of rules. In <code>repo r1     r2 r3</code>, N = 3. Add up all such lines.</li>
<li>G = number of groups or wild patterns. In <code>repo @g1 @g2 foo/[a-z]*</code>, G = 3.</li>
<li>M = number of members. In <code>@g1 = r1 r2 &lt;nl&gt; @g2 = r3 r4 r5</code>, M = 5.</li>
<li>A = average number of rule lines in each &quot;repo&quot; block. Usually about 5, maybe 10 sometimes. You may have more.</li>
</ul>
<p>Gitolite overheads compared to a normal ssh push are:</p>
<ol style="list-style-type: decimal">
<li>perl startup time. Fairly constant and fairly small. I have generally found it pretty hard to measure, especially with a hot cache.</li>
<li>rule parse time. Details below</li>
<li>rule interpretation time. Fairly constant, or at least subject to much smaller variations than #2.</li>
</ol>
<p>&quot;rule parse time&quot; is where it makes a difference. There are 2 files gitolite parses on each &quot;access&quot;: <code>~/.gitolite/conf/gitolite.conf-compiled.pm</code> and <code>~/repositories/your_repo.git/gl-conf</code>. The former contains O(N + M + G*A) lines. In addition, the gl-conf files contains about &quot;A&quot; lines (remember we called it an average), which is negligible.</p>
<p>In practice, you can't measure this at a scale that a developer running a &quot;git push&quot; might even pretend to notice, unless you have more than, say, 5000 repos or so. On my testbed of 11,100 repos, where the compiled.pm is almost 0.7 MB, it takes less than 0.2 seconds to do this.</p>
<p>And on a busy system, when that file will be pretty much always in cache, it's even less.</p>
<h3 id="the-only-thing-that-will-take-more-time"><span class="header-section-number">8.8.3</span> the only thing that will take more time</h3>
<p>Literally, the only thing that will take time is something like &quot;ssh git@host info&quot; because it finds all possible repos and for each of them it tries to check the access. On that same test bed, therefore, this ends up reading all 11,100 &quot;gl-conf&quot; files.</p>
<p>On my laptop this takes about 14 seconds. In contrast, a normal git operation (clone, pull, push, etc) is so small it is hard to measure without software.</p>
<h2 id="README-emacs"><span class="header-section-number">8.9</span> Emacs major mode for gitolite.conf</h2>
<p><a href="http://www.gnu.org/software/emacs">Emacs</a> major mode for <code>gitolite.conf</code> can be found here:</p>
<ul>
<li><a href="http://github.com/llloret/gitolite-emacs">GitHub</a></li>
</ul>
<h1 id="s9"><span class="header-section-number">9</span> migration</h1>
<h2 id="migr"><span class="header-section-number">9.1</span> migrating</h2>
<p><font color="gray">This section is about migrating from older gitolite to &quot;g3&quot;. If you're migrating from gitosis, see <a href="#gsmigr">here</a>.</font></p>
<p>First things first: g2 will be supported for a good long time for critical bugs, although enhancements and new features won't happen.</p>
<p>If you're an existing (gitolite v1.x or v2.x) user, and wish to migrate , here are the steps:</p>
<h3 id="pre-migration-checks"><span class="header-section-number">9.1.1</span> pre-migration checks</h3>
<ol style="list-style-type: decimal">
<li><p>Check the <a href="#dev-status">dev-status</a> page to make sure all the features you want have been implemented in g3.</p></li>
<li><p>Read the <a href="#g2migr">pre-migration</a> page to see what changes affect you and your users, and how much time it might take you to migrate. (The closer you were to a default install of the old gitolite, the less time a migration will take.)</p>
<p>This includes at least running <code>check-g2-compat</code> to see what are the big issues you might need to address during the migration.</p>
<p>In particular, note if you use any variables that the pre-migration checklist describes as &quot;requires presetting&quot;.</p></li>
</ol>
<h3 id="the-actual-migration"><span class="header-section-number">9.1.2</span> the actual migration</h3>
<p>(Note: You may also like the <a href="#g2migr-example">example migration</a> page).</p>
<p><strong>Note</strong>: nothing in any of the gitolite install/setup/etc will ever touch the <em>data</em> in any repository except the gitolite-admin repo. The only thing it will normally touch in normal repos is the <code>update</code> hook.</p>
<p><strong>Note: all migration happens on the server; you do not need your workstation</strong>.</p>
<ol style="list-style-type: decimal">
<li><p>Carefully wipe out the old gitolite:</p>
<ul>
<li><p>The <strong>code</strong></p>
<ul>
<li><p>Delete or move away all the old gitolite scripts. Check the path to the gl-auth-command in <code>~/.ssh/authorized_keys</code> if you forgot where you put them.</p></li>
<li><p>Delete or move away the two directories named in the two variables <code>GL_PACKAGE_CONF</code> and <code>GL_PACKAGE_HOOKS</code> in <code>~/.gitolite.rc</code>.</p></li>
</ul></li>
<li><p>The <strong>rc file</strong></p>
<ul>
<li>Rename <code>~/.gitolite.rc</code> to something else.</li>
</ul></li>
<li><p>The <strong>admin repo</strong></p>
<ul>
<li>clone <code>~/repositories/gitolite-admin.git</code> to someplace safe</li>
<li>then delete <code>~/repositories/gitolite-admin.git</code></li>
</ul>
<p>(Make sure you do not delete any other repos!)</p></li>
<li><p>The <strong>admin directory</strong>.</p>
<ul>
<li><p>If you need to preserve logs, move the ~/.gitolite/logs` directory somewhere else.</p></li>
<li><p>If you added any custom hooks and wish to preserve them, move the ~/.gitolite/hooks` directory somewhere else.</p></li>
<li><p>Delete <code>~/.gitolite</code>.</p></li>
</ul></li>
</ul></li>
<li><p>Install gitolite g3; see <a href="#install">install</a>.</p></li>
<li><p>If you're using any rc variables that the pre-migration checklist said would &quot;require presetting&quot;, then read about <a href="#rc-preset">presetting</a> the rc file, and follow those instructions to create your new rc file.</p></li>
<li><p>Setup gitolite; see <a href="#setup">setup</a>. However, the 'setup' step need not supply a private key. You can run it as <code>gitolite setup -a admin</code>.</p>
<p>NOTE: ignore any 'split conf not set, gl-conf present...' errors at this time. You may see none, some, or many. It does not matter right now.</p></li>
<li><p>Make sure your gitolite-admin clone has the correct pubkey for the administrator in its <code>keydir</code> directory, then run <a href="#bypass"><code>gitolite push     -f</code></a> to overwrite the &quot;default&quot; admin repo created by the install.</p>
<p><strong>NOTE that is <code>gitolite push</code> not <code>git push</code>!</strong></p></li>
<li><p>Handle any errors, look for migration issues, etc., as described in the links at the top of this page.</p>
<p>This also includes building up your new <code>~/.gitolite.rc</code> file.</p></li>
</ol>
<p>You're done.</p>
<h2 id="g2migr"><span class="header-section-number">9.2</span> pre-migration checklist</h2>
<!-- pandoc: toc -->

<p><font color="red"> <strong>This document is a <em>MUST</em> read if you are currently using g2 and want to move to g3.</strong> </font></p>
<hr />
<p>First things first: g2 will be supported for a good long time for critical bugs, although enhancements and new features won't happen.</p>
<p>Migration should be straightforward, but it is not automatic. The biggest differences are in the rc file, mirroring, &quot;NAME/&quot; rules, and delegation.</p>
<blockquote>
<hr />
</blockquote>
<blockquote>
<p><strong>Presetting the rc file</strong></p>
</blockquote>
<blockquote>
<p>Some rc settings in the older gitolite are such that you cannot directly run <code>gitolite setup</code> when you're ready to migrate. <strong>Doing that will clobber something important</strong>. See <a href="#rc-preset">presetting the rc file</a> for details.</p>
</blockquote>
<blockquote>
<hr />
</blockquote>
<p>The <code>check-g2-compat</code> program attempts to identify any <em>big</em> issues you will be facing; run that first. See <a href="#cg2c">later</a> in this page for what its messages mean. If it does not report any issues, your migrate will probably go quickly. I still suggest you go through the links below in case that program missed something.</p>
<h3 id="incompatible-features"><span class="header-section-number">9.2.1</span> incompatible features</h3>
<p>Here's a list of incompatible features and what you need to do to migrate. Some of them have links where there is more detail than I want to put here.</p>
<h4 id="high-impact"><span class="header-section-number">9.2.1.1</span> high impact</h4>
<p>(serious loss of functionality and/or access control compromised)</p>
<ul>
<li><p><a href="#g2i-name"><code>NAME/</code></a> rules: thes need to change to <code>VREF/NAME/</code>, and you need to add a deny rule at the end because fallthru is &quot;success&quot; for all <a href="#vref">VREFs</a> now, including the &quot;NAME&quot; VREF.</p></li>
<li><p><a href="#g2i-subconf">subconf</a>: if you're using <a href="#deleg">delegation</a>, there is no implicit &quot;subconf&quot; at the end; you'll have to add it in.</p></li>
<li><p>There are several important differences in mirroring. You can start from scratch by reading the new <a href="#mirroring">mirroring</a> doc or <a href="#g2i-mirroring">migrate</a> (carefully!).</p></li>
<li><p><code>ADMIN_POST_UPDATE_CHAINS_TO</code> -- <strong>dropped</strong>. Add your script to the <code>POST_COMPILE</code> trigger chain. Your script won't be getting the arguments that <em>git</em> sends to the post-update hook, but for the admin repo the only argument that even comes in (or is significant) is &quot;refs/heads/master&quot; anyway.</p></li>
<li><p><code>GL_ALL_INCLUDES_SPECIAL</code> -- <strong>dropped</strong>, <strong>requires presetting</strong>.</p>
<p>@all always includes gitweb and daemon now. Use <a href="#deny-rules">deny-rules</a> if you want to say <code>R = @all</code> but not have the repo(s) be visible to gitweb or daemon.</p></li>
<li><p><code>GL_NO_CREATE_REPOS</code> -- <strong>dropped</strong>. If you think you need this, email me. I know one group who does need this so I will be putting it in eventually but not right away. It's almost certain to be renamed anyway.</p></li>
<li><p><code>GL_NO_DAEMON_NO_GITWEB</code> <strong>dropped</strong>, <strong>requires presetting</strong>. Default will clobber your projects.list file and git-daemon-export-ok files.</p>
<p>Comment out the 'daemon' and 'gitweb' lines in the ENABLE list in the rc file. As you can see, gitweb and daemon can now be separately disabled, instead of both being tied to the same setting.</p></li>
<li><p><code>GL_NO_SETUP_AUTHKEYS</code> <strong>dropped</strong>, <strong>requires presetting</strong>. Default will clobber your authkeys file.</p>
<p>Comment out all the line(s) that call ssh-authkeys in the rc file.</p></li>
<li><p><code>UPDATE_CHAINS_TO</code> <strong>dropped</strong>, <strong>requires presetting</strong>. Default will fail to run this extra check when users push.</p>
<p>Use a <a href="#vref">vref</a> instead. You can directly use any existing chained-to script as a VREF; they'll work. Don't forget to add a rule that references the new VREF!</p></li>
<li><p><code>GIT_PATH</code> <strong>dropped</strong>, <strong>requires presetting</strong>.</p>
<p>If you need this, manipulate the PATH environment variable directly. Just put something like this at the end of the rc file:</p>
<pre><code>$ENV{PATH} = &quot;/some/non-standard/path:$ENV{PATH}&quot;;
1;</code></pre></li>
</ul>
<h4 id="medium-impact"><span class="header-section-number">9.2.1.2</span> medium impact</h4>
<p>(important functionality lost, but access control not compromised)</p>
<ul>
<li><p><code>GL_ADMINDIR</code> -- <strong>dropped</strong>, is now at a fixed location: <code>~/.gitolite</code>. If you want it somewhere else go ahead and move it, then place a symlink from the assumed location to the real one.</p></li>
<li><p><code>GL_GET_MEMBERSHIPS_PGM</code> -- is now <code>GROUPLIST_PGM</code>, see <a href="#ldap">here</a>.</p></li>
<li><p><code>GL_WILDREPOS_DEFPERMS</code> -- is gone; see <a href="#roles">roles</a> for how to do this.</p></li>
<li><p><code>REPO_BASE</code> -- <strong>dropped</strong>, is now at a fixed location: <code>~/repositories</code>. If you want it somewhere else go ahead and move it, then place a symlink from the assumed location to the real one.</p></li>
</ul>
<h4 id="low-impact"><span class="header-section-number">9.2.1.3</span> low impact</h4>
<p>(ancillary, non-core, or minor functionality lost)</p>
<ul>
<li><p>Built-in command <code>expand</code> -- <strong>dropped</strong>. The 'info' command shows you both normal and wild repos now. The output format is also much simpler.</p></li>
<li><p>Built-in commands 'getperms', 'setperms' -- <strong>merged</strong> into external command 'perms'. Run <code>ssh git@host perms -h</code> for details.</p>
<p>Similarly, 'getdesc' and 'setdesc' have been merged into 'desc'.</p></li>
<li><p>Several 'ADC's -- see the <a href="#dev-status">dev-status</a> page for more on this.</p></li>
<li><p><a href="#g2i-gl-time">gl-time</a>: the CpuTime module replaces gl-time.</p></li>
<li><p><code>BIG_INFO_CAP</code> -- <strong>dropped</strong>. If you think you must have this, try it without and see if there's a difference. If you <em>know</em> you need this, convince me.</p></li>
<li><p><code>GL_ADC_PATH</code> -- <strong>dropped</strong>. It is obsolete; use <a href="#commands">commands</a> or add <a href="#dev-notes">your own</a>.</p></li>
<li><p><code>GL_ALL_READ_ALL</code> -- <strong>dropped</strong>. If you think you must have this, try it without and see if there's a difference. If you <em>know</em> you need this, convince me.</p></li>
<li><p><code>GL_BIG_CONFIG</code> -- <strong>dropped</strong>. This feature is default now.</p></li>
<li><p><code>GL_CONF</code>, <code>GL_CONF_COMPILED</code>, and <code>GL_KEYDIR</code> -- <strong>dropped</strong>. You had no business touching these anyway; if you did, move them into the expected default locations before attempting to run <code>gitolite setup</code></p></li>
<li><p><code>GL_GITCONFIG_KEYS</code> -- is now <code>GIT_CONFIG_KEYS</code>.</p></li>
<li><p><code>GL_LOGT</code> -- now has a fixed value; email me if this is a problem.</p></li>
<li><p><code>GL_PACKAGE_CONF</code> and <code>GL_PACKAGE_HOOKS</code> -- <strong>dropped</strong>. They are not needed anymore, but check if you had any custom hooks set in the latter location and copy them across.</p></li>
<li><p><code>GL_PERFLOGT</code> -- <strong>dropped</strong>. See <a href="#g2i-gl-time">gl-time</a>.</p></li>
<li><p><code>GL_SITE_INFO</code> -- is now <code>SITE_INFO</code>.</p></li>
<li><p><code>GL_WILDREPOS</code> -- <strong>dropped</strong>. This feature is default now.</p></li>
<li><p><code>GL_WILDREPOS_PERM_CATS</code> -- is now the ROLES hash in the rc file.</p></li>
<li><p><code>RSYNC_BASE</code> -- needs work. Email me if you are using this.</p></li>
<li><p><code>NICE_VALUE</code> -- <strong>dropped</strong>. Uncomment the 'renice 10' line in the rc file. You can also change the 10 to something else if you wish.</p></li>
<li><p><code>PROJECTS_LIST</code> -- is now <code>GITWEB_PROJECTS_LIST</code>. More importantly, it is only used by update-gitweb-access-list in src/commands/post-compile. This variable now has nothing to do with gitolite core, and the rc is just helping to store settings for external programs like that one.</p></li>
<li><p><code>REPO_UMASK</code> -- is now <code>UMASK</code>.</p></li>
<li><p><code>WEB_INTERFACE</code> and <code>GITWEB_URI_ESCAPE</code> -- <strong>dropped</strong>. Patches to the update program to directly do those things are welcome. Personally, I think people who use spaces and other funky characters in dir/file names should be shot but no one listens to me anyway.</p></li>
</ul>
<h3 id="cg2c"><span class="header-section-number">9.2.2</span> using the &quot;check-g2-compat&quot; program</h3>
<p>This program checks a few things only, not everything. In particular, it looks for settings and status that might:</p>
<ul>
<li>make g3 unusable for lots of users</li>
<li>make g3 give <em>more</em> access than g2 under some conditions</li>
</ul>
<p>It does NOT look for or warn about anything else; you're expected to read (and act upon, if needed) the rest of the migration guide links given a few paras above to cover everything else.</p>
<p>Here's an explanation of those messages that the check-g2-compat program may put that contain the words &quot;see docs&quot;:</p>
<ul>
<li><p><code>GL_ADMINDIR in the wrong place -- aborting</code></p>
<p>It expects to find <code>GL_ADMINDIR</code> and <code>REPO_BASE</code> pointing to the right places. It aborts if these conditions are not met and does not scan further since that sort of guesswork is not good. If you are in that position, make a symlink from the real location to the expected location, change the RC accordingly, and re-try.</p></li>
<li><p><code>REPO_BASE in the wrong place -- aborting</code></p>
<p>same as above</p></li>
<li><p><code>NAME rules</code></p>
<p><strong>This is a significant difference and affects access badly (gives access that would otherwise not be given)</strong>. Please see the <a href="#g2incompat">list of non-RC incompatibilities</a>.</p></li>
<li><p><code>subconf command in admin repo</code></p>
<p>This is not so bad security wise but it might <em>reduce</em> access by not processing files you intended to. Again, see the same link as in the previous bullet.</p></li>
<li><p><code>mirroring used</code></p>
<p>There have been quite a few changes to mirroring. You can start from scratch by reading the new <a href="#mirroring">mirroring</a> doc or <a href="#g2i-mirroring">migrate</a> (carefully!).</p></li>
<li><p><code>found N gl-creater files</code></p>
<p>These need to be renamed to <code>gl-creator</code> (the correct spelling at last, hooray!). Suggested command sequence:</p>
<pre><code>cd $HOME/repositories
find . -type d -name &quot;*.git&quot; -prune | while read r
do
    mv $r/gl-creater $r/gl-creator
done 2&gt;/dev/null</code></pre>
<p>Once you do this, the g2 will not work completely unless you change them back.</p></li>
<li><p><code>found N gl-perms files with R or RW</code></p>
<p>Setting perms of R and RW will no longer work; you have to say READERS and WRITERS now. Suggested command:</p>
<pre><code>find `gitolite query-rc GL_REPO_BASE` -name gl-perms |
    xargs perl -pi -e 's/\bR\b/READERS/;s/\bRW\b/WRITERS/'</code></pre></li>
</ul>
<h3 id="rc-preset"><span class="header-section-number">9.2.3</span> presetting the rc file</h3>
<p>Some rc settings in the older gitolite are such that you cannot directly run <code>gitolite setup</code> when you're ready to migrate. <strong>Doing that will clobber something important</strong>. You have to create a default rc file, edit it appropriately, and <em>then</em> run <code>gitolite setup</code>.</p>
<p>The most serious example of this is <code>GL_NO_SETUP_AUTHKEYS</code>, which tells the (old) gitolite that you want to manage <code>~/.ssh/authorized_keys</code> yourself and it should not fiddle with it.</p>
<p>If you don't preset the rc (in this case, by commenting out the 'ssh-authkeys' line) <strong>before</strong> running <code>gitolite setup</code>, <strong>your <code>~/.ssh/authorized_keys</code> file will get clobbered</strong>.</p>
<p>The actual rc settings that require presetting are listed in the &quot;high impact&quot; section above. This section tells you how to do the presetting.</p>
<ul>
<li><p>rename (not just copy) your old (g2) rc file to something else</p></li>
<li><p>run</p>
<pre><code>gitolite print-default-rc &gt; $HOME/.gitolite.rc</code></pre></li>
<li><p>edit the file</p>
<pre><code>${EDITOR:-vim} $HOME/.gitolite.rc</code></pre>
<p>make appropriate changes as described elsewhere in this migration guide, and save it.</p></li>
<li><p><em>then</em> you can run <a href="#setup">gitolite setup</a>.</p></li>
</ul>
<h2 id="g2incompat"><span class="header-section-number">9.3</span> incompatibility with g2</h2>
<p>This page expands on some incompatibilities that were only briefly mentioned in the <a href="#g2migr">pre-migration</a> page.</p>
<h3 id="g2i-name"><span class="header-section-number">9.3.1</span> NAME rules</h3>
<ol style="list-style-type: decimal">
<li><p>NAME/ rules must be changed to VREF/NAME/</p></li>
<li><p>Fallthru on all VREFs is &quot;success&quot; now, so any NAME/ rules you have <strong>MUST</strong> change the ruleset in some way to maintain the same restrictions. The simplest is to add the following line to the end of each repo's rule list:</p>
<pre><code>-   VREF/NAME/       =   @all</code></pre></li>
</ol>
<h3 id="g2i-subconf"><span class="header-section-number">9.3.2</span> subconf command in admin repo</h3>
<p>(This is also affected by the previous issue, 'NAME rules'; please read that as well).</p>
<p>If you're using delegation in your admin conf setup, please add the following lines to the end of the gitolite-admin rules in your conf/gitolite.conf file:</p>
<pre><code>repo gitolite-admin
    -   VREF/NAME/       =   @all

subconf &quot;fragments/*.conf&quot;</code></pre>
<p>The first part compensates for fallthru now being a success when processing <a href="#vref">VREF</a> rules (NAME rules are just one specific VREF). Although, <strong>ideally</strong>, you should change your ruleset so that you no longer require that line. As the <a href="#vref">vref documentation</a> says:</p>
<blockquote>
<p><strong>Virtual refs are best used as additional &quot;deny&quot; rules</strong>, performing extra checks that core gitolite cannot.</p>
</blockquote>
<p>The second part explicitly says when and where to include the subconf files. (Before subconf was invented, this used to happen implicitly at the end of the main conf file, and was hardcoded to that specific glob.)</p>
<h3 id="g2i-gl-time"><span class="header-section-number">9.3.3</span> gl-time for performance measurement</h3>
<p>If you've been using gl-time for performance measurement, there's a much better system available now.</p>
<p>gl-time used to only log elapsed time. The new 'CpuTime' trigger module shipped with gitolite, if enabled in the rc file, can also report CPU times using perl's 'times()' function. See comments within that file and in the default rc file that contain the word &quot;cpu&quot;, for more details.</p>
<p>Further, you can copy that module with a different name, add your own functionality, and invoke <em>that</em> from the rc file instead.</p>
<h3 id="g2i-mirroring"><span class="header-section-number">9.3.4</span> changes in mirroring setup</h3>
<p>There are several changes with regard to mirroring:</p>
<ul>
<li><p>There is no 'post-receive' hook to be installed. Mirroring is handled by g3's <a href="#triggers">triggers</a> mechanism. Gitolite triggers are enabled by adding (or uncommenting, in this case) appropriate lines in the rc file.</p>
<p>You need to either remove these files (actually symlinks) from each repo's 'hooks' directory, or remove the old (v2) sources so they become broken symlinks.</p></li>
<li><p>The <code>GL_HOSTNAME</code> variable is now <code>HOSTNAME</code>. (Note that the rc file syntax itself has changed quite a bit; to be accurate, HOSTNAME is not a variable but a hash key with an associated value).</p></li>
<li><p>The <code>GL_GITCONFIG_KEYS</code> variable is now <code>GIT_CONFIG_KEYS</code>, <strong>but</strong> you no longer need to set it to anything for mirroring to work.</p></li>
<li><p>The <code>gl-tool</code> program does not exist anymore. Adding keys for peer servers is done just like adding user keys, except that the pubkey file name must start with <code>server-</code>. For example, to add a peer host called frodo, you will acquire its pubkey and add it as <code>server-frodo.pub</code>.</p></li>
<li><p>The config variables are quite different now. The main ones now look like this:</p>
<pre><code>option mirror.master        =   sam
option mirror.slaves        =   frodo gollum</code></pre>
<p>The redirectOK looks like this:</p>
<pre><code>option mirror.redirectOK    =   frodo</code></pre>
<p>The special value &quot;true&quot; to say that all slaves are trusted is now &quot;all&quot;:</p>
<pre><code>option mirror.redirectOK    =   all</code></pre></li>
<li><p>There are no more mirroring &quot;keys&quot;, (lists of servers named in config keys like 'gitolite.mirror.nightly', etc). You can certainly add lines like</p>
<pre><code>option mirror.nightly       =   merry pippin</code></pre>
<p>but they will not be processed by gitolite. Your cron jobs should use <code>gitolite git-config</code> to query this variable, grab the list of peers, and run <code>gitolite mirror</code> on each of them.</p></li>
<li><p>The external command to resync mirrors is 'mirror', run just like any other <a href="#commands">command</a>. In particular, you can run <code>gitolite mirror     -h</code> to get help. It cannot be run from a slave to ask a master to push (unlike in the old system) but what's more convenient is that any user who has any access to the master can run it remotely (if you allow it) to invoke a push.</p></li>
</ul>
<h2 id="g2migr-example"><span class="header-section-number">9.4</span> migration example</h2>
<!-- pandoc: toc -->

<p>This shows what a typical migration would look like, using a test setup.</p>
<h3 id="existing-setup"><span class="header-section-number">9.4.1</span> existing setup</h3>
<p>The existing gitolite is the latest in the &quot;g2&quot; (v2.x) branch.</p>
<p>First, the rc file has the following lines different from the default:</p>
<pre><code>-$GL_WILDREPOS = 0;
+$GL_WILDREPOS = 1;

-$GL_GITCONFIG_KEYS = &quot;&quot;;
+$GL_GITCONFIG_KEYS = &quot;.*&quot;;</code></pre>
<p>Next, the conf/gitolite.conf file in <code>~/.gitolite</code>:</p>
<pre><code>repo    gitolite-admin
        RW+             =   tester u1

repo    testing
        RW+     =   @all

repo foo
        RW+             =   u1 u2
        RW+ NAME/       =   u1
        RW+ NAME/u2     =   u2

repo bar
        RW  =   u2

repo baz/..*
        C   =   u3 u4
        RW+         =   CREATOR
        config foo.bar = baz</code></pre>
<p>(Note that this conf file has NAME/ rules, which <strong>have changed</strong> significantly in g3; see <a href="#g2i-name">here</a> for details).</p>
<p>These are the repos already existing</p>
<pre><code>$ find repositories -name &quot;*.git&quot; | sort
repositories/bar.git
repositories/baz/u3.git
repositories/baz/u4.git
repositories/baz/uthree.git
repositories/foo.git
repositories/gitolite-admin.git
repositories/testing.git</code></pre>
<p>The config entries exist for all the baz/ repos:</p>
<pre><code>$ grep -2 foo `find repositories -name &quot;config&quot; `
repositories/baz/uthree.git/config-[gitweb]
repositories/baz/uthree.git/config- owner = u3
repositories/baz/uthree.git/config:[foo]
repositories/baz/uthree.git/config- bar = baz
--
repositories/baz/u4.git/config-[gitweb]
repositories/baz/u4.git/config-     owner = u4
repositories/baz/u4.git/config:[foo]
repositories/baz/u4.git/config-     bar = baz
--
repositories/baz/u3.git/config-[gitweb]
repositories/baz/u3.git/config-     owner = u3
repositories/baz/u3.git/config:[foo]
repositories/baz/u3.git/config-     bar = baz</code></pre>
<h3 id="preparing-for-the-migration"><span class="header-section-number">9.4.2</span> preparing for the migration</h3>
<h4 id="getting-g3"><span class="header-section-number">9.4.2.1</span> getting g3</h4>
<p>Fortunately this is easy here; I just happened to have the repo already fetched so I just had to switch branches. You may have to 'git clone ...' from github.</p>
<pre><code>$ cd gitolite
$ git checkout master
Branch master set up to track remote branch master from origin.
Switched to a new branch 'master'</code></pre>
<h4 id="run-check-g2-compat"><span class="header-section-number">9.4.2.2</span> run check-g2-compat</h4>
<p>This is a quick and dirty program to catch some of the big issues.</p>
<pre><code>$ cd
$ gitolite/check-g2-compat
INFO        This program only checks for uses that make the new g3 completely unusable
            or that might end up giving *more* access to someone if migrated as-is.
            It does NOT attempt to catch all the differences described in the docs.

INFO        'see docs' usually means the pre-migration checklist in
            &quot;g2migr.html&quot;; to get there, start from the main migration
            page at http://sitaramc.github.com/gitolite/install.html#migr

checking rc file...
NOTE        GL_ADMINDIR is in the right place; assuming you did not mess with
            GL_CONF, GL_LOGT, GL_KEYDIR, and GL_CONF_COMPILED

checking conf file(s)...
SEVERE      NAME rules; see docs

checking repos...
WARNING     found 3 gl-creater files; see docs

...all done...</code></pre>
<h3 id="the-actual-migration-1"><span class="header-section-number">9.4.3</span> the actual migration</h3>
<p>Here's the actual migration, step by step</p>
<h4 id="step-1"><span class="header-section-number">9.4.3.1</span> step 1</h4>
<pre><code>$ ls -a bin
.                gl-admin-push    gl-install       gl-setup-authkeys  gl-VREF-DUPKEYS
..               gl-auth-command  gl-mirror-push   gl-system-install  gl-VREF-EMAIL_CHECK
gitolite_env.pm  gl-compile-conf  gl-mirror-shell  gl-time            gl-VREF-FILETYPE
gitolite.pm      gl-conf-convert  gl-query-rc      gl-tool            gl-VREF-MERGE_CHECK
gitolite_rc.pm   gl-dryrun        gl-setup         gl-VREF-COUNT      sshkeys-lint
$ rm -rf bin;mkdir bin

$ grep GL_PACKAGE .gitolite.rc
$GL_PACKAGE_CONF = &quot;/home/git/share/gitolite/conf&quot;;
$GL_PACKAGE_HOOKS = &quot;/home/git/share/gitolite/hooks&quot;;
$ rm -rf share

$GL_PACKAGE_HOOKS = &quot;/home/git/share/gitolite/hooks&quot;;
$ rm -rf share

$ mv .gitolite.rc old.grc</code></pre>
<p>(still on step 1, this is substep 3) notice we are cloning <strong>on the server</strong>, using a <strong>full path</strong> to the repo.</p>
<pre><code>$ git clone repositories/gitolite-admin.git old.ga
Cloning into 'old.ga'...
done.
$ rm -rf repositories/gitolite-admin.git/</code></pre>
<p>Since I'm not interested in preserving the logs and don't have any custom hooks:</p>
<pre><code>$ rm -rf .gitolite</code></pre>
<h4 id="step-2"><span class="header-section-number">9.4.3.2</span> step 2</h4>
<p>I have no variables that <em>must</em> be preset, since the report by <code>check-g2-compat</code> is clear.</p>
<h4 id="step-3"><span class="header-section-number">9.4.3.3</span> step 3</h4>
<p>Here we install the new gitolite. Remember we already got the new software (in order to run 'check-g2-compat').</p>
<p>Just check that bin is empty, then run 'install -ln' from the gitolite source tree:</p>
<pre><code>$ ls -al bin
total 8
drwxrwxr-x 2 git git 4096 Apr 24 10:57 .
drwx------ 8 git git 4096 Apr 24 10:59 ..
$ gitolite/install -ln
$ ls -al bin
total 8
drwxrwxr-x 2 git git 4096 Apr 24 11:01 .
drwx------ 8 git git 4096 Apr 24 10:59 ..
lrwxrwxrwx 1 git git   30 Apr 24 11:01 gitolite -&gt; /home/git/gitolite/src/gitolite</code></pre>
<p>OK that went well. Now setup gitolite. You don't need a key here; just use a random name:</p>
<pre><code>$ gitolite setup -a admin
Initialized empty Git repository in /home/git/repositories/gitolite-admin.git/</code></pre>
<h4 id="step-4"><span class="header-section-number">9.4.3.4</span> step 4</h4>
<p>Now go to your old clone, and push it:</p>
<pre><code>$ cd old.ga
$ gitolite push -f
    ...usual git progress output deleted...
remote: FATAL: git config foo.bar not allowed
remote: check GIT_CONFIG_KEYS in the rc file
To /home/git/repositories/gitolite-admin.git
 + 7eb8163...1474770 master -&gt; master (forced update)</code></pre>
<p>Aaha! I forgot to set <code>GIT_CONFIG_KEYS</code> (new name for <code>GL_GITCONFIG_KEYS</code>) in the new rc file so fix that:</p>
<pre><code>$ vim ~/.gitolite.rc
(edit and set it to `.*` for now)</code></pre>
<p>and push again:</p>
<pre><code>$ gitolite push -f
Everything up-to-date</code></pre>
<p>Damn. We have to make a dummy commit to allow the push to do something.</p>
<p>But wait! We forgot fix the <a href="#g2i-name">NAME/</a> rules, so may as well fix those, add, and push:</p>
<pre><code>$ vim conf/gitolite.conf
# change all NAME/ to VREF/NAME/
# append a '- VREF/NAME/ = @all' at the end
# save
git add conf

$ git commit -m name-rules
    ... some output for add...

$ gitolite push -f
Counting objects: 1, done.
Writing objects: 100% (1/1), 181 bytes, done.
Total 1 (delta 0), reused 0 (delta 0)
Unpacking objects: 100% (1/1), done.
To /home/git/repositories/gitolite-admin.git
   1474770..4c2b41d  master -&gt; master</code></pre>
<h4 id="step-5"><span class="header-section-number">9.4.3.5</span> step 5</h4>
<p>The only thing left is to fix up the gl-creater files:</p>
<pre><code>$ cd $HOME/repositories
$ find . -type d -name &quot;*.git&quot; -prune | while read r
&gt; do
&gt;     mv $r/gl-creater $r/gl-creator
&gt; done 2&gt;/dev/null</code></pre>
<p>And we're done!</p>
<h3 id="checking-things-out"><span class="header-section-number">9.4.4</span> checking things out</h3>
<p>Let's see what repos u3 has:</p>
<pre><code># as user 'u3'
ssh git@server info
hello u3, this is git@server running gitolite3 v3.0-11-g090b0f5 on git 1.7.7.6

     C      baz/..*
 R W        baz/u3
 R W        baz/uthree
 R W        gitolite-admin
 R W        testing</code></pre>
<p>That's a combination of 'info' and 'expand', by the way. There is no expand command any more.</p>
<p>How about adding a new repo and checking if the config entries made it?</p>
<pre><code># as user u4
$ git ls-remote git@server:baz/ufour
Initialized empty Git repository in /home/git/repositories/baz/ufour.git/
$ grep -A1 foo `find repositories -name &quot;config&quot; `
repositories/baz/u3.git/config:[foo]
repositories/baz/u3.git/config- bar = baz
--
repositories/baz/u4.git/config:[foo]
repositories/baz/u4.git/config- bar = baz
--
repositories/baz/ufour.git/config:[foo]
repositories/baz/ufour.git/config-      bar = baz
--
repositories/baz/uthree.git/config:[foo]
repositories/baz/uthree.git/config-     bar = baz</code></pre>
<p>And there it is, in the second block of lines...</p>
<p>And now we're really done.</p>
<h2 id="gsmigr"><span class="header-section-number">9.5</span> migrating from gitosis to gitolite</h2>
<p>[2012-04-09] Modified for gitolite g3. These instructions have not really been tested with g3, but are expected to work.</p>
<p>Migrating from gitosis to gitolite is fairly easy, because the basic design is the same.</p>
<p>There's only one thing that might trip up people: the userid. Gitosis uses <code>gitosis</code>. Gitolite can use any userid you want; most of the documentation uses <code>git</code>, while DEB/RPM packages use <code>gitolite</code>.</p>
<p>Here are the steps on the server:</p>
<ul>
<li><p>(as 'gitosis' on the server) <strong>Rename</strong> <code>~/.ssh/authorized_keys</code> to something else so that no one can accidentally push while you're doing this.</p></li>
<li><p>(as 'gitosis' on the server) For added safety, <strong>delete</strong> the post-update hook that gitosis-admin installed</p>
<pre><code>rm ~/repositories/gitosis-admin.git/hooks/post-update</code></pre>
<p>or at least rename it to <code>.sample</code> like all the other hooks hanging around, or edit it and comment out the line that calls <code>gitosis-run-hook post-update</code>.</p></li>
<li><p>(as 'gitosis' on the server) If you already use the <code>update</code> hook for some reason, you'll have to make that a <a href="#vref">VREF</a>. This is because gitolite uses the update hook for checking write access.</p></li>
<li><p>(as 'root' on the server) copy all of <code>~/repositories</code> to the gitolite <a href="#nnc">hosting user</a>'s home directory. Something like</p>
<pre><code>cp -a /home/gitosis/repositories /home/git
chown -R git.git /home/git/repositories</code></pre></li>
<li><p>(as 'root' and/or 'git' on the server) Follow instructions to install gitolite; see the <a href="#install">install document</a>.</p>
<p>This will give you a gitolite config that has the required entries for the &quot;gitolite-admin&quot; repo.</p></li>
</ul>
<p>Now, log off the server and get back to the client. All subsequent instructions are to be read as &quot;on gitolite admin's workstation&quot;.</p>
<ul>
<li><p><strong>Clone</strong> the new gitolite-admin repo to your workstation. (You already have a clone of the gitosis-admin repo so now you have both).</p></li>
<li><p><strong>Convert</strong> your gitosis config file and append it to your gitolite config file. Substitute the path for your gitosis-admin clone in <code>$GSAC</code> below, and similarly the path for your gito<strong>lite</strong>-admin clone in <code>$GLAC</code>. (The convert-gitosis-conf program is a standalone program that you can bring over from any gitolite clone; you don't have to install all of gitolite on your workstation to use this):</p>
<pre><code>./convert-gitosis-conf &lt; $GSAC/gitosis.conf &gt;&gt; $GLAC/conf/gitolite.conf</code></pre>
<p><strong>Be sure to check the file to make sure it converted correctly</strong> -- due it's &quot;I only need it once&quot; nature, this program has not received too much attention from anyone!</p></li>
<li><p>Remove the entry for the 'gitosis-admin' repo. You do not need it here and it may cause confusion.</p></li>
<li><p><strong>Copy</strong> the keys from gitosis's keydir (same meanings for GSAC and GLAC)</p>
<pre><code>cp $GSAC/keydir/* $GLAC/keydir</code></pre>
<p>If your gitosis-admin key was <code>you@machine.pub</code>, and you supplied the same one to gitolite's gl-setup program as <code>you.pub</code> when you installed gitolite, then you should remove <code>you@machine.pub</code> from the new keydir now. Otherwise you will have 2 pubkey files (<code>you.pub</code> and <code>you@machine.pub</code>) which are identical, which is <em>not</em> a good idea.</p>
<p>Similarly, you should replace all occurrences of <code>you@machine.pub</code> with <code>you</code> in the <code>conf/gitolite.conf</code> file.</p></li>
<li><p><strong>IMPORTANT</strong>: if you have any users with names like <code>user@foo</code>, where the part after the <code>@</code> does <em>not</em> have a <code>.</code> in it (i.e., does not look like an email address), you need to change them, because gitolite uses that syntax for <a href="#multi-key">enabling multi keys</a>.</p>
<p>You have two choices in how to fix this. You can change the gitolite config so that all mention of <code>user@foo</code> is changed to just <code>user</code>.</p>
<p>Or you can change each occurrence of <code>user@foo</code> to, say, <code>user_foo</code> <em>and</em> change the pubkey filename in keydir/ also the same way (<code>user_foo.pub</code>).</p>
<p>Just to repeat, you do NOT need to do this if the username was like <code>user@foo.bar</code>, i.e., the part after the <code>@</code> had a <code>.</code> in it, because then it looks like an email address.</p></li>
<li><p><strong>IMPORTANT: expand any multi-key files you may have</strong>. Gitosis is happy to accept files containing more than one public key (one per line) and assign all the keys to the same user. Gitolite does not allow that; see <a href="#multi-key">here</a>'s for how gitolite handles multi-keys.</p>
<p>So if you had any multi-keys in gitosis, they need to be carefully split into individual keys.</p>
<p>You can split the keys manually, or use the following code (just copy-paste it into your xterm after &quot;cd&quot;-ing to your gitolite-admin repo clone):</p>
<pre><code>wc -l keydir/*.pub | grep -v total | grep -v -w 1 | while read a b
do
    i=1
    cat $b|while read l
    do
        echo &quot;$l&quot; &gt; ${b%.pub}@$i.pub
        (( i++ ))
    done
    mv $b $b.done
done</code></pre>
<p>This will split each multi-key file (say &quot;sitaram.pub&quot;) into individual files called &quot;sitaram@1.pub&quot;, &quot;sitaram@2.pub&quot;, etc., and rename the original to &quot;sitaram.pub.done&quot; so gitolite won't pick it up.</p>
<p>At this point you can rename the split parts more appropriately, like &quot;sitaram@laptop.pub&quot; and &quot;sitaram@desktop.pub&quot; or whatever. <em>Please check the files to make sure this worked properly</em></p></li>
<li><p>Check all your changes to your gitolite-admin clone, commit, and push.</p></li>
</ul>
</body>
</html>
