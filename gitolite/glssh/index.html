<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>how gitolite uses ssh - Gitolite</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/gitolite.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">Gitolite</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">what/why <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../overview/">overview</a>
</li>
                            
<li >
    <a href="../concepts/">concepts, conventions, terminology</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">install and setup <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../quick_install/">(unix/ssh experts) quick install and setup</a>
</li>
                            
<li >
    <a href="../install/">normal ssh mode install and setup</a>
</li>
                            
<li >
    <a href="../fool_proof_setup/">(if all else fails) fool-proof, step-by-step, install and setup</a>
</li>
                            
<li >
    <a href="../http/">HTTP mode install</a>
</li>
                            
<li >
    <a href="../migr/">migrating from v2</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">use <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">basic</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../basic-admin/">basic administration</a>
</li>
            
<li >
    <a href="../conf/">the "conf" file (part 1)</a>
</li>
            
<li >
    <a href="../conf-2/">the "conf" file (part 2)</a>
</li>
            
<li >
    <a href="../rc/">the "rc" file</a>
</li>
            
<li >
    <a href="../user/">your users' view</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">advanced</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../git-config/">setting git-config values</a>
</li>
            
<li >
    <a href="../options/">gitolite options</a>
</li>
            
<li >
    <a href="../wild/">ad hoc user-created ("wild") repos</a>
</li>
            
<li >
    <a href="../templates/">using templates</a>
</li>
            
<li >
    <a href="../vref/">virtual refs (part 1)</a>
</li>
            
<li >
    <a href="../vref-2/">virtual refs (part 2)</a>
</li>
            
<li >
    <a href="../deleg/">delegation of admin duties</a>
</li>
            
<li >
    <a href="../gitweb-daemon/">gitweb and git-daemon</a>
</li>
            
<li >
    <a href="../mirroring/">mirroring</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">customise</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../non-core/">core and "non-core" gitolite</a>
</li>
            
<li >
    <a href="../dev-notes/">writing your own non-core code</a>
</li>
            
<li >
    <a href="../triggers/">gitolite triggers</a>
</li>
            
<li >
    <a href="../list-non-core/">list of non-core programs shipped with gitolite</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../cookbook/">(quick! how do I...) the cookbook</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">HELP! <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../emergencies/">emergency!!</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">ssh</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../ssh/">ssh</a>
</li>
            
<li class="active">
    <a href="./">how gitolite uses ssh</a>
</li>
            
<li >
    <a href="../sts/">ssh troubleshooting</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../regex/">regular expressions</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">other docs <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../odds-and-ends/">miscellaneous features</a>
</li>
                            
<li >
    <a href="../namespaces/">using git namespaces</a>
</li>
                            
<li >
    <a href="../locking/">locking binary files</a>
</li>
                            
<li >
    <a href="../testing/">testing gitolite</a>
</li>
                            
<li >
    <a href="../package/">packaging gitolite</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">more about gitolite</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../files/">gitolite files & directories</a>
</li>
            
<li >
    <a href="../rc-33/">the 3.3 format rc file</a>
</li>
            
<li >
    <a href="../perf/">performance</a>
</li>
            
<li >
    <a href="../internals/">internals</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">contrib</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../contrib/ssh-and-http/">Using both ssh and http</a>
</li>
            
<li >
    <a href="../contrib/putty/">Putty and Msysgit</a>
</li>
            
<li >
    <a href="../contrib/sskm/">Self-service key management</a>
</li>
            
<li >
    <a href="../contrib/ukm/">User key management</a>
</li>
            
<li >
    <a href="../contrib/README-emacs/">Emacs major mode</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../no-way/">no way!</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../ssh/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../sts/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#how-gitolite-uses-ssh">how gitolite uses ssh</a></li>
        <li class="main "><a href="#ssh-basics">ssh basics</a></li>
        <li class="main "><a href="#how-does-gitolite-use-all-this-ssh-magic">how does gitolite use all this ssh magic?</a></li>
            <li><a href="#restricting-shell-accessdistinguishing-one-user-from-another">restricting shell access/distinguishing one user from another</a></li>
            <li><a href="#restricting-branch-level-actions">restricting branch level actions</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="how-gitolite-uses-ssh">how gitolite uses ssh<a class="headerlink" href="#how-gitolite-uses-ssh" title="Permanent link">ÔÉÅ</a></h1>
<hr />
<p>Although other forms of authentications exist (see the section on
<a href="../concepts/#authentication-and-authorisation">authentication versus authorisation</a>), ssh is the one that most git
users use.</p>
<p><strong><em>Therefore, gitolite is (usually) heavily dependent on ssh</em></strong>.</p>
<p>Most people didn't realise this, and even if they did they don't know ssh
well enough to help themselves.  If you don't understand how ssh public key
authentication works, or how the <code>~/.ssh/authorized_keys</code> file can be used to
restrict users, etc., you will have endless amounts of trouble getting
gitolite to work, because you'll be attacking the wrong problem.</p>
<p>So please please please understand this before tearing your hair out and
blaming <strong><em>git/gitolite</em></strong> for whatever is going wrong with your setup :-)</p>
<h1 id="ssh-basics">ssh basics<a class="headerlink" href="#ssh-basics" title="Permanent link">ÔÉÅ</a></h1>
<p>Let's start with some basics, focusing <em>only</em> on the pieces relevant to
<code>gitolite</code>.  If this is not detailed enough, please use google and learn more
from somewhere, or maybe buy the OReilly ssh book.</p>
<ul>
<li>
<p>You can login to an ssh server by typing a password, but ssh can also use
    <strong><em>public-private keys</em></strong> (also called "key pairs") for authentication.
    <code>gitolite</code> <em>requires</em> you to use this mechanism for your users -- they
    cannot log in using passwords.  Hopefully by the time you finish reading
    this page you will understand why :-)</p>
<p>The way you set this up is you generate a key pair on your workstation,
and give the server the public key.  (I need not add that the "private"
key must be, well, kept <em>private</em>!)</p>
</li>
<li>
<p><strong>Generating a key pair on your workstation</strong> is done by running the
    command <code>ssh-keygen -t rsa</code>.  This produces two files in <code>~/.ssh</code>.  One is
    <code>id_rsa</code>; this is the <strong>private</strong> key -- <strong><em>never</em></strong> let it out of your
    machine.  The other is <code>id_rsa.pub</code>, which is the corresponding public
    key.  This public key is usually just one long line of text.</p>
<ul>
<li>On Windows machines with msysgit installed, you should do this from
  within a "git bash" window.  The command will report the full path where
  the files have been written; make a note of this, and use those files in
  any of the description that follows.</li>
</ul>
</li>
<li>
<p><strong>Adding your public key to the server</strong>'s <code>~/.ssh/authorized_keys</code>
    file is how ssh uses pubkeys to authenticate users.  Let's say
    sita@work.station is trying to log in as git@serv.er.  What you have to do
    is take the <code>~/.ssh/id_rsa.pub</code> file for user sita on work.station and
    append its contents (remember it's only one line) to
    <code>~/.ssh/authorized_keys</code> for user git on serv.er.</p>
<p>The <code>authorized_keys</code> file can have multiple public keys (from many
different people) added to it so any of them can log in to git@serv.er.</p>
<p>In the normal case (not gitolite, but your normal everyday shell access),
there's a command that does this, <code>ssh-copy-id</code>, which also fixes up
permissions etc., as needed, since sshd is a little picky about allowing
pubkey access if permissions on the server are loose.  Or you can do it
manually, as long as you know what you're doing and you're careful not to
erase or overwrite the existing contents of <code>~/.ssh/authorized_keys</code> on
the server!</p>
<p>But with gitolite, it does this for you; see <a href="../basic-admin/#addremove-users">adding and removing
users</a> for more.</p>
<ul>
<li><strong>Troubleshooting pubkey authentication failures</strong>: if you are unable to
  get ssh access to the server after doing all this, you'll have to look
  in <code>/var/log/secure</code> or <code>/var/log/auth.log</code> or some such file on the
  server to see what specific error <code>sshd</code> is complaining about.</li>
</ul>
</li>
<li>
<p><strong>Restricting users to specific commands</strong> is very important for gitolite.
    If you read <code>man sshd</code> and look for <code>authorized_keys file format</code>, you'll
    see a lot of options you can add to the public key line, which restrict
    the incoming user in various ways.  In particular, note the <code>command=</code>
    option, which means "regardless of what the incoming user is asking to do,
    forcibly run this command instead".</p>
<p>Also note that when there are many public keys (i.e., lines) in the
<code>authorized_keys</code> file, each line can have a <em>different</em> set of options
and <code>command=</code> values.</p>
<p>Without this <code>command=</code> option, the ssh daemon will simply give you a
shell, which is not what we want for our gitolite keys (although we may
well have other keys which we use to get a shell).</p>
<p><strong>This is the backbone of what makes gitolite work; please make sure you
understand this</strong>.</p>
</li>
</ul>
<h1 id="how-does-gitolite-use-all-this-ssh-magic">how does gitolite use all this ssh magic?<a class="headerlink" href="#how-does-gitolite-use-all-this-ssh-magic" title="Permanent link">ÔÉÅ</a></h1>
<p>These are two different questions you ought to be having by now: </p>
<ul>
<li>How does it distinguish between me and someone else, since we're all
    logging in as the same remote user "git".</li>
<li>How does it restrict what I can do within a repository.</li>
</ul>
<h2 id="restricting-shell-accessdistinguishing-one-user-from-another">restricting shell access/distinguishing one user from another<a class="headerlink" href="#restricting-shell-accessdistinguishing-one-user-from-another" title="Permanent link">ÔÉÅ</a></h2>
<p>The answer to the first question is the <code>command=</code> we talked about before.  If
you look in the <code>authorized_keys</code> file, you'll see entries like this (I chopped
off the ends of course; they're pretty long lines):</p>
<pre><code>command="[path]/gitolite-shell sitaram",[more options] ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA18S2t...
command="[path]/gitolite-shell usertwo",[more options] ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEArXtCT...
</code></pre>
<p>First, it finds out which of the public keys in this file match the incoming
login.  That's crypto stuff, and I won't go into it.  Once the match has been
found, it will run the command given on that line; e.g., if I logged in, it
would run <code>[path]/gitolite-shell sitaram</code>.  So the first thing to note is
that such users do not get "shell access", which is good!</p>
<p>Before running the command, however, sshd sets up an environment variable
called <code>SSH_ORIGINAL_COMMAND</code> which contains the actual git command that your
workstation sent out.  This is the command that <em>would have run</em> if you did
not have the <code>command=</code> part in the authorised keys file.</p>
<p>When <code>gitolite-shell</code> gets control, it looks at the first argument
("sitaram", "usertwo", etc) to determine who you are.  It then looks at the
<code>SSH_ORIGINAL_COMMAND</code> variable to find out which repository you want to
access, and whether you're reading or writing.</p>
<p>Now that it has a user, repository, and access requested (read/write), gitolite looks
at its config file, and either allows or rejects the request.</p>
<p>But this cannot differentiate between different branches within a repo; that
has to be done separately.</p>
<h2 id="restricting-branch-level-actions">restricting branch level actions<a class="headerlink" href="#restricting-branch-level-actions" title="Permanent link">ÔÉÅ</a></h2>
<p>[If you look inside the git source tree, there's a file among the "howto"s in
there called <code>update-hook-example.txt</code>, which was the inspiration for this
part of gitolite.]</p>
<p>Git allows you to specify many "hooks", which get control as various events
happen -- see <code>git help hooks</code> for details.  One of those hooks is the
<code>update</code> hook, which, if it is present, is invoked just before a branch or a
tag is about to be updated.  The hook is passed the name of the branch or tag,
the old SHA1 value, and the new SHA1 value, as arguments.  Hooks that are
called <em>before</em> an action happens are allowed to prevent that action from
happening by returning an error code.</p>
<p>When gitolite is told to create a new repository (by the admin), it installs
a special update hook.  This hook takes all the information presented, looks
at the config file, and decides to allow or reject the update.</p>
<p>And that's basically it.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
