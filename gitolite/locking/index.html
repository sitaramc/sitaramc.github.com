<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>locking binary files - Gitolite</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/gitolite.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">Gitolite</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">what/why <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../overview/">overview</a>
</li>
                            
<li >
    <a href="../concepts/">concepts, conventions, terminology</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">install and setup <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../quick_install/">(unix/ssh experts) quick install and setup</a>
</li>
                            
<li >
    <a href="../install/">normal ssh mode install and setup</a>
</li>
                            
<li >
    <a href="../fool_proof_setup/">(if all else fails) fool-proof, step-by-step, install and setup</a>
</li>
                            
<li >
    <a href="../http/">HTTP mode install</a>
</li>
                            
<li >
    <a href="../migr/">migrating from v2</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">use <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">basic</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../basic-admin/">basic administration</a>
</li>
            
<li >
    <a href="../conf/">the "conf" file (part 1)</a>
</li>
            
<li >
    <a href="../conf-2/">the "conf" file (part 2)</a>
</li>
            
<li >
    <a href="../rc/">the "rc" file</a>
</li>
            
<li >
    <a href="../user/">your users' view</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">advanced</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../git-config/">setting git-config values</a>
</li>
            
<li >
    <a href="../options/">gitolite options</a>
</li>
            
<li >
    <a href="../wild/">ad hoc user-created ("wild") repos</a>
</li>
            
<li >
    <a href="../templates/">using templates</a>
</li>
            
<li >
    <a href="../vref/">virtual refs (part 1)</a>
</li>
            
<li >
    <a href="../vref-2/">virtual refs (part 2)</a>
</li>
            
<li >
    <a href="../deleg/">delegation of admin duties</a>
</li>
            
<li >
    <a href="../gitweb-daemon/">gitweb and git-daemon</a>
</li>
            
<li >
    <a href="../mirroring/">mirroring</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">customise</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../non-core/">core and "non-core" gitolite</a>
</li>
            
<li >
    <a href="../dev-notes/">writing your own non-core code</a>
</li>
            
<li >
    <a href="../triggers/">gitolite triggers</a>
</li>
            
<li >
    <a href="../list-non-core/">list of non-core programs shipped with gitolite</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../cookbook/">(quick! how do I...) the cookbook</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">HELP! <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../emergencies/">emergency!!</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">ssh</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../ssh/">ssh</a>
</li>
            
<li >
    <a href="../glssh/">how gitolite uses ssh</a>
</li>
            
<li >
    <a href="../sts/">ssh troubleshooting</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../regex/">regular expressions</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">other docs <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../odds-and-ends/">miscellaneous features</a>
</li>
                            
<li >
    <a href="../namespaces/">using git namespaces</a>
</li>
                            
<li class="active">
    <a href="./">locking binary files</a>
</li>
                            
<li >
    <a href="../testing/">testing gitolite</a>
</li>
                            
<li >
    <a href="../package/">packaging gitolite</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">more about gitolite</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../files/">gitolite files & directories</a>
</li>
            
<li >
    <a href="../rc-33/">the 3.3 format rc file</a>
</li>
            
<li >
    <a href="../perf/">performance</a>
</li>
            
<li >
    <a href="../internals/">internals</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">contrib</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../contrib/ssh-and-http/">Using both ssh and http</a>
</li>
            
<li >
    <a href="../contrib/putty/">Putty and Msysgit</a>
</li>
            
<li >
    <a href="../contrib/sskm/">Self-service key management</a>
</li>
            
<li >
    <a href="../contrib/ukm/">User key management</a>
</li>
            
<li >
    <a href="../contrib/README-emacs/">Emacs major mode</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../no-way/">no way!</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../namespaces/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../testing/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#locking-binary-files">locking binary files</a></li>
        <li class="main "><a href="#problem-description">problem description</a></li>
        <li class="main "><a href="#adminsetup">admin/setup</a></li>
        <li class="main "><a href="#user-view">user view</a></li>
        <li class="main "><a href="#detailed-example">detailed example</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="locking-binary-files">locking binary files<a class="headerlink" href="#locking-binary-files" title="Permanent link"></a></h1>
<hr />
<p>Locking is useful to make sure that binary files (office docs, images, ...)
don't get into a merge state.  (<font color="gray">If you think it's not a big
deal, you have never manually merged independent changes to an ODT or
something!</font>)</p>
<p><strong>When git is used in a truly distributed fashion, locking is impossible.</strong>
However, in most corporate setups, there is a single central server acting as
the canonical source of truth and collaboration point for all developers.  In
this situation it should be possible to at least prevent commits from being
pushed that contains changes to files locked by someone else.</p>
<p>The two "lock" programs (one a command that a user uses, and one a VREF that
the admin adds to a repo's access rules) together attempt to achieve this.</p>
<p>Of course, locking by itself is not quite enough.  You may still get into
merge situations if you make changes in branches.  For best results you should
actually keep all the binary files in their own branch, separate from the ones
containing source code.</p>
<hr />
<h1 id="problem-description">problem description<a class="headerlink" href="#problem-description" title="Permanent link"></a></h1>
<p>Our users are alice, bob, and carol.  Our repo is foo.  It has some "odt"
files in the "doc/" directory.  We want to make sure these odt files never get
into a "merge" situation.</p>
<h1 id="adminsetup">admin/setup<a class="headerlink" href="#adminsetup" title="Permanent link"></a></h1>
<p>First, someone with shell access to the server must add 'lock' to the ENABLE
list in the rc file.</p>
<p>Next, the gitolite.conf file should have something like this:</p>
<pre style="color: #ffffff; background-color: #000000;">
<span class="Type">repo </span>foo
    ...other rules...
<span class="Statement">    -</span><span class="Constant">   VREF/lock      </span>=<span class="WarningMsg">   @all</span>
</pre>

<p>However, see below for the difference between "RW" and "RW+" from the point of
view of this feature and adjust permissions accordingly.</p>
<h1 id="user-view">user view<a class="headerlink" href="#user-view" title="Permanent link"></a></h1>
<p>Here's a summary:</p>
<ul>
<li>Any user with "W" permissions to any branch in the repo can "lock" any
    file.  Once locked, no other user can push changes to that file, <em>in any
    branch</em>, until it is unlocked.</li>
<li>Any user with "+" permissions to any branch in the repo can "break" a lock
    held by someone else if needed.</li>
</ul>
<p>For best results, everyone on the team should:</p>
<ul>
<li>Switch to the branch containing the binary files when wanting to make a
    change.</li>
<li>Run 'git pull' or eqvt, then lock the binary file(s) before editing them.</li>
<li>Finish the editing task as quickly as possible, then commit, push, and
    unlock the file(s) so others are not needlessly blocked.</li>
<li>Understand that breaking a lock require additional, (out of band)
    communication.  It is upto the team's policies what that entails.</li>
</ul>
<h1 id="detailed-example">detailed example<a class="headerlink" href="#detailed-example" title="Permanent link"></a></h1>
<p>Alice declares her intent to work on "d1.odt":</p>
<pre><code>$ git pull
$ ssh git@host lock -l foo doc/d1.odt
</code></pre>
<p>Similarly Bob starts on "d2.odt"</p>
<pre><code>$ git pull
$ ssh git@host lock -l foo doc/d2.odt
</code></pre>
<p>Carol makes some changes to d2.odt (<strong>without attempting to lock the file or
checking to see if it is already locked</strong>) and pushes:</p>
<pre><code>$ ooffice doc/d2.odt
$ git add doc/d2.odt
$ git commit -m 'added footnotes to d2 in klingon'
$ git push
&lt;...normal push progress output...&gt;
remote: FATAL: W VREF/lock testing carol DENIED by VREF/lock
remote: 'doc/d2.odt' locked by 'bob'
remote: error: hook declined to update refs/heads/master
To u2:testing
 ! [remote rejected] master -&gt; master (hook declined)
error: failed to push some refs to 'carol:foo'
</code></pre>
<p>Carol backs out her changes, but saves them away for a "manual merge" later.</p>
<pre><code>git reset HEAD^
git stash save 'klingon changes to d2.odt saved for possible manual merge later'
</code></pre>
<p>Note that this still represents wasted work in some sense, because Carol would
have to somehow re-apply the same changes to the new version of d2.odt after
pulling it down.  <strong>This is because she did not lock the file before making
changes on her local repo.  Educating users in doing this is important if this
scheme is to help you.</strong></p>
<p>She now decides to work on "d1.odt".  However, she has learned her lesson and
decides to follow the protocol described above:</p>
<pre><code>$ git pull
$ ssh git@host lock -l foo doc/d1.odt
FATAL: 'doc/d1.odt' locked by 'alice' since Sun May 27 17:59:59 2012
</code></pre>
<p>Oh damn; can't work on that either.</p>
<p>Carol now decides to see what else there may be.  Instead of checking each
file to see if she can lock it, she starts with a list of what is already
locked:</p>
<pre><code>$ ssh git@host lock -ls foo

# locks held:

alice   doc/d1.odt      (Sun May 27 17:59:59 2012)
bob     doc/d2.odt      (Sun May 27 18:00:06 2012)

# locks broken:
</code></pre>
<p>Aha, looks like only d1 and d2 are locked.  She picks d3.odt to work on.  This
time, she starts by locking it:</p>
<pre><code>$ ssh git@host lock -l foo doc/d3.odt
$ ooffice doc/d3.odt
&lt;...etc...&gt;
</code></pre>
<p>Meanwhile, in a parallel universe where d3.odt doesn't exist, and Alice has
gone on vacation while keeping d1.odt locked, Carol breaks the lock.  Carol
can do this because she has RW+ permissions for the repository itself.</p>
<p>However, protocol in this team requires that she get email approval from the
team lead before doing this and that Alice be in CC in those emails, so she
does that first, and <em>then</em> she breaks the lock:</p>
<pre><code>$ git pull
$ ssh git@host lock --break foo doc/d1.odt
</code></pre>
<p>She then locks d1.odt for herself:</p>
<pre><code>$ ssh git@host lock -l foo doc/d1.odt
</code></pre>
<p>When Alice comes back, she can tell who broke her lock and when:</p>
<pre><code>$ ssh git@host lock -ls foo

# locks held:

carol   doc/d1.odt      (Sun May 27 18:17:29 2012)
bob     doc/d2.odt      (Sun May 27 18:00:06 2012)

# locks broken:

carol   doc/d1.odt      (Sun May 27 18:17:03 2012)      (locked by alice at Sun May 27 17:59:59 2012)
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
