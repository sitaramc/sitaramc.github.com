<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>the "conf" file (part 2) - Gitolite</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="css/gitolite.css" rel="stylesheet">

        <script src="js/jquery-1.10.2.min.js" defer></script>
        <script src="js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="index.html">Gitolite</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="index.html" class="nav-link">home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">what/why <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="overview.html" class="dropdown-item">overview</a>
</li>
                                    
<li>
    <a href="concepts.html" class="dropdown-item">concepts, conventions, terminology</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">install and setup <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="quick_install.html" class="dropdown-item">(unix/ssh experts) quick install and setup</a>
</li>
                                    
<li>
    <a href="install.html" class="dropdown-item">normal ssh mode install and setup</a>
</li>
                                    
<li>
    <a href="fool_proof_setup.html" class="dropdown-item">(if all else fails) fool-proof, step-by-step, install and setup</a>
</li>
                                    
<li>
    <a href="http.html" class="dropdown-item">HTTP mode install</a>
</li>
                                    
<li>
    <a href="migr.html" class="dropdown-item">migrating from v2</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">use <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">basic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="basic-admin.html" class="dropdown-item">basic administration</a>
</li>
            
<li>
    <a href="conf.html" class="dropdown-item">the "conf" file (part 1)</a>
</li>
            
<li>
    <a href="conf-2.html" class="dropdown-item active">the "conf" file (part 2)</a>
</li>
            
<li>
    <a href="rc.html" class="dropdown-item">the "rc" file</a>
</li>
            
<li>
    <a href="user.html" class="dropdown-item">your users' view</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">advanced</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="git-config.html" class="dropdown-item">setting git-config values</a>
</li>
            
<li>
    <a href="options.html" class="dropdown-item">gitolite options</a>
</li>
            
<li>
    <a href="wild.html" class="dropdown-item">ad hoc user-created ("wild") repos</a>
</li>
            
<li>
    <a href="templates.html" class="dropdown-item">using templates</a>
</li>
            
<li>
    <a href="vref.html" class="dropdown-item">virtual refs (part 1)</a>
</li>
            
<li>
    <a href="vref-2.html" class="dropdown-item">virtual refs (part 2)</a>
</li>
            
<li>
    <a href="deleg.html" class="dropdown-item">delegation of admin duties</a>
</li>
            
<li>
    <a href="gitweb-daemon.html" class="dropdown-item">gitweb and git-daemon</a>
</li>
            
<li>
    <a href="mirroring.html" class="dropdown-item">mirroring</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">customise</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="non-core.html" class="dropdown-item">core and "non-core" gitolite</a>
</li>
            
<li>
    <a href="dev-notes.html" class="dropdown-item">writing your own non-core code</a>
</li>
            
<li>
    <a href="triggers.html" class="dropdown-item">gitolite triggers</a>
</li>
            
<li>
    <a href="list-non-core.html" class="dropdown-item">list of non-core programs shipped with gitolite</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="cookbook.html" class="dropdown-item">(quick! how do I...) the cookbook</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">HELP! <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="emergencies.html" class="dropdown-item">emergency!!</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">ssh</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="ssh.html" class="dropdown-item">ssh</a>
</li>
            
<li>
    <a href="glssh.html" class="dropdown-item">how gitolite uses ssh</a>
</li>
            
<li>
    <a href="sts.html" class="dropdown-item">ssh troubleshooting</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="regex.html" class="dropdown-item">regular expressions</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">other docs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="odds-and-ends.html" class="dropdown-item">miscellaneous features</a>
</li>
                                    
<li>
    <a href="namespaces.html" class="dropdown-item">using git namespaces</a>
</li>
                                    
<li>
    <a href="locking.html" class="dropdown-item">locking binary files</a>
</li>
                                    
<li>
    <a href="testing.html" class="dropdown-item">testing gitolite</a>
</li>
                                    
<li>
    <a href="package.html" class="dropdown-item">packaging gitolite</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">more about gitolite</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="files.html" class="dropdown-item">gitolite files & directories</a>
</li>
            
<li>
    <a href="rc-33.html" class="dropdown-item">the 3.3 format rc file</a>
</li>
            
<li>
    <a href="perf.html" class="dropdown-item">performance</a>
</li>
            
<li>
    <a href="internals.html" class="dropdown-item">internals</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">contrib</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="contrib/ssh-and-http.html" class="dropdown-item">Using both ssh and http</a>
</li>
            
<li>
    <a href="contrib/putty.html" class="dropdown-item">Putty and Msysgit</a>
</li>
            
<li>
    <a href="contrib/sskm.html" class="dropdown-item">Self-service key management</a>
</li>
            
<li>
    <a href="contrib/ukm.html" class="dropdown-item">User key management</a>
</li>
            
<li>
    <a href="contrib/README-emacs.html" class="dropdown-item">Emacs major mode</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="no-way.html" class="dropdown-item">no way!</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="conf.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="rc.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#the-conf-file-confgitoliteconf" class="nav-link">the "conf" file (conf/gitolite.conf)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#access-control-rule-matching" class="nav-link">access control rule matching</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#an-example" class="nav-link">an example</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#tracing-the-access-control-decision" class="nav-link">tracing the access control decision</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#read-access-respecting-deny-rules" class="nav-link">read access respecting deny rules</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#example-1" class="nav-link">example 1</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#example-2" class="nav-link">example 2</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#appendix-1-different-types-of-write-operations" class="nav-link">appendix 1: different types of write operations</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#summary-of-permissions" class="nav-link">summary of permissions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#appendix-2-gitolite-access-check-flow" class="nav-link">appendix 2: gitolite access check flow</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#putting-it-all-together" class="nav-link">putting it all together</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#appendix-3-embedding-test-code-in-your-conf" class="nav-link">appendix 3: embedding test code in your conf</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="the-conf-file-confgitoliteconf">the "conf" file (<code>conf/gitolite.conf</code>)<a class="headerlink" href="#the-conf-file-confgitoliteconf" title="Permanent link"></a></h1>
<p><center>(part 2)</center></p>
<hr />
<h1 id="access-control-rule-matching">access control rule matching<a class="headerlink" href="#access-control-rule-matching" title="Permanent link"></a></h1>
<p>Access control rule matching is pretty simple.  From the previous section,
you know what "permission", "refex", "user", and "repo" are.  Here's how the
rules are used to decide whether to allow or deny a request.</p>
<p>Access is checked once only for "read" operations, but twice for "write"s.</p>
<p>(Note that the <code>deny-rules</code> option, mentioned below, is explained in more
detail in a later section.)</p>
<p><strong>Check #1</strong>: the first check happens as soon as gitolite-shell receives
control (from sshd or httpd).  gitolite-shell will pass control to
git-upload-pack or git-receive-pack only if this check succeeds.</p>
<ul>
<li>collect all the rules pertaining to this repo <em>and</em> this user</li>
<li>ignore all the refexes; they don't apply to the first access check</li>
<li><strong>if</strong> the <code>deny-rules</code> option is <strong>not</strong> in effect for this repo, discard
    all the <code>-</code> (deny) rules</li>
<li>look at the rules <em>in sequence</em>:<ul>
<li>if you find a <code>-</code>, access is denied</li>
<li>for a "read" operation (clone, fetch, ...), if you find a rule
    containing <code>R</code>, access is allowed</li>
<li>for a "write" operation (push), if you find a rule containing <code>W</code>,
    access is allowed</li>
<li>if there are no more rules left, access is denied</li>
</ul>
</li>
</ul>
<p><strong>Check #2</strong>: the second check only happens for "push" operations.  It is
invoked by <code>git-receive-pack</code> running the gitolite-installed <code>update</code> hook.
If access is denied, the update hook fails, and git then aborts the push for
this ref.  (See <code>man githooks</code> for more.)</p>
<p>In the following description, we use the word <code>operation</code> instead of <code>W</code>,
because the actual operation could be a plain, fast-forward, push (<code>W</code>) or a
rewind/delete (<code>+</code>).  <span class="gray">Other, less commonly used, values are "C", "D",
or "M"; see <a href="conf-2#appendix-1-different-types-of-write-operations">here</a>.</span></p>
<ul>
<li>collect all the rules pertaining to this repo <em>and</em> this user</li>
<li>discard all the rules where the refex does not match the ref (branch or
    tag) being pushed</li>
<li>look at the rules <em>in sequence</em>:<ul>
<li>if you find a <code>-</code>, access is denied</li>
<li>if you find a rule containing the operation you are performing, access
    is allowed</li>
<li>if there are no more rules left, access is denied</li>
</ul>
</li>
</ul>
<h2 id="an-example">an example<a class="headerlink" href="#an-example" title="Permanent link"></a></h2>
<p>Just to be clear, let's work out an example of what happens when dilbert tries
to push a branch called "xyz".</p>
<p>We'll pretend the rule list looks like this:</p>
<pre style="color: #ffffff; background-color: #000000;">
<span class="Comment"># managers should be able to read any repo</span>
<span class="Statement">repo</span> <span class="Identifier">@all</span>
    <span class="Statement">R</span>                       =   <span class="Identifier">@managers</span>

<span class="Comment"># ...other rules for other repos...</span>

<span class="Statement">repo</span> foo bar

    <span class="Statement">RW+</span>                     =   alice <span class="Identifier">@teamleads</span>
    <span class="Statement">-</span>   <span class="Constant">master</span>              =   <span class="WarningMsg">dilbert @devteam</span>
    <span class="Statement">-</span>   <span class="Constant">refs/tags/v[0-9]</span>    =   <span class="WarningMsg">dilbert @devteam</span>
    <span class="Statement">RW+</span> <span class="Constant">dev/</span>                =   dilbert <span class="Identifier">@devteam</span>
    <span class="Statement">RW</span>                      =   dilbert <span class="Identifier">@devteam</span>
    <span class="Statement">R</span>                       =   <span class="Identifier">@managers</span>
</pre>

<p>After adding a default refex and expanding the supplied ones (see the
<a href="conf#the-refex-field">refex</a> section earlier), this is what it looks like.  We've added line
numbers for convenience; we'll see why later.</p>
<pre style="color: #ffffff; background-color: #000000;">
<span id="L1" class="LineNr"> 1 </span><span class="Comment"># managers should be able to read any repo</span>
<span id="L2" class="LineNr"> 2 </span><span class="Statement">repo</span> <span class="Identifier">@all</span>
<span id="L3" class="LineNr"> 3 </span>    <span class="Statement">R</span>                       =   <span class="Identifier">@managers</span>
<span id="L4" class="LineNr"> 4 </span>
<span id="L5" class="LineNr"> 5 </span>    <span class="Comment"># ...other rules for other repos...</span>
<span id="L6" class="LineNr"> 6 </span>
<span id="L7" class="LineNr"> 7 </span><span class="Statement">repo</span> foo bar
<span id="L8" class="LineNr"> 8 </span>
<span id="L9" class="LineNr"> 9 </span>    <span class="Statement">RW+</span> <span class="Constant">refs/.*</span>             =   alice <span class="Identifier">@teamleads</span>
<span id="L10" class="LineNr">10 </span>    <span class="Statement">-</span>   <span class="Constant">refs/heads/master</span>   =   <span class="WarningMsg">dilbert @devteam</span>
<span id="L11" class="LineNr">11 </span>    <span class="Statement">-</span>   <span class="Constant">refs/tags/v[0-9]</span>    =   <span class="WarningMsg">dilbert @devteam</span>
<span id="L12" class="LineNr">12 </span>    <span class="Statement">RW+</span> <span class="Constant">refs/heads/dev/</span>     =   dilbert <span class="Identifier">@devteam</span>
<span id="L13" class="LineNr">13 </span>    <span class="Statement">RW</span>  <span class="Constant">refs/.*</span>             =   dilbert <span class="Identifier">@devteam</span>
<span id="L14" class="LineNr">14 </span>    <span class="Statement">R</span>                       =   <span class="Identifier">@managers</span>
</pre>

<p>This represents a set of rules that are basically this:</p>
<pre><code>repo    user        perm    ref                 (from line)

 foo     @managers  R                                3
 foo     alice      RW+      refs/.*                 9
 foo     @teamleads RW+      refs/.*                 9
 foo     dilbert    -        refs/heads/master       10
 foo     @devteam   -        refs/heads/master       10
 foo     dilbert    -        refs/tags/v[0-9]        11
 foo     @devteam   -        refs/tags/v[0-9]        11
 foo     dilbert    RW+      refs/heads/dev/         12
 foo     @devteam   RW+      refs/heads/dev/         12
 foo     dilbert    RW       refs/.*                 13
 foo     @devteam   RW       refs/.*                 13
 foo     @managers  R                                14
</code></pre>
<p>Which of these rules apply for dilbert?  We'll assume he's not a team lead, as
<em>that</em> would defeat the whole purpose of this example!  We <em>know</em> he's not a
manager, as that would defeat the whole purpose of the comic! Finally, we
assume he's also not part of "@devteam", (otherwise why would you name him
separately in all those lines?).</p>
<p>So we discard all those rules, which leaves us, for repo "foo" and user
"dilbert":</p>
<pre><code>perm    ref                 (from line)

-        refs/heads/master       10
-        refs/tags/v[0-9]        11
RW+      refs/heads/dev/         12
RW       refs/.*                 13
</code></pre>
<p>So what happens when dilbert tries to push a branch called "xyz"?</p>
<p>At check #1, the data gitolite has is that "oper" is "W" (and ref of course is
unknown).  We discard lines 10 and 11 (the <code>deny-rules</code> option is off by
default, so we ignore <code>-</code> rules).  Line 12 supplies a perm of "RW+", which
contains "W" (the "oper") so access is allowed.</p>
<p>At check #2, the data gitolite has is that "oper" is "W" and ref is
<code>refs/heads/xyz</code>.  We discard the first three rules, since the ref does not
match any of those refexes.  That leaves just line 13.</p>
<p>If the push were a fast-forward push, the "oper" would be "W", and since it is
contained in the perm for rule 13, access is allowed.</p>
<p>However, if he were to try a rewind-push, then the "oper" would be "+", which
is not contained in "RW", it wouldn't match, then control would go back for
the <em>next</em> rule, and since there aren't any more, access would be denied.</p>
<hr />
<h1 id="tracing-the-access-control-decision">tracing the access control decision<a class="headerlink" href="#tracing-the-access-control-decision" title="Permanent link"></a></h1>
<p><span class="gray">(v3.6.1)</span> Gitolite can help you trace this logic quickly and easily.
Here's one example run, with the above rules.  This one tests whether dilbert
can push to repo foo (check #1).  Note that the syntax for specifying an
unknown ref in this command is 'any'.</p>
<pre><code>$ gitolite access -s foo dilbert W any
legend:
    d =&gt; skipped deny rule due to ref unknown or 'any',
    r =&gt; skipped due to refex not matching,
    p =&gt; skipped due to perm (W, +, etc) not matching,
    D =&gt; explicitly denied,
    A =&gt; explicitly allowed,
    F =&gt; denied due to fallthru (no rules matched)

  d        gitolite.conf:10         -   refs/heads/master   =   dilbert @devteam
  d        gitolite.conf:11         -   refs/tags/v[0-9]    =   dilbert @devteam
  A        gitolite.conf:12         RW+ refs/heads/dev/     =   dilbert @devteam

refs/heads/dev/
</code></pre>
<p>Now see what happens when we try check #2 (we've omitted the legend in the
output, since it's always the same):</p>
<pre><code>$ gitolite access -s foo dilbert W xyz

  r        gitolite.conf:10         -   refs/heads/master   =   dilbert @devteam
  r        gitolite.conf:11         -   refs/tags/v[0-9]    =   dilbert @devteam
  r        gitolite.conf:12         RW+ refs/heads/dev/     =   dilbert @devteam
  A        gitolite.conf:13         RW  refs/.*             =   dilbert @devteam

refs/.*
</code></pre>
<p>And if you try a force push:</p>
<pre><code>$ gitolite access -s foo dilbert + refs/heads/xyz

  r        gitolite.conf:10         -   refs/heads/master   =   dilbert @devteam
  r        gitolite.conf:11         -   refs/tags/v[0-9]    =   dilbert @devteam
  r        gitolite.conf:12         RW+ refs/heads/dev/     =   dilbert @devteam
  p        gitolite.conf:13         RW  refs/.*             =   dilbert @devteam
  F           (fallthru)

+ refs/heads/xyz foo dilbert DENIED by fallthru
</code></pre>
<p>I hope that was useful!  Be sure you correlated the output of 'gitolite access
-s' with the rule workflow pictures and corresponding descriptions to cement
your understanding.</p>
<h1 id="read-access-respecting-deny-rules">read access respecting deny rules<a class="headerlink" href="#read-access-respecting-deny-rules" title="Permanent link"></a></h1>
<p>Normally, deny rules are ignored by access check #1 (the one that runs
<em>before</em> git-upload-pack or git-receive-pack is called by gitolite-shell);
they apply only to check #2 (the update hook check).</p>
<p>But sometimes you want this "pre-git" access check to respect deny rules;
i.e., use the flow of check #2, not check #1.  You tell gitolite to do this by
setting the "deny-rules" option for the repo; when you do that, the flow of
check #2 is used for both stages, before git <em>and</em> in the update hook.</p>
<h2 id="example-1">example 1<a class="headerlink" href="#example-1" title="Permanent link"></a></h2>
<p>Here's an example. Here, we have lots of repos, which should all be accessible
by gitweb or daemon, so we want the convenience provided by lines 6 and 7 (we
don't want to put line 7 in <em>each</em> repo).  However, we also have some secret
repos (maybe the gitolite-admin repo and some others that we will list), which
we want to prevent gitweb or daemon from seeing.</p>
<p>How do we do that?</p>
<p>The naive approach -- putting in a deny rule just for those repos -- doesn't
work.  In fact nothing else seems to work either; you'll have to replace the
<code>@all</code> with an exhaustive list of <em>all repos other than the secret repos</em>.</p>
<pre style="color: #ffffff; background-color: #000000;">
<span id="L1" class="LineNr">1 </span><span class="Identifier">@secret</span><span class="PreProc"> = gitolite-admin secret-repo/..*</span>
<span id="L2" class="LineNr">2 </span><span class="Statement">repo</span> <span class="Identifier">@secret</span>
<span id="L3" class="LineNr">3 </span>    <span class="Statement">-</span>   =   <span class="WarningMsg">gitweb daemon</span>
<span id="L4" class="LineNr">4 </span>
<span id="L5" class="LineNr">5 </span>
<span id="L6" class="LineNr">6 </span><span class="Statement">repo</span> <span class="Identifier">@all</span>
<span id="L7" class="LineNr">7 </span>    <span class="Statement">R</span>   =   gitweb daemon
<span id="L8" class="LineNr">8 </span>
<span id="L9" class="LineNr">9 </span><span class="Comment"># ...other repos and rules...</span>
</pre>

<p>That's... painful!</p>
<p>What you really want is for that repo to always use check #2, even when it
doesn't actually have a ref to test for.</p>
<pre style="color: #ffffff; background-color: #000000;">
<span id="L1" class="LineNr">1 </span><span class="Identifier">@secret</span><span class="PreProc"> = gitolite-admin secret-repo/..*</span>
<span id="L2" class="LineNr">2 </span><span class="Statement">repo</span> <span class="Identifier">@secret</span>
<span id="L3" class="LineNr">3 </span>    <span class="Statement">-</span>   =   <span class="WarningMsg">gitweb daemon</span>
<span id="L4" class="LineNr">4 </span>    <span class="Statement">option</span> <span class="Identifier">deny-rules</span> = <span class="Constant">1</span>
<span id="L5" class="LineNr">5 </span>
<span id="L6" class="LineNr">6 </span><span class="Statement">repo</span> <span class="Identifier">@all</span>
<span id="L7" class="LineNr">7 </span>    <span class="Statement">R</span>   =   gitweb daemon
<span id="L8" class="LineNr">8 </span>
<span id="L9" class="LineNr">9 </span><span class="Comment"># ...other repos and rules...</span>
</pre>

<p>This is done by adding <em>one</em> line, line 4 in this example.  This sets a
gitolite <a href="options">"option"</a> that says you want "deny rules" to be applicable
even for read access.</p>
<p>Once you do that, all you need to do is to ensure that the first rule
encountered by these two "users" for those repos is a deny rule, so that it
can take effect first.  In this example, the placement of lines 2, 3 vis-a-vis
lines 6, 7 matters -- don't switch them!</p>
<h2 id="example-2">example 2<a class="headerlink" href="#example-2" title="Permanent link"></a></h2>
<p>In this example the "open" repos are fewer in number, so it is the opposite
situation to the above in terms of our ability to enumerate all the repos.</p>
<pre style="color: #ffffff; background-color: #000000;">
<span class="Identifier">@open</span><span class="PreProc"> = git gitolite foss/..* [...]</span>

<span class="Statement">repo</span> <span class="Identifier">@all</span>
    <span class="Statement">-</span>   =   <span class="WarningMsg">gitweb daemon</span>
    <span class="Statement">option</span> <span class="Identifier">deny-rules</span> = <span class="Constant">1</span>

<span class="Statement">repo</span> <span class="Identifier">@open</span>
    <span class="Statement">R</span>   =   gitweb daemon
    <span class="Statement">option</span> <span class="Identifier">deny-rules</span> = <span class="Constant">0</span>
</pre>

<p>To see why this works, you need to understand that for <a href="options">options</a> and
<a href="git-config">config</a> lines, a later setting <a href="git-config#overriding-config-values">overrides</a> earlier
ones.  So we set it to 1 for all repos, then selectively set it to 0 for some.</p>
<p>This means the "deny-rules" option applies to <em>all the repos except the "open"
repos</em>, and so the first rule encountered by gitweb and daemon is a deny rule,
so they are denied read access.  The "open" repos, on the other hand, get the
normal default behaviour, which is to ignore deny rules for read access, and
thus they only see the "R" permission.</p>
<hr />
<h1 id="appendix-1-different-types-of-write-operations">appendix 1: different types of write operations<a class="headerlink" href="#appendix-1-different-types-of-write-operations" title="Permanent link"></a></h1>
<p>Git supplies enough information to the update hook to be able to distinguish
several types of writes.</p>
<p>The most common are:</p>
<ul>
<li><code>RW</code> -- create a ref or fast-forward push a ref.  No rewinds or deletes.</li>
<li><code>RW+</code> -- create, fast-forward push, rewind push, or delete a ref.</li>
</ul>
<p>Sometimes you want to allow people to push, but not <em>create</em> a ref.  Or
rewind, but not <em>delete</em> a ref.  The <code>C</code> and <code>D</code> qualifiers help here.</p>
<ul>
<li>
<p>If a rule specifies <code>RWC</code> or <code>RW+C</code>, then <em>rules that do NOT have the C
    qualifier will no longer permit </em><em>creating</em><em> a ref in that repo</em>.</p>
<p><font color="gray">Please do not confuse this with the standalone <code>C</code>
permission that allows someone to <a href="wild#user-creating-a-specific-repo">create</a> a <strong>repo</strong></font></p>
</li>
<li>
<p>If a rule specifies <code>RWD</code> or <code>RW+D</code>, then <em>rules that do NOT have the D
    qualifier will no longer permit </em><em>deleting</em><em> a ref in that repo</em>.</p>
</li>
</ul>
<p>Note: These two can be combined, so you can have <code>RWCD</code> and <code>RW+CD</code> as well.</p>
<p>One very rare need is to reject merge commits (a commit series that is not a
straight line of commits).  The <code>M</code> qualifier helps here:</p>
<ul>
<li>When a rule has <code>M</code> appended to the permissions, <em>rules that do NOT have
    it will reject a commit sequence that contains a merge commit</em> (i.e., they
    only accept a straight line series of commits).</li>
</ul>
<h2 id="summary-of-permissions">summary of permissions<a class="headerlink" href="#summary-of-permissions" title="Permanent link"></a></h2>
<p>The full set of permissions, in regex syntax, is <code>-|R|RW+?C?D?M?</code>.  This
expands to one of <code>-</code>, <code>R</code>, <code>RW</code>, <code>RW+</code>, <code>RWC</code>, <code>RW+C</code>, <code>RWD</code>, <code>RW+D</code>, <code>RWCD</code>,
or <code>RW+CD</code>, all but the first two optionally followed by an <code>M</code>.</p>
<hr />
<h1 id="appendix-2-gitolite-access-check-flow">appendix 2: gitolite access check flow<a class="headerlink" href="#appendix-2-gitolite-access-check-flow" title="Permanent link"></a></h1>
<p>Here's lots more detail on the access check process, with flow diagrams.</p>
<p>When do the access checks happen and what are the four pieces of data (repo,
user, operation, ref) in each case?</p>
<table>
<thead>
<tr>
<th>read</th>
<th>write</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="a1.png" /></td>
<td><img alt="" src="a2.png" /></td>
</tr>
</tbody>
</table>
<p>In these pictures the access checks are marked in yellow.</p>
<p>The picture on the left is for a read (git clone, fetch, ls-remote).  There is
only one access check for a read operation.  If access is denied, the
operation aborts.  Otherwise, gitolite-shell invokes git-upload-pack.</p>
<p>Notice the information available to the access check.  The "oper" (operation)
is "R", indicating a read operation.  The "ref" is listed as "unknown",
although we could also call it "irrelevant"!</p>
<p><strong>Access check #1</strong> proceeds with those 4 bits of information, and either
passes or fails.  If it passes, gitolite passes control to "git-upload-pack"
and its job is done.</p>
<hr />
<p>The flow for a push operation (the picture on the right) is <em>very</em> similar
upto the first access check. The "oper" is "W" now, although the "ref" is
still unknown. <span class="gray">Even though this <em>is</em> a push, at this stage in the
protocol nothing on the server knows what branch or tag or combination of them
are coming down the wire, since we haven't executed git-receive-pack
yet!</span></p>
<p>If it succeeds, gitolite passes control to "git-receive-pack", but its job is
not done yet.  <em>Git</em> will eventually invoke the update hook (see 'man
githooks'). Gitolite has already grabbed this hook, which receives from git
the ref name being pushed, as well as enough information to compute whether
this push is a "fast-forward push" or a "rewind push".  Based on this,
gitolite sets the "oper" field to "W" or "+", respectively.</p>
<p><strong>Access check #2</strong> proceeds with this information.  The result is sent back
to git-receive-pack (in the form of an exit code; again, see 'man githooks'),
and the push fails or succeeds based on that.</p>
<h2 id="putting-it-all-together">putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permanent link"></a></h2>
<p>At this point, we have the following pieces of information:</p>
<ul>
<li>
<p>A set of rules, each containing 4 pieces of data: repo, user, perm, refex.
    They are in the sequence they were found in the conf file.</p>
<p>We discard all rules that do not apply to this repo and this user, which
means our set of rules have only two fields: perm, refex.</p>
<p>As a quick reminder, perm is one of R, RW, RW+, or <code>-</code>.</p>
</li>
<li>
<p>Four elements that make up the access being attempted: repo, user, oper,
    ref.</p>
<p>Again, as a reminder, the "oper" is <strong>one letter</strong>.  For "check #1" it is
either R or W, and for check #2 it can be W or +.</p>
</li>
</ul>
<p><span class="gray">Note on permissions and "oper": there are other <a href="conf-2#appendix-1-different-types-of-write-operations">types of
permissions</a>, but for our discussion these are enough.  The
others are rare, and anyway it is easy to extrapolate to them.</span></p>
<p>With that background, here's the flow.  The one on the left is for check #1
(ref is unknown) while the one on the right is for check #2 (ref is known).</p>
<table>
<thead>
<tr>
<th>ref unknown</th>
<th>ref known</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="a3.png" /></td>
<td><img alt="" src="a4.png" /></td>
</tr>
</tbody>
</table>
<p>As you can see, deny rules are ignored by check #1 -- they're not tested in
any way.  For check #2, if there is a deny rule whose refex matched the ref,
access is denied (as you'd expect).</p>
<h1 id="appendix-3-embedding-test-code-in-your-conf">appendix 3: embedding test code in your conf<a class="headerlink" href="#appendix-3-embedding-test-code-in-your-conf" title="Permanent link"></a></h1>
<p>As of v3.6.7, it is possible to embed test code within gitolite.conf.  This
can be useful if your conf file is complicated, and you need a way to make
sure that any changes are not messing with your most important restrictions.</p>
<p>Full details, including preparation and caveats, are in
<code>contrib/utils/testconf</code>, but here's a teaser example:</p>
<pre><code>repo foo
    RW+     =   u1
    RW      =   u2

=begin testconf
gitolite access -q foo u1 + any || echo FAILED
gitolite access -q foo u2 + any &amp;&amp; echo FAILED
gitolite access -q foo u2 W any || echo FAILED
=end
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js" defer></script>
        <script src="search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
