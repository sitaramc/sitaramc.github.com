<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>how gitolite uses ssh</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style>
      body        { background: #fff; text-color: #000; margin-left:  40px;   font-size:  0.9em;  font-family: arial; }
  
      code        { font-size:    1.1em;  background:  #ddf; text-color: #000; }
      pre         { margin-left:  2em;    background:  #ddf; text-color: #000; }
      pre code    { font-size:    1.1em;  background:  #ddf; text-color: #000; }
  
      td          { vertical-align: top }
  
      .red        { color: red }
      .blue       { color: blue }
      .green      { color: green }
      .gray       { color: gray }
      .pink       { color: pink }
  
      .box        { background-color:#e0e0e0 }
      .bg-red     { background-color:#ffe0e0 }
      .bg-green   { background-color:#e0ffe0 }
      .bg-blue    { background-color:#e0e0ff }
  
      /* couldn't resist the name! */
      .wd40       { width: 40% !important }
  
      .box-l      { float: left;  padding: 0px 0.5em; background-color: #e0e0e0; width:25%; margin-right: 4px; }
      .box-r      { float: right; padding: 0px 0.5em; background-color: #e0e0e0; width:25%; margin-left:  4px; }
  
      .fl-l       { float: left;  padding: 0px 0.5em;                                       margin-right: 4px; }
      .fl-r       { float: right; padding: 0px 0.5em;                                       margin-left:  4px; }
  
      .sidebar {
          margin-left: 4px;
          width: 25%;
          float: right;
          border: 4px solid #fff;
      }
  
  </style>
  <style>
      h1          { background: #ffb; text-color: #000; margin-left: -30px;   border-top:    5px  solid #ccc; }
      h2          { background: #ffb; text-color: #000; margin-left: -20px;   border-top:    3px  solid #ddd; }
      h3          { background: #ffb; text-color: #000; margin-left: -10px; }
      h4          { background: #ffb; text-color: #000; }
  </style>
</head>
<body>
<!--
    generated by gvim then munged a fair bit.  The following command
        vim -E -c "TOhtml" -c "w" -c 'qa!' \-\- conf/gitolite.conf
    may or may not produce the same thing
-->

<style type="text/css">
<!--
.WarningMsg { color: #ff0000; }
.Constant { color: #ffa0a0; }
.Statement { color: #ffff60; font-weight: bold; }
.PreProc { color: #ff80ff; }
.LineNr { color: #ffff00; }
.Comment { color: #80a0ff; }
.Type { color: #60ff60; font-weight: bold; }
.Special { color: #ffa500; }
.Identifier { color: #40ffff; }
.Error { color: #ffffff; background-color: #ff0000; padding-bottom: 1px; }
.Todo { color: #0000ff; background-color: #ffff00; padding-bottom: 1px; }
-->
</style>
<div id="header">
<h1 class="title">how gitolite uses ssh</h1>
</div>
<div id="TOC">
<ul>
<li><a href="#ssh-basics"><span class="toc-section-number">1</span> ssh basics</a></li>
<li><a href="#how-does-gitolite-use-all-this-ssh-magic"><span class="toc-section-number">2</span> how does gitolite use all this ssh magic?</a><ul>
<li><a href="#restricting-shell-accessdistinguishing-one-user-from-another"><span class="toc-section-number">2.1</span> restricting shell access/distinguishing one user from another</a></li>
<li><a href="#restricting-branch-level-actions"><span class="toc-section-number">2.2</span> restricting branch level actions</a></li>
</ul></li>
</ul>
</div>
<script type="text/javascript">
<!--
    function hide_show(id) {
        var e = document.getElementById(id);
        if(e == null)
            return;
        if(e.style.display != 'none')
            e.style.display = 'none';
        else
            e.style.display = 'block';
    }

    window.onload = function() {
        var t = document.getElementById('TOC');
        var sbt = document.getElementById('SBTOC');
        var h = '<div id="PTOC">'
        var h2 = '<p><strong><span class="red">Page TOC</span></strong></p>'
        var h3 = '</div>'
        var h4 = '<div id="GTOC">'
        var h5 = '</div>'
        var hst = '<div style="background: white; color: green; border: 2px solid green"><center><font size=-1><strong>Hide/Show Table of Contents</strong><br />'
        var pd = '<a href="#" onclick="hide_show(\'PTOC\');">Page TOC</a> | '
        var gt = '<a href="#" onclick="hide_show(\'GTOC\');">Gitolite TOC</a></font></center></div>'

        if(t == null)
            sbt.innerHTML = hst + gt + h4 + sbt.innerHTML + h5;
        else {
            sbt.innerHTML = hst + pd + gt + h + h2 + t.innerHTML + h3 + h4 + sbt.innerHTML + h5;
            t.style.display = 'none';   // hide the TOC that pandoc placed
        }
    }
-->
</script>

<style>
    #PTOC ul {
        list-style: none;
        margin-left: 0;
        padding-left: 2em;
        text-indent: -2em;
        padding-bottom: 2em;
    }
    #PTOC ul li {
        padding-bottom: 10px;
    }
    #PTOC ul li ul {
        padding-bottom: 0px;
    }
    #PTOC ul li ul li {
        padding-bottom: 0px;
    }

    .sidebar-toc a:hover {
        background-color: white;
    }

    .sidebar-toc {
        margin-left: 4px;
        width: 25%;
        float: right;
        color: gray;
        background: lightgray;
        border: 4px solid #fff;
        font-size: 0.90em;
    }

    .sidebar-toc ul {
        padding-left: 2em;
    }

</style>

<div id="SBTOC" class="sidebar-toc">

<p><strong><span class="red">Gitolite TOC</span></strong></p>
<hr />
<center>
<span class="red"><strong>Background</strong></span>
</center>

<hr />
<p><a href="index.html">Main page</a></p>
<ul>
<li><a href="index.html#dl">download</a></li>
<li><a href="index.html#rtfm">documentation</a>
<ul>
<li><a href="gitolite.html"><strong>all-in-one</strong></a> page</li>
</ul></li>
<li><a href="index.html#trouble"><strong>troubleshooting</strong></a></li>
<li><a href="index.html#contact"><strong>contact and support</strong></a></li>
<li><a href="index.html#license">license</a></li>
</ul>
<p><a href="overview.html">Overview</a></p>
<ul>
<li>what is Gitolite?</li>
<li>why might you need it?</li>
<li>how does it work?</li>
<li>who uses it?</li>
</ul>
<p><a href="concepts.html">Concepts and terminology</a></p>
<ul>
<li>authentication and authorisation</li>
<li>the &quot;hosting user&quot;</li>
<li>ssh mode and http mode</li>
<li>the special gitolite-admin repo</li>
</ul>
<p><a href="req.html">Before you start...</a></p>
<ul>
<li>your skills</li>
<li>your server</li>
<li>your and your users' clients</li>
<li><strong>cautions and caveats</strong></li>
<li><a href="req.html#trying">trying</a> out gitolite safely</li>
</ul>
<hr />
<center>
<span class="red"><strong>Basics</strong></span>
</center>

<hr />
<p><a href="install.html">install and setup</a></p>
<ul>
<li><a href="install.html#qi">quick install+setup</a> (for experts)</li>
<li>the long way around</li>
<li><a href="install.html#upgrading">upgrading</a></li>
<li><a href="install.html#moving">moving servers</a></li>
</ul>
<p><a href="basic-admin.html">Basic Administration</a></p>
<ul>
<li>clone the gitolite-admin repo</li>
<li>add/remove users</li>
<li>add/remove/rename repos</li>
<li>bringing existing repos into gitolite</li>
</ul>
<p><a href="conf.html">The conf file (<code>conf/gitolite.conf</code>)</a></p>
<ul>
<li>basic <a href="conf.html#syntax">syntax</a></li>
<li><a href="conf.html#include">include</a> files</li>
<li><a href="conf.html#groups">group definitions</a></li>
<li><a href="conf.html#rules"><strong><span class="red">access rules</span></strong></a></li>
</ul>
<p><a href="rc.html">the rc file (<code>~/.gitolite.rc</code>)</a></p>
<p><a href="user.html">Your users' view</a> of gitolite</p>
<p>Troubleshooting</p>
<ul>
<li>help for <a href="emergencies.html">emergencies</a></li>
<li>the <a href="ips.html">fool-proof install guide</a></li>
<li>the gitolite &quot;<a href="cookbook.html">cookbook</a>&quot;</li>
</ul>
<hr />
<center>
<span class="red"><strong>Advanced</strong></span>
</center>

<hr />
<p>Advanced &quot;conf file&quot; use</p>
<ul>
<li>specifying <a href="git-config.html">git-config</a> keys and values</li>
<li>gitolite <a href="options.html">options</a></li>
<li><a href="wild.html"><strong>wild repos</strong></a> (user created repos)</li>
<li><a href="vref.html">virtual refs</a></li>
<li><a href="deleg.html">delegation</a> of admin duties</li>
<li><a href="gitweb-daemon.html">gitweb and git-daemon</a></li>
</ul>
<p>Special features/setups</p>
<ul>
<li><strong><a href="mirroring.html">mirroring</a></strong></li>
<li><a href="http.html">http</a> mode</li>
<li>using a <a href="cache.html">cache</a></li>
<li>(<a href="namespaces.html">namespaces</a>)</li>
<li><a href="locking.html">locking</a> binary files</li>
<li><a href="package.html">packaging</a> gitolite</li>
</ul>
<p>Customising gitolite</p>
<ul>
<li>core and <a href="non-core.html">non-core</a> gitolite</li>
<li><a href="dev-notes.html">writing your own</a> non-core programs</li>
<li>gitolite <a href="triggers.html">triggers</a></li>
<li><a href="list-non-core.html">list of non-core programs</a> shipped with gitolite</li>
</ul>
<hr />
<center>
<span class="red"><strong>Extras</strong></span>
</center>

<hr />
<p><a href="odds-and-ends.html">Odds and Ends</a></p>
<ul>
<li><a href="odds-and-ends.html#writable">disabling pushes</a> to take backups</li>
<li><a href="odds-and-ends.html#elsewhere">putting 'repositories' and '.gitolite' elsewhere</a></li>
<li><a href="odds-and-ends.html#keysonly">using pubkeys obtained from elsewhere</a></li>
<li><a href="odds-and-ends.html#gh">giving users their own repos</a></li>
<li><a href="odds-and-ends.html#server-side-admin">administering gitolite directly on the server</a></li>
</ul>
<p>Additional information/discussion</p>
<ul>
<li><a href="ssh.html">all about ssh and gitolite</a></li>
<li>Running the <a href="testing.html">test suite</a></li>
<li><a href="files.html">gitolite files and directories</a></li>
<li><a href="perf.html">gitolite performance</a></li>
<li><a href="migr.html">Migration</a></li>
<li><a href="http://sitaramc.github.com/gitolite/g2/master-toc.html">documentation for gitolite v2</a></li>
<li><a href="regex.html">regular expressions</a></li>
<li><a href="no-way.html">no way!</a></li>
</ul>
<hr />
<center>
<span class="red"><strong>Contributed docs</strong></span>
</center>

<hr />
<p>Contributed software, tools, and documentation</p>
<ul>
<li><a href="ssh-and-http.html">combining ssh and http mode</a></li>
<li><a href="putty.html">putty and msysgit</a></li>
<li><a href="sskm.html">changing keys -- self service key management</a></li>
<li><a href="ukm.html">user key management</a></li>
<li><a href="README-emacs.html">emacs</a> &quot;major mode&quot;</li>
</ul>
</div>

<p>Although other forms of authentications exist (see the page on <a href="concepts.html#auth">authentication versus authorisation</a>), ssh is the one that most git users use.</p>
<p><strong><em>Therefore, gitolite is (usually) heavily dependent on ssh</em></strong>.</p>
<p>Most people didn't realise this, and even if they did they don't know ssh well enough to help themselves. If you don't understand how ssh public key authentication works, or how the <code>~/.ssh/authorized_keys</code> file can be used to restrict users, etc., you will have endless amounts of trouble getting gitolite to work, because you'll be attacking the wrong problem.</p>
<p>So please please please understand this before tearing your hair out and blaming <strong><em>git/gitolite</em></strong> for whatever is going wrong with your setup :-)</p>
<h1 id="ssh-basics"><span class="header-section-number">1</span> ssh basics</h1>
<p>Let's start with some basics, focusing <em>only</em> on the pieces relevant to <code>gitolite</code>. If this is not detailed enough, please use google and learn more from somewhere, or maybe buy the OReilly ssh book.</p>
<ul>
<li><p>You can login to an ssh server by typing a password, but ssh can also use <strong><em>public-private keys</em></strong> (also called &quot;key pairs&quot;) for authentication. <code>gitolite</code> <em>requires</em> you to use this mechanism for your users -- they cannot log in using passwords. Hopefully by the time you finish reading this page you will understand why :-)</p>
<p>The way you set this up is you generate a key pair on your workstation, and give the server the public key. (I need not add that the &quot;private&quot; key must be, well, kept <em>private</em>!)</p></li>
<li><p><strong>Generating a key pair on your workstation</strong> is done by running the command <code>ssh-keygen -t rsa</code>. This produces two files in <code>~/.ssh</code>. One is <code>id_rsa</code>; this is the <strong>private</strong> key -- <strong><em>never</em></strong> let it out of your machine. The other is <code>id_rsa.pub</code>, which is the corresponding public key. This public key is usually just one long line of text.</p>
<ul>
<li>On Windows machines with msysgit installed, you should do this from within a &quot;git bash&quot; window. The command will report the full path where the files have been written; make a note of this, and use those files in any of the description that follows.</li>
</ul></li>
<li><p><strong>Adding your public key to the server</strong>'s <code>~/.ssh/authorized_keys</code> file is how ssh uses pubkeys to authenticate users. Let's say sita@work.station is trying to log in as git@serv.er. What you have to do is take the <code>~/.ssh/id_rsa.pub</code> file for user sita on work.station and append its contents (remember it's only one line) to <code>~/.ssh/authorized_keys</code> for user git on serv.er.</p>
<p>The <code>authorized_keys</code> file can have multiple public keys (from many different people) added to it so any of them can log in to git@serv.er.</p>
<p>In the normal case (not gitolite, but your normal everyday shell access), there's a command that does this, <code>ssh-copy-id</code>, which also fixes up permissions etc., as needed, since sshd is a little picky about allowing pubkey access if permissions on the server are loose. Or you can do it manually, as long as you know what you're doing and you're careful not to erase or overwrite the existing contents of <code>~/.ssh/authorized_keys</code> on the server!</p>
<p>But with gitolite, it does this for you; see <a href="basic-admin.html#users">adding and removing users</a> for more.</p>
<ul>
<li><strong>Troubleshooting pubkey authentication failures</strong>: if you are unable to get ssh access to the server after doing all this, you'll have to look in <code>/var/log/secure</code> or <code>/var/log/auth.log</code> or some such file on the server to see what specific error <code>sshd</code> is complaining about.</li>
</ul></li>
<li><p><strong>Restricting users to specific commands</strong> is very important for gitolite. If you read <code>man sshd</code> and look for <code>authorized_keys file format</code>, you'll see a lot of options you can add to the public key line, which restrict the incoming user in various ways. In particular, note the <code>command=</code> option, which means &quot;regardless of what the incoming user is asking to do, forcibly run this command instead&quot;.</p>
<p>Also note that when there are many public keys (i.e., lines) in the <code>authorized_keys</code> file, each line can have a <em>different</em> set of options and <code>command=</code> values.</p>
<p>Without this <code>command=</code> option, the ssh daemon will simply give you a shell, which is not what we want for our gitolite keys (although we may well have other keys which we use to get a shell).</p>
<p><strong>This is the backbone of what makes gitolite work; please make sure you understand this</strong>.</p></li>
</ul>
<h1 id="how-does-gitolite-use-all-this-ssh-magic"><span class="header-section-number">2</span> how does gitolite use all this ssh magic?</h1>
<p>These are two different questions you ought to be having by now:</p>
<ul>
<li>How does it distinguish between me and someone else, since we're all logging in as the same remote user &quot;git&quot;.</li>
<li>How does it restrict what I can do within a repository.</li>
</ul>
<h2 id="restricting-shell-accessdistinguishing-one-user-from-another"><span class="header-section-number">2.1</span> restricting shell access/distinguishing one user from another</h2>
<p>The answer to the first question is the <code>command=</code> we talked about before. If you look in the <code>authorized_keys</code> file, you'll see entries like this (I chopped off the ends of course; they're pretty long lines):</p>
<pre><code>command=&quot;[path]/gitolite-shell sitaram&quot;,[more options] ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA18S2t...
command=&quot;[path]/gitolite-shell usertwo&quot;,[more options] ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEArXtCT...</code></pre>
<p>First, it finds out which of the public keys in this file match the incoming login. That's crypto stuff, and I won't go into it. Once the match has been found, it will run the command given on that line; e.g., if I logged in, it would run <code>[path]/gitolite-shell sitaram</code>. So the first thing to note is that such users do not get &quot;shell access&quot;, which is good!</p>
<p>Before running the command, however, sshd sets up an environment variable called <code>SSH_ORIGINAL_COMMAND</code> which contains the actual git command that your workstation sent out. This is the command that <em>would have run</em> if you did not have the <code>command=</code> part in the authorised keys file.</p>
<p>When <code>gitolite-shell</code> gets control, it looks at the first argument (&quot;sitaram&quot;, &quot;usertwo&quot;, etc) to determine who you are. It then looks at the <code>SSH_ORIGINAL_COMMAND</code> variable to find out which repository you want to access, and whether you're reading or writing.</p>
<p>Now that it has a user, repository, and access requested (read/write), gitolite looks at its config file, and either allows or rejects the request.</p>
<p>But this cannot differentiate between different branches within a repo; that has to be done separately.</p>
<h2 id="restricting-branch-level-actions"><span class="header-section-number">2.2</span> restricting branch level actions</h2>
<p>[If you look inside the git source tree, there's a file among the &quot;howto&quot;s in there called <code>update-hook-example.txt</code>, which was the inspiration for this part of gitolite.]</p>
<p>Git allows you to specify many &quot;hooks&quot;, which get control as various events happen -- see <code>git help hooks</code> for details. One of those hooks is the <code>update</code> hook, which, if it is present, is invoked just before a branch or a tag is about to be updated. The hook is passed the name of the branch or tag, the old SHA1 value, and the new SHA1 value, as arguments. Hooks that are called <em>before</em> an action happens are allowed to prevent that action from happening by returning an error code.</p>
<p>When gitolite is told to create a new repository (by the admin), it installs a special update hook. This hook takes all the information presented, looks at the config file, and decides to allow or reject the update.</p>
<p>And that's basically it.</p>
</body>
</html>
